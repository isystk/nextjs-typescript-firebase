(window.webpackJsonp_N_E=window.webpackJsonp_N_E||[]).push([[5],{CCl1:function(t,e,n){"use strict";(function(t){n.d(e,"a",(function(){return uu})),n.d(e,"b",(function(){return ic})),n.d(e,"c",(function(){return $a})),n.d(e,"d",(function(){return Ra})),n.d(e,"e",(function(){return Pc})),n.d(e,"f",(function(){return sc})),n.d(e,"g",(function(){return T})),n.d(e,"h",(function(){return ac})),n.d(e,"i",(function(){return Uc})),n.d(e,"j",(function(){return qc})),n.d(e,"k",(function(){return V})),n.d(e,"l",(function(){return du})),n.d(e,"m",(function(){return ba})),n.d(e,"n",(function(){return it})),n.d(e,"o",(function(){return z})),n.d(e,"p",(function(){return Aa})),n.d(e,"q",(function(){return I})),n.d(e,"r",(function(){return Q})),n.d(e,"s",(function(){return p})),n.d(e,"t",(function(){return Sa})),n.d(e,"u",(function(){return Su})),n.d(e,"v",(function(){return Ou})),n.d(e,"w",(function(){return Ru})),n.d(e,"x",(function(){return Ja})),n.d(e,"y",(function(){return Ma})),n.d(e,"z",(function(){return Va})),n.d(e,"A",(function(){return La})),n.d(e,"B",(function(){return Tu})),n.d(e,"C",(function(){return Cu})),n.d(e,"D",(function(){return tc})),n.d(e,"E",(function(){return Pa})),n.d(e,"F",(function(){return Ha})),n.d(e,"G",(function(){return Wa})),n.d(e,"H",(function(){return Za})),n.d(e,"I",(function(){return su})),n.d(e,"J",(function(){return ru})),n.d(e,"K",(function(){return Ga})),n.d(e,"L",(function(){return Du})),n.d(e,"M",(function(){return mu})),n.d(e,"N",(function(){return pu})),n.d(e,"O",(function(){return yu})),n.d(e,"P",(function(){return wu})),n.d(e,"Q",(function(){return vu})),n.d(e,"R",(function(){return Iu})),n.d(e,"S",(function(){return Fu})),n.d(e,"T",(function(){return Jc})),n.d(e,"U",(function(){return Xc})),n.d(e,"V",(function(){return ec})),n.d(e,"W",(function(){return nc})),n.d(e,"X",(function(){return Nu})),n.d(e,"Y",(function(){return _u})),n.d(e,"Z",(function(){return Wc})),n.d(e,"ab",(function(){return zc})),n.d(e,"bb",(function(){return qa})),n.d(e,"cb",(function(){return Ua})),n.d(e,"db",(function(){return xu})),n.d(e,"eb",(function(){return Lu})),n.d(e,"fb",(function(){return bu})),n.d(e,"gb",(function(){return f})),n.d(e,"hb",(function(){return Kc})),n.d(e,"ib",(function(){return eu})),n.d(e,"jb",(function(){return tu})),n.d(e,"kb",(function(){return Eu})),n.d(e,"lb",(function(){return Xa})),n.d(e,"mb",(function(){return Qc}));var r=n("WJvL"),s=n("IuUc"),i=n("5pEQ"),o=n("H9WU"),a=n("j2t6");const c="@firebase/firestore";class u{constructor(t){this.uid=t}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(t){return t.uid===this.uid}}u.UNAUTHENTICATED=new u(null),u.GOOGLE_CREDENTIALS=new u("google-credentials-uid"),u.FIRST_PARTY=new u("first-party-uid"),u.MOCK_USER=new u("mock-user");let h="9.4.0";const l=new i.b("@firebase/firestore");function d(){return l.logLevel}function f(t){l.setLogLevel(t)}function m(t,...e){if(l.logLevel<=i.a.DEBUG){const n=e.map(y);l.debug(`Firestore (${h}): ${t}`,...n)}}function g(t,...e){if(l.logLevel<=i.a.ERROR){const n=e.map(y);l.error(`Firestore (${h}): ${t}`,...n)}}function p(t,...e){if(l.logLevel<=i.a.WARN){const n=e.map(y);l.warn(`Firestore (${h}): ${t}`,...n)}}function y(t){if("string"==typeof t)return t;try{return e=t,JSON.stringify(e)}catch(e){return t}var e}function w(t="Unexpected state"){const e=`FIRESTORE (${h}) INTERNAL ASSERTION FAILED: `+t;throw g(e),new Error(e)}function v(t,e){t||w()}function I(t,e){t||w()}function b(t,e){return t}const E={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class T extends Error{constructor(t,e){super(e),this.code=t,this.message=e,this.name="FirebaseError",this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class S{constructor(){this.promise=new Promise(((t,e)=>{this.resolve=t,this.reject=e}))}}class N{constructor(t,e){this.user=e,this.type="OAuth",this.authHeaders={},this.authHeaders.Authorization=`Bearer ${t}`}}class _{getToken(){return Promise.resolve(null)}invalidateToken(){}start(t,e){t.enqueueRetryable((()=>e(u.UNAUTHENTICATED)))}shutdown(){}}class D{constructor(t){this.token=t,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(t,e){this.changeListener=e,t.enqueueRetryable((()=>e(this.token.user)))}shutdown(){this.changeListener=null}}class A{constructor(t){this.t=t,this.currentUser=u.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(t,e){let n=this.i;const r=t=>this.i!==n?(n=this.i,e(t)):Promise.resolve();let s=new S;this.o=()=>{this.i++,this.currentUser=this.u(),s.resolve(),s=new S,t.enqueueRetryable((()=>r(this.currentUser)))};const i=()=>{const e=s;t.enqueueRetryable((async()=>{await e.promise,await r(this.currentUser)}))},o=t=>{m("FirebaseCredentialsProvider","Auth detected"),this.auth=t,this.auth.addAuthTokenListener(this.o),i()};this.t.onInit((t=>o(t))),setTimeout((()=>{if(!this.auth){const t=this.t.getImmediate({optional:!0});t?o(t):(m("FirebaseCredentialsProvider","Auth not yet detected"),s.resolve(),s=new S)}}),0),i()}getToken(){const t=this.i,e=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(e).then((e=>this.i!==t?(m("FirebaseCredentialsProvider","getToken aborted due to token change."),this.getToken()):e?(v("string"==typeof e.accessToken),new N(e.accessToken,this.currentUser)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){const t=this.auth&&this.auth.getUid();return v(null===t||"string"==typeof t),new u(t)}}class k{constructor(t,e,n){this.h=t,this.l=e,this.m=n,this.type="FirstParty",this.user=u.FIRST_PARTY}get authHeaders(){const t={"X-Goog-AuthUser":this.l},e=this.h.auth.getAuthHeaderValueForFirstParty([]);return e&&(t.Authorization=e),this.m&&(t["X-Goog-Iam-Authorization-Token"]=this.m),t}}class x{constructor(t,e,n){this.h=t,this.l=e,this.m=n}getToken(){return Promise.resolve(new k(this.h,this.l,this.m))}start(t,e){t.enqueueRetryable((()=>e(u.FIRST_PARTY)))}shutdown(){}invalidateToken(){}}class C{constructor(t,e){this.previousValue=t,e&&(e.sequenceNumberHandler=t=>this.g(t),this.p=t=>e.writeSequenceNumber(t))}g(t){return this.previousValue=Math.max(t,this.previousValue),this.previousValue}next(){const t=++this.previousValue;return this.p&&this.p(t),t}}function L(t){const e="undefined"!=typeof self&&(self.crypto||self.msCrypto),n=new Uint8Array(t);if(e&&"function"==typeof e.getRandomValues)e.getRandomValues(n);else for(let r=0;r<t;r++)n[r]=Math.floor(256*Math.random());return n}C.T=-1;class R{static I(){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",e=Math.floor(256/t.length)*t.length;let n="";for(;n.length<20;){const r=L(40);for(let s=0;s<r.length;++s)n.length<20&&r[s]<e&&(n+=t.charAt(r[s]%t.length))}return n}}function O(t,e){return t<e?-1:t>e?1:0}function F(t,e,n){return t.length===e.length&&t.every(((t,r)=>n(t,e[r])))}function M(t){return t+"\0"}class V{constructor(t,e){if(this.seconds=t,this.nanoseconds=e,e<0)throw new T(E.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(e>=1e9)throw new T(E.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(t<-62135596800)throw new T(E.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t);if(t>=253402300800)throw new T(E.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t)}static now(){return V.fromMillis(Date.now())}static fromDate(t){return V.fromMillis(t.getTime())}static fromMillis(t){const e=Math.floor(t/1e3),n=Math.floor(1e6*(t-1e3*e));return new V(e,n)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(t){return this.seconds===t.seconds?O(this.nanoseconds,t.nanoseconds):O(this.seconds,t.seconds)}isEqual(t){return t.seconds===this.seconds&&t.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){const t=this.seconds- -62135596800;return String(t).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class P{constructor(t){this.timestamp=t}static fromTimestamp(t){return new P(t)}static min(){return new P(new V(0,0))}compareTo(t){return this.timestamp._compareTo(t.timestamp)}isEqual(t){return this.timestamp.isEqual(t.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}function U(t){let e=0;for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&e++;return e}function q(t,e){for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&e(n,t[n])}function B(t){for(const e in t)if(Object.prototype.hasOwnProperty.call(t,e))return!1;return!0}class K{constructor(t,e,n){void 0===e?e=0:e>t.length&&w(),void 0===n?n=t.length-e:n>t.length-e&&w(),this.segments=t,this.offset=e,this.len=n}get length(){return this.len}isEqual(t){return 0===K.comparator(this,t)}child(t){const e=this.segments.slice(this.offset,this.limit());return t instanceof K?t.forEach((t=>{e.push(t)})):e.push(t),this.construct(e)}limit(){return this.offset+this.length}popFirst(t){return t=void 0===t?1:t,this.construct(this.segments,this.offset+t,this.length-t)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(t){return this.segments[this.offset+t]}isEmpty(){return 0===this.length}isPrefixOf(t){if(t.length<this.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}isImmediateParentOf(t){if(this.length+1!==t.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}forEach(t){for(let e=this.offset,n=this.limit();e<n;e++)t(this.segments[e])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(t,e){const n=Math.min(t.length,e.length);for(let r=0;r<n;r++){const n=t.get(r),s=e.get(r);if(n<s)return-1;if(n>s)return 1}return t.length<e.length?-1:t.length>e.length?1:0}}class j extends K{construct(t,e,n){return new j(t,e,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}static fromString(...t){const e=[];for(const n of t){if(n.indexOf("//")>=0)throw new T(E.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);e.push(...n.split("/").filter((t=>t.length>0)))}return new j(e)}static emptyPath(){return new j([])}}const $=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class z extends K{construct(t,e,n){return new z(t,e,n)}static isValidIdentifier(t){return $.test(t)}canonicalString(){return this.toArray().map((t=>(t=t.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),z.isValidIdentifier(t)||(t="`"+t+"`"),t))).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new z(["__name__"])}static fromServerFormat(t){const e=[];let n="",r=0;const s=()=>{if(0===n.length)throw new T(E.INVALID_ARGUMENT,`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);e.push(n),n=""};let i=!1;for(;r<t.length;){const e=t[r];if("\\"===e){if(r+1===t.length)throw new T(E.INVALID_ARGUMENT,"Path has trailing escape character: "+t);const e=t[r+1];if("\\"!==e&&"."!==e&&"`"!==e)throw new T(E.INVALID_ARGUMENT,"Path has invalid escape sequence: "+t);n+=e,r+=2}else"`"===e?(i=!i,r++):"."!==e||i?(n+=e,r++):(s(),r++)}if(s(),i)throw new T(E.INVALID_ARGUMENT,"Unterminated ` in path: "+t);return new z(e)}static emptyPath(){return new z([])}}class G{constructor(t){this.fields=t,t.sort(z.comparator)}covers(t){for(const e of this.fields)if(e.isPrefixOf(t))return!0;return!1}isEqual(t){return F(this.fields,t.fields,((t,e)=>t.isEqual(e)))}}function Q(){return"undefined"!=typeof atob}class H{constructor(t){this.binaryString=t}static fromBase64String(t){const e=atob(t);return new H(e)}static fromUint8Array(t){const e=function(t){let e="";for(let n=0;n<t.length;++n)e+=String.fromCharCode(t[n]);return e}(t);return new H(e)}toBase64(){return t=this.binaryString,btoa(t);var t}toUint8Array(){return function(t){const e=new Uint8Array(t.length);for(let n=0;n<t.length;n++)e[n]=t.charCodeAt(n);return e}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(t){return O(this.binaryString,t.binaryString)}isEqual(t){return this.binaryString===t.binaryString}}H.EMPTY_BYTE_STRING=new H("");const W=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function Y(t){if(v(!!t),"string"==typeof t){let e=0;const n=W.exec(t);if(v(!!n),n[1]){let t=n[1];t=(t+"000000000").substr(0,9),e=Number(t)}const r=new Date(t);return{seconds:Math.floor(r.getTime()/1e3),nanos:e}}return{seconds:J(t.seconds),nanos:J(t.nanos)}}function J(t){return"number"==typeof t?t:"string"==typeof t?Number(t):0}function X(t){return"string"==typeof t?H.fromBase64String(t):H.fromUint8Array(t)}function Z(t){var e,n;return"server_timestamp"===(null===(n=((null===(e=null==t?void 0:t.mapValue)||void 0===e?void 0:e.fields)||{}).__type__)||void 0===n?void 0:n.stringValue)}function tt(t){const e=t.mapValue.fields.__previous_value__;return Z(e)?tt(e):e}function et(t){const e=Y(t.mapValue.fields.__local_write_time__.timestampValue);return new V(e.seconds,e.nanos)}function nt(t){return null==t}function rt(t){return 0===t&&1/t==-1/0}function st(t){return"number"==typeof t&&Number.isInteger(t)&&!rt(t)&&t<=Number.MAX_SAFE_INTEGER&&t>=Number.MIN_SAFE_INTEGER}class it{constructor(t){this.path=t}static fromPath(t){return new it(j.fromString(t))}static fromName(t){return new it(j.fromString(t).popFirst(5))}hasCollectionId(t){return this.path.length>=2&&this.path.get(this.path.length-2)===t}isEqual(t){return null!==t&&0===j.comparator(this.path,t.path)}toString(){return this.path.toString()}static comparator(t,e){return j.comparator(t.path,e.path)}static isDocumentKey(t){return t.length%2==0}static fromSegments(t){return new it(new j(t.slice()))}}function ot(t){return"nullValue"in t?0:"booleanValue"in t?1:"integerValue"in t||"doubleValue"in t?2:"timestampValue"in t?3:"stringValue"in t?5:"bytesValue"in t?6:"referenceValue"in t?7:"geoPointValue"in t?8:"arrayValue"in t?9:"mapValue"in t?Z(t)?4:10:w()}function at(t,e){const n=ot(t);if(n!==ot(e))return!1;switch(n){case 0:return!0;case 1:return t.booleanValue===e.booleanValue;case 4:return et(t).isEqual(et(e));case 3:return function(t,e){if("string"==typeof t.timestampValue&&"string"==typeof e.timestampValue&&t.timestampValue.length===e.timestampValue.length)return t.timestampValue===e.timestampValue;const n=Y(t.timestampValue),r=Y(e.timestampValue);return n.seconds===r.seconds&&n.nanos===r.nanos}(t,e);case 5:return t.stringValue===e.stringValue;case 6:return function(t,e){return X(t.bytesValue).isEqual(X(e.bytesValue))}(t,e);case 7:return t.referenceValue===e.referenceValue;case 8:return function(t,e){return J(t.geoPointValue.latitude)===J(e.geoPointValue.latitude)&&J(t.geoPointValue.longitude)===J(e.geoPointValue.longitude)}(t,e);case 2:return function(t,e){if("integerValue"in t&&"integerValue"in e)return J(t.integerValue)===J(e.integerValue);if("doubleValue"in t&&"doubleValue"in e){const n=J(t.doubleValue),r=J(e.doubleValue);return n===r?rt(n)===rt(r):isNaN(n)&&isNaN(r)}return!1}(t,e);case 9:return F(t.arrayValue.values||[],e.arrayValue.values||[],at);case 10:return function(t,e){const n=t.mapValue.fields||{},r=e.mapValue.fields||{};if(U(n)!==U(r))return!1;for(const s in n)if(n.hasOwnProperty(s)&&(void 0===r[s]||!at(n[s],r[s])))return!1;return!0}(t,e);default:return w()}}function ct(t,e){return void 0!==(t.values||[]).find((t=>at(t,e)))}function ut(t,e){const n=ot(t),r=ot(e);if(n!==r)return O(n,r);switch(n){case 0:return 0;case 1:return O(t.booleanValue,e.booleanValue);case 2:return function(t,e){const n=J(t.integerValue||t.doubleValue),r=J(e.integerValue||e.doubleValue);return n<r?-1:n>r?1:n===r?0:isNaN(n)?isNaN(r)?0:-1:1}(t,e);case 3:return ht(t.timestampValue,e.timestampValue);case 4:return ht(et(t),et(e));case 5:return O(t.stringValue,e.stringValue);case 6:return function(t,e){const n=X(t),r=X(e);return n.compareTo(r)}(t.bytesValue,e.bytesValue);case 7:return function(t,e){const n=t.split("/"),r=e.split("/");for(let s=0;s<n.length&&s<r.length;s++){const t=O(n[s],r[s]);if(0!==t)return t}return O(n.length,r.length)}(t.referenceValue,e.referenceValue);case 8:return function(t,e){const n=O(J(t.latitude),J(e.latitude));return 0!==n?n:O(J(t.longitude),J(e.longitude))}(t.geoPointValue,e.geoPointValue);case 9:return function(t,e){const n=t.values||[],r=e.values||[];for(let s=0;s<n.length&&s<r.length;++s){const t=ut(n[s],r[s]);if(t)return t}return O(n.length,r.length)}(t.arrayValue,e.arrayValue);case 10:return function(t,e){const n=t.fields||{},r=Object.keys(n),s=e.fields||{},i=Object.keys(s);r.sort(),i.sort();for(let o=0;o<r.length&&o<i.length;++o){const t=O(r[o],i[o]);if(0!==t)return t;const e=ut(n[r[o]],s[i[o]]);if(0!==e)return e}return O(r.length,i.length)}(t.mapValue,e.mapValue);default:throw w()}}function ht(t,e){if("string"==typeof t&&"string"==typeof e&&t.length===e.length)return O(t,e);const n=Y(t),r=Y(e),s=O(n.seconds,r.seconds);return 0!==s?s:O(n.nanos,r.nanos)}function lt(t){return dt(t)}function dt(t){return"nullValue"in t?"null":"booleanValue"in t?""+t.booleanValue:"integerValue"in t?""+t.integerValue:"doubleValue"in t?""+t.doubleValue:"timestampValue"in t?function(t){const e=Y(t);return`time(${e.seconds},${e.nanos})`}(t.timestampValue):"stringValue"in t?t.stringValue:"bytesValue"in t?X(t.bytesValue).toBase64():"referenceValue"in t?(n=t.referenceValue,it.fromName(n).toString()):"geoPointValue"in t?`geo(${(e=t.geoPointValue).latitude},${e.longitude})`:"arrayValue"in t?function(t){let e="[",n=!0;for(const r of t.values||[])n?n=!1:e+=",",e+=dt(r);return e+"]"}(t.arrayValue):"mapValue"in t?function(t){const e=Object.keys(t.fields||{}).sort();let n="{",r=!0;for(const s of e)r?r=!1:n+=",",n+=`${s}:${dt(t.fields[s])}`;return n+"}"}(t.mapValue):w();var e,n}function ft(t,e){return{referenceValue:`projects/${t.projectId}/databases/${t.database}/documents/${e.path.canonicalString()}`}}function mt(t){return!!t&&"integerValue"in t}function gt(t){return!!t&&"arrayValue"in t}function pt(t){return!!t&&"nullValue"in t}function yt(t){return!!t&&"doubleValue"in t&&isNaN(Number(t.doubleValue))}function wt(t){return!!t&&"mapValue"in t}function vt(t){if(t.geoPointValue)return{geoPointValue:Object.assign({},t.geoPointValue)};if(t.timestampValue&&"object"==typeof t.timestampValue)return{timestampValue:Object.assign({},t.timestampValue)};if(t.mapValue){const e={mapValue:{fields:{}}};return q(t.mapValue.fields,((t,n)=>e.mapValue.fields[t]=vt(n))),e}if(t.arrayValue){const e={arrayValue:{values:[]}};for(let n=0;n<(t.arrayValue.values||[]).length;++n)e.arrayValue.values[n]=vt(t.arrayValue.values[n]);return e}return Object.assign({},t)}class It{constructor(t){this.value=t}static empty(){return new It({mapValue:{}})}field(t){if(t.isEmpty())return this.value;{let e=this.value;for(let n=0;n<t.length-1;++n)if(e=(e.mapValue.fields||{})[t.get(n)],!wt(e))return null;return e=(e.mapValue.fields||{})[t.lastSegment()],e||null}}set(t,e){this.getFieldsMap(t.popLast())[t.lastSegment()]=vt(e)}setAll(t){let e=z.emptyPath(),n={},r=[];t.forEach(((t,s)=>{if(!e.isImmediateParentOf(s)){const t=this.getFieldsMap(e);this.applyChanges(t,n,r),n={},r=[],e=s.popLast()}t?n[s.lastSegment()]=vt(t):r.push(s.lastSegment())}));const s=this.getFieldsMap(e);this.applyChanges(s,n,r)}delete(t){const e=this.field(t.popLast());wt(e)&&e.mapValue.fields&&delete e.mapValue.fields[t.lastSegment()]}isEqual(t){return at(this.value,t.value)}getFieldsMap(t){let e=this.value;e.mapValue.fields||(e.mapValue={fields:{}});for(let n=0;n<t.length;++n){let r=e.mapValue.fields[t.get(n)];wt(r)&&r.mapValue.fields||(r={mapValue:{fields:{}}},e.mapValue.fields[t.get(n)]=r),e=r}return e.mapValue.fields}applyChanges(t,e,n){q(e,((e,n)=>t[e]=n));for(const r of n)delete t[r]}clone(){return new It(vt(this.value))}}function bt(t){const e=[];return q(t.fields,((t,n)=>{const r=new z([t]);if(wt(n)){const t=bt(n.mapValue).fields;if(0===t.length)e.push(r);else for(const n of t)e.push(r.child(n))}else e.push(r)})),new G(e)}class Et{constructor(t,e,n,r,s){this.key=t,this.documentType=e,this.version=n,this.data=r,this.documentState=s}static newInvalidDocument(t){return new Et(t,0,P.min(),It.empty(),0)}static newFoundDocument(t,e,n){return new Et(t,1,e,n,0)}static newNoDocument(t,e){return new Et(t,2,e,It.empty(),0)}static newUnknownDocument(t,e){return new Et(t,3,e,It.empty(),2)}convertToFoundDocument(t,e){return this.version=t,this.documentType=1,this.data=e,this.documentState=0,this}convertToNoDocument(t){return this.version=t,this.documentType=2,this.data=It.empty(),this.documentState=0,this}convertToUnknownDocument(t){return this.version=t,this.documentType=3,this.data=It.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(t){return t instanceof Et&&this.key.isEqual(t.key)&&this.version.isEqual(t.version)&&this.documentType===t.documentType&&this.documentState===t.documentState&&this.data.isEqual(t.data)}clone(){return new Et(this.key,this.documentType,this.version,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class Tt{constructor(t,e=null,n=[],r=[],s=null,i=null,o=null){this.path=t,this.collectionGroup=e,this.orderBy=n,this.filters=r,this.limit=s,this.startAt=i,this.endAt=o,this.A=null}}function St(t,e=null,n=[],r=[],s=null,i=null,o=null){return new Tt(t,e,n,r,s,i,o)}function Nt(t){const e=b(t);if(null===e.A){let t=e.path.canonicalString();null!==e.collectionGroup&&(t+="|cg:"+e.collectionGroup),t+="|f:",t+=e.filters.map((t=>function(t){return t.field.canonicalString()+t.op.toString()+lt(t.value)}(t))).join(","),t+="|ob:",t+=e.orderBy.map((t=>function(t){return t.field.canonicalString()+t.dir}(t))).join(","),nt(e.limit)||(t+="|l:",t+=e.limit),e.startAt&&(t+="|lb:",t+=Pt(e.startAt)),e.endAt&&(t+="|ub:",t+=Pt(e.endAt)),e.A=t}return e.A}function _t(t,e){if(t.limit!==e.limit)return!1;if(t.orderBy.length!==e.orderBy.length)return!1;for(let s=0;s<t.orderBy.length;s++)if(!qt(t.orderBy[s],e.orderBy[s]))return!1;if(t.filters.length!==e.filters.length)return!1;for(let s=0;s<t.filters.length;s++)if(n=t.filters[s],r=e.filters[s],n.op!==r.op||!n.field.isEqual(r.field)||!at(n.value,r.value))return!1;var n,r;return t.collectionGroup===e.collectionGroup&&!!t.path.isEqual(e.path)&&!!Kt(t.startAt,e.startAt)&&Kt(t.endAt,e.endAt)}function Dt(t){return it.isDocumentKey(t.path)&&null===t.collectionGroup&&0===t.filters.length}class At extends class{}{constructor(t,e,n){super(),this.field=t,this.op=e,this.value=n}static create(t,e,n){return t.isKeyField()?"in"===e||"not-in"===e?this.R(t,e,n):new kt(t,e,n):"array-contains"===e?new Rt(t,n):"in"===e?new Ot(t,n):"not-in"===e?new Ft(t,n):"array-contains-any"===e?new Mt(t,n):new At(t,e,n)}static R(t,e,n){return"in"===e?new xt(t,n):new Ct(t,n)}matches(t){const e=t.data.field(this.field);return"!="===this.op?null!==e&&this.P(ut(e,this.value)):null!==e&&ot(this.value)===ot(e)&&this.P(ut(e,this.value))}P(t){switch(this.op){case"<":return t<0;case"<=":return t<=0;case"==":return 0===t;case"!=":return 0!==t;case">":return t>0;case">=":return t>=0;default:return w()}}v(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}}class kt extends At{constructor(t,e,n){super(t,e,n),this.key=it.fromName(n.referenceValue)}matches(t){const e=it.comparator(t.key,this.key);return this.P(e)}}class xt extends At{constructor(t,e){super(t,"in",e),this.keys=Lt("in",e)}matches(t){return this.keys.some((e=>e.isEqual(t.key)))}}class Ct extends At{constructor(t,e){super(t,"not-in",e),this.keys=Lt("not-in",e)}matches(t){return!this.keys.some((e=>e.isEqual(t.key)))}}function Lt(t,e){var n;return((null===(n=e.arrayValue)||void 0===n?void 0:n.values)||[]).map((t=>it.fromName(t.referenceValue)))}class Rt extends At{constructor(t,e){super(t,"array-contains",e)}matches(t){const e=t.data.field(this.field);return gt(e)&&ct(e.arrayValue,this.value)}}class Ot extends At{constructor(t,e){super(t,"in",e)}matches(t){const e=t.data.field(this.field);return null!==e&&ct(this.value.arrayValue,e)}}class Ft extends At{constructor(t,e){super(t,"not-in",e)}matches(t){if(ct(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;const e=t.data.field(this.field);return null!==e&&!ct(this.value.arrayValue,e)}}class Mt extends At{constructor(t,e){super(t,"array-contains-any",e)}matches(t){const e=t.data.field(this.field);return!(!gt(e)||!e.arrayValue.values)&&e.arrayValue.values.some((t=>ct(this.value.arrayValue,t)))}}class Vt{constructor(t,e){this.position=t,this.before=e}}function Pt(t){return`${t.before?"b":"a"}:${t.position.map((t=>lt(t))).join(",")}`}class Ut{constructor(t,e="asc"){this.field=t,this.dir=e}}function qt(t,e){return t.dir===e.dir&&t.field.isEqual(e.field)}function Bt(t,e,n){let r=0;for(let s=0;s<t.position.length;s++){const i=e[s],o=t.position[s];if(r=i.field.isKeyField()?it.comparator(it.fromName(o.referenceValue),n.key):ut(o,n.data.field(i.field)),"desc"===i.dir&&(r*=-1),0!==r)break}return t.before?r<=0:r<0}function Kt(t,e){if(null===t)return null===e;if(null===e)return!1;if(t.before!==e.before||t.position.length!==e.position.length)return!1;for(let n=0;n<t.position.length;n++)if(!at(t.position[n],e.position[n]))return!1;return!0}class jt{constructor(t,e=null,n=[],r=[],s=null,i="F",o=null,a=null){this.path=t,this.collectionGroup=e,this.explicitOrderBy=n,this.filters=r,this.limit=s,this.limitType=i,this.startAt=o,this.endAt=a,this.V=null,this.S=null,this.startAt,this.endAt}}function $t(t,e,n,r,s,i,o,a){return new jt(t,e,n,r,s,i,o,a)}function zt(t){return new jt(t)}function Gt(t){return!nt(t.limit)&&"F"===t.limitType}function Qt(t){return!nt(t.limit)&&"L"===t.limitType}function Ht(t){return t.explicitOrderBy.length>0?t.explicitOrderBy[0].field:null}function Wt(t){for(const e of t.filters)if(e.v())return e.field;return null}function Yt(t){return null!==t.collectionGroup}function Jt(t){const e=b(t);if(null===e.V){e.V=[];const t=Wt(e),n=Ht(e);if(null!==t&&null===n)t.isKeyField()||e.V.push(new Ut(t)),e.V.push(new Ut(z.keyField(),"asc"));else{let t=!1;for(const n of e.explicitOrderBy)e.V.push(n),n.field.isKeyField()&&(t=!0);if(!t){const t=e.explicitOrderBy.length>0?e.explicitOrderBy[e.explicitOrderBy.length-1].dir:"asc";e.V.push(new Ut(z.keyField(),t))}}}return e.V}function Xt(t){const e=b(t);if(!e.S)if("F"===e.limitType)e.S=St(e.path,e.collectionGroup,Jt(e),e.filters,e.limit,e.startAt,e.endAt);else{const t=[];for(const s of Jt(e)){const e="desc"===s.dir?"asc":"desc";t.push(new Ut(s.field,e))}const n=e.endAt?new Vt(e.endAt.position,!e.endAt.before):null,r=e.startAt?new Vt(e.startAt.position,!e.startAt.before):null;e.S=St(e.path,e.collectionGroup,t,e.filters,e.limit,n,r)}return e.S}function Zt(t,e,n){return new jt(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),e,n,t.startAt,t.endAt)}function te(t,e){return _t(Xt(t),Xt(e))&&t.limitType===e.limitType}function ee(t){return`${Nt(Xt(t))}|lt:${t.limitType}`}function ne(t){return`Query(target=${function(t){let e=t.path.canonicalString();return null!==t.collectionGroup&&(e+=" collectionGroup="+t.collectionGroup),t.filters.length>0&&(e+=`, filters: [${t.filters.map((t=>{return`${(e=t).field.canonicalString()} ${e.op} ${lt(e.value)}`;var e})).join(", ")}]`),nt(t.limit)||(e+=", limit: "+t.limit),t.orderBy.length>0&&(e+=`, orderBy: [${t.orderBy.map((t=>function(t){return`${t.field.canonicalString()} (${t.dir})`}(t))).join(", ")}]`),t.startAt&&(e+=", startAt: "+Pt(t.startAt)),t.endAt&&(e+=", endAt: "+Pt(t.endAt)),`Target(${e})`}(Xt(t))}; limitType=${t.limitType})`}function re(t,e){return e.isFoundDocument()&&function(t,e){const n=e.key.path;return null!==t.collectionGroup?e.key.hasCollectionId(t.collectionGroup)&&t.path.isPrefixOf(n):it.isDocumentKey(t.path)?t.path.isEqual(n):t.path.isImmediateParentOf(n)}(t,e)&&function(t,e){for(const n of t.explicitOrderBy)if(!n.field.isKeyField()&&null===e.data.field(n.field))return!1;return!0}(t,e)&&function(t,e){for(const n of t.filters)if(!n.matches(e))return!1;return!0}(t,e)&&function(t,e){return!(t.startAt&&!Bt(t.startAt,Jt(t),e))&&(!t.endAt||!Bt(t.endAt,Jt(t),e))}(t,e)}function se(t){return(e,n)=>{let r=!1;for(const s of Jt(t)){const t=ie(s,e,n);if(0!==t)return t;r=r||s.field.isKeyField()}return 0}}function ie(t,e,n){const r=t.field.isKeyField()?it.comparator(e.key,n.key):function(t,e,n){const r=e.data.field(t),s=n.data.field(t);return null!==r&&null!==s?ut(r,s):w()}(t.field,e,n);switch(t.dir){case"asc":return r;case"desc":return-1*r;default:return w()}}function oe(t,e){if(t.D){if(isNaN(e))return{doubleValue:"NaN"};if(e===1/0)return{doubleValue:"Infinity"};if(e===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:rt(e)?"-0":e}}function ae(t){return{integerValue:""+t}}function ce(t,e){return st(e)?ae(e):oe(t,e)}class ue{constructor(){this._=void 0}}function he(t,e,n){return t instanceof fe?function(t,e){const n={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:t.seconds,nanos:t.nanoseconds}}}};return e&&(n.fields.__previous_value__=e),{mapValue:n}}(n,e):t instanceof me?ge(t,e):t instanceof pe?ye(t,e):function(t,e){const n=de(t,e),r=ve(n)+ve(t.C);return mt(n)&&mt(t.C)?ae(r):oe(t.N,r)}(t,e)}function le(t,e,n){return t instanceof me?ge(t,e):t instanceof pe?ye(t,e):n}function de(t,e){return t instanceof we?mt(n=e)||function(t){return!!t&&"doubleValue"in t}(n)?e:{integerValue:0}:null;var n}class fe extends ue{}class me extends ue{constructor(t){super(),this.elements=t}}function ge(t,e){const n=Ie(e);for(const r of t.elements)n.some((t=>at(t,r)))||n.push(r);return{arrayValue:{values:n}}}class pe extends ue{constructor(t){super(),this.elements=t}}function ye(t,e){let n=Ie(e);for(const r of t.elements)n=n.filter((t=>!at(t,r)));return{arrayValue:{values:n}}}class we extends ue{constructor(t,e){super(),this.N=t,this.C=e}}function ve(t){return J(t.integerValue||t.doubleValue)}function Ie(t){return gt(t)&&t.arrayValue.values?t.arrayValue.values.slice():[]}class be{constructor(t,e){this.field=t,this.transform=e}}class Ee{constructor(t,e){this.version=t,this.transformResults=e}}class Te{constructor(t,e){this.updateTime=t,this.exists=e}static none(){return new Te}static exists(t){return new Te(void 0,t)}static updateTime(t){return new Te(t)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(t){return this.exists===t.exists&&(this.updateTime?!!t.updateTime&&this.updateTime.isEqual(t.updateTime):!t.updateTime)}}function Se(t,e){return void 0!==t.updateTime?e.isFoundDocument()&&e.version.isEqual(t.updateTime):void 0===t.exists||t.exists===e.isFoundDocument()}class Ne{}function _e(t,e,n){t instanceof Ce?function(t,e,n){const r=t.value.clone(),s=Oe(t.fieldTransforms,e,n.transformResults);r.setAll(s),e.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(t,e,n):t instanceof Le?function(t,e,n){if(!Se(t.precondition,e))return void e.convertToUnknownDocument(n.version);const r=Oe(t.fieldTransforms,e,n.transformResults),s=e.data;s.setAll(Re(t)),s.setAll(r),e.convertToFoundDocument(n.version,s).setHasCommittedMutations()}(t,e,n):function(t,e,n){e.convertToNoDocument(n.version).setHasCommittedMutations()}(0,e,n)}function De(t,e,n){t instanceof Ce?function(t,e,n){if(!Se(t.precondition,e))return;const r=t.value.clone(),s=Fe(t.fieldTransforms,n,e);r.setAll(s),e.convertToFoundDocument(xe(e),r).setHasLocalMutations()}(t,e,n):t instanceof Le?function(t,e,n){if(!Se(t.precondition,e))return;const r=Fe(t.fieldTransforms,n,e),s=e.data;s.setAll(Re(t)),s.setAll(r),e.convertToFoundDocument(xe(e),s).setHasLocalMutations()}(t,e,n):function(t,e){Se(t.precondition,e)&&e.convertToNoDocument(P.min())}(t,e)}function Ae(t,e){let n=null;for(const r of t.fieldTransforms){const t=e.data.field(r.field),s=de(r.transform,t||null);null!=s&&(null==n&&(n=It.empty()),n.set(r.field,s))}return n||null}function ke(t,e){return t.type===e.type&&!!t.key.isEqual(e.key)&&!!t.precondition.isEqual(e.precondition)&&!!function(t,e){return void 0===t&&void 0===e||!(!t||!e)&&F(t,e,((t,e)=>function(t,e){return t.field.isEqual(e.field)&&function(t,e){return t instanceof me&&e instanceof me||t instanceof pe&&e instanceof pe?F(t.elements,e.elements,at):t instanceof we&&e instanceof we?at(t.C,e.C):t instanceof fe&&e instanceof fe}(t.transform,e.transform)}(t,e)))}(t.fieldTransforms,e.fieldTransforms)&&(0===t.type?t.value.isEqual(e.value):1!==t.type||t.data.isEqual(e.data)&&t.fieldMask.isEqual(e.fieldMask))}function xe(t){return t.isFoundDocument()?t.version:P.min()}class Ce extends Ne{constructor(t,e,n,r=[]){super(),this.key=t,this.value=e,this.precondition=n,this.fieldTransforms=r,this.type=0}}class Le extends Ne{constructor(t,e,n,r,s=[]){super(),this.key=t,this.data=e,this.fieldMask=n,this.precondition=r,this.fieldTransforms=s,this.type=1}}function Re(t){const e=new Map;return t.fieldMask.fields.forEach((n=>{if(!n.isEmpty()){const r=t.data.field(n);e.set(n,r)}})),e}function Oe(t,e,n){const r=new Map;v(t.length===n.length);for(let s=0;s<n.length;s++){const i=t[s],o=i.transform,a=e.data.field(i.field);r.set(i.field,le(o,a,n[s]))}return r}function Fe(t,e,n){const r=new Map;for(const s of t){const t=s.transform,i=n.data.field(s.field);r.set(s.field,he(t,i,e))}return r}class Me extends Ne{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=2,this.fieldTransforms=[]}}class Ve extends Ne{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=3,this.fieldTransforms=[]}}class Pe{constructor(t){this.count=t}}var Ue,qe;function Be(t){switch(t){default:return w();case E.CANCELLED:case E.UNKNOWN:case E.DEADLINE_EXCEEDED:case E.RESOURCE_EXHAUSTED:case E.INTERNAL:case E.UNAVAILABLE:case E.UNAUTHENTICATED:return!1;case E.INVALID_ARGUMENT:case E.NOT_FOUND:case E.ALREADY_EXISTS:case E.PERMISSION_DENIED:case E.FAILED_PRECONDITION:case E.ABORTED:case E.OUT_OF_RANGE:case E.UNIMPLEMENTED:case E.DATA_LOSS:return!0}}function Ke(t){if(void 0===t)return g("GRPC error has no .code"),E.UNKNOWN;switch(t){case Ue.OK:return E.OK;case Ue.CANCELLED:return E.CANCELLED;case Ue.UNKNOWN:return E.UNKNOWN;case Ue.DEADLINE_EXCEEDED:return E.DEADLINE_EXCEEDED;case Ue.RESOURCE_EXHAUSTED:return E.RESOURCE_EXHAUSTED;case Ue.INTERNAL:return E.INTERNAL;case Ue.UNAVAILABLE:return E.UNAVAILABLE;case Ue.UNAUTHENTICATED:return E.UNAUTHENTICATED;case Ue.INVALID_ARGUMENT:return E.INVALID_ARGUMENT;case Ue.NOT_FOUND:return E.NOT_FOUND;case Ue.ALREADY_EXISTS:return E.ALREADY_EXISTS;case Ue.PERMISSION_DENIED:return E.PERMISSION_DENIED;case Ue.FAILED_PRECONDITION:return E.FAILED_PRECONDITION;case Ue.ABORTED:return E.ABORTED;case Ue.OUT_OF_RANGE:return E.OUT_OF_RANGE;case Ue.UNIMPLEMENTED:return E.UNIMPLEMENTED;case Ue.DATA_LOSS:return E.DATA_LOSS;default:return w()}}(qe=Ue||(Ue={}))[qe.OK=0]="OK",qe[qe.CANCELLED=1]="CANCELLED",qe[qe.UNKNOWN=2]="UNKNOWN",qe[qe.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",qe[qe.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",qe[qe.NOT_FOUND=5]="NOT_FOUND",qe[qe.ALREADY_EXISTS=6]="ALREADY_EXISTS",qe[qe.PERMISSION_DENIED=7]="PERMISSION_DENIED",qe[qe.UNAUTHENTICATED=16]="UNAUTHENTICATED",qe[qe.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",qe[qe.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",qe[qe.ABORTED=10]="ABORTED",qe[qe.OUT_OF_RANGE=11]="OUT_OF_RANGE",qe[qe.UNIMPLEMENTED=12]="UNIMPLEMENTED",qe[qe.INTERNAL=13]="INTERNAL",qe[qe.UNAVAILABLE=14]="UNAVAILABLE",qe[qe.DATA_LOSS=15]="DATA_LOSS";class je{constructor(t,e){this.comparator=t,this.root=e||ze.EMPTY}insert(t,e){return new je(this.comparator,this.root.insert(t,e,this.comparator).copy(null,null,ze.BLACK,null,null))}remove(t){return new je(this.comparator,this.root.remove(t,this.comparator).copy(null,null,ze.BLACK,null,null))}get(t){let e=this.root;for(;!e.isEmpty();){const n=this.comparator(t,e.key);if(0===n)return e.value;n<0?e=e.left:n>0&&(e=e.right)}return null}indexOf(t){let e=0,n=this.root;for(;!n.isEmpty();){const r=this.comparator(t,n.key);if(0===r)return e+n.left.size;r<0?n=n.left:(e+=n.left.size+1,n=n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(t){return this.root.inorderTraversal(t)}forEach(t){this.inorderTraversal(((e,n)=>(t(e,n),!1)))}toString(){const t=[];return this.inorderTraversal(((e,n)=>(t.push(`${e}:${n}`),!1))),`{${t.join(", ")}}`}reverseTraversal(t){return this.root.reverseTraversal(t)}getIterator(){return new $e(this.root,null,this.comparator,!1)}getIteratorFrom(t){return new $e(this.root,t,this.comparator,!1)}getReverseIterator(){return new $e(this.root,null,this.comparator,!0)}getReverseIteratorFrom(t){return new $e(this.root,t,this.comparator,!0)}}class $e{constructor(t,e,n,r){this.isReverse=r,this.nodeStack=[];let s=1;for(;!t.isEmpty();)if(s=e?n(t.key,e):1,r&&(s*=-1),s<0)t=this.isReverse?t.left:t.right;else{if(0===s){this.nodeStack.push(t);break}this.nodeStack.push(t),t=this.isReverse?t.right:t.left}}getNext(){let t=this.nodeStack.pop();const e={key:t.key,value:t.value};if(this.isReverse)for(t=t.left;!t.isEmpty();)this.nodeStack.push(t),t=t.right;else for(t=t.right;!t.isEmpty();)this.nodeStack.push(t),t=t.left;return e}hasNext(){return this.nodeStack.length>0}peek(){if(0===this.nodeStack.length)return null;const t=this.nodeStack[this.nodeStack.length-1];return{key:t.key,value:t.value}}}class ze{constructor(t,e,n,r,s){this.key=t,this.value=e,this.color=null!=n?n:ze.RED,this.left=null!=r?r:ze.EMPTY,this.right=null!=s?s:ze.EMPTY,this.size=this.left.size+1+this.right.size}copy(t,e,n,r,s){return new ze(null!=t?t:this.key,null!=e?e:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=s?s:this.right)}isEmpty(){return!1}inorderTraversal(t){return this.left.inorderTraversal(t)||t(this.key,this.value)||this.right.inorderTraversal(t)}reverseTraversal(t){return this.right.reverseTraversal(t)||t(this.key,this.value)||this.left.reverseTraversal(t)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(t,e,n){let r=this;const s=n(t,r.key);return r=s<0?r.copy(null,null,null,r.left.insert(t,e,n),null):0===s?r.copy(null,e,null,null,null):r.copy(null,null,null,null,r.right.insert(t,e,n)),r.fixUp()}removeMin(){if(this.left.isEmpty())return ze.EMPTY;let t=this;return t.left.isRed()||t.left.left.isRed()||(t=t.moveRedLeft()),t=t.copy(null,null,null,t.left.removeMin(),null),t.fixUp()}remove(t,e){let n,r=this;if(e(t,r.key)<0)r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()||(r=r.moveRedLeft()),r=r.copy(null,null,null,r.left.remove(t,e),null);else{if(r.left.isRed()&&(r=r.rotateRight()),r.right.isEmpty()||r.right.isRed()||r.right.left.isRed()||(r=r.moveRedRight()),0===e(t,r.key)){if(r.right.isEmpty())return ze.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(t,e))}return r.fixUp()}isRed(){return this.color}fixUp(){let t=this;return t.right.isRed()&&!t.left.isRed()&&(t=t.rotateLeft()),t.left.isRed()&&t.left.left.isRed()&&(t=t.rotateRight()),t.left.isRed()&&t.right.isRed()&&(t=t.colorFlip()),t}moveRedLeft(){let t=this.colorFlip();return t.right.left.isRed()&&(t=t.copy(null,null,null,null,t.right.rotateRight()),t=t.rotateLeft(),t=t.colorFlip()),t}moveRedRight(){let t=this.colorFlip();return t.left.left.isRed()&&(t=t.rotateRight(),t=t.colorFlip()),t}rotateLeft(){const t=this.copy(null,null,ze.RED,null,this.right.left);return this.right.copy(null,null,this.color,t,null)}rotateRight(){const t=this.copy(null,null,ze.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,t)}colorFlip(){const t=this.left.copy(null,null,!this.left.color,null,null),e=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,t,e)}checkMaxDepth(){const t=this.check();return Math.pow(2,t)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw w();if(this.right.isRed())throw w();const t=this.left.check();if(t!==this.right.check())throw w();return t+(this.isRed()?0:1)}}ze.EMPTY=null,ze.RED=!0,ze.BLACK=!1,ze.EMPTY=new class{constructor(){this.size=0}get key(){throw w()}get value(){throw w()}get color(){throw w()}get left(){throw w()}get right(){throw w()}copy(t,e,n,r,s){return this}insert(t,e,n){return new ze(t,e)}remove(t,e){return this}isEmpty(){return!0}inorderTraversal(t){return!1}reverseTraversal(t){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class Ge{constructor(t){this.comparator=t,this.data=new je(this.comparator)}has(t){return null!==this.data.get(t)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(t){return this.data.indexOf(t)}forEach(t){this.data.inorderTraversal(((e,n)=>(t(e),!1)))}forEachInRange(t,e){const n=this.data.getIteratorFrom(t[0]);for(;n.hasNext();){const r=n.getNext();if(this.comparator(r.key,t[1])>=0)return;e(r.key)}}forEachWhile(t,e){let n;for(n=void 0!==e?this.data.getIteratorFrom(e):this.data.getIterator();n.hasNext();)if(!t(n.getNext().key))return}firstAfterOrEqual(t){const e=this.data.getIteratorFrom(t);return e.hasNext()?e.getNext().key:null}getIterator(){return new Qe(this.data.getIterator())}getIteratorFrom(t){return new Qe(this.data.getIteratorFrom(t))}add(t){return this.copy(this.data.remove(t).insert(t,!0))}delete(t){return this.has(t)?this.copy(this.data.remove(t)):this}isEmpty(){return this.data.isEmpty()}unionWith(t){let e=this;return e.size<t.size&&(e=t,t=this),t.forEach((t=>{e=e.add(t)})),e}isEqual(t){if(!(t instanceof Ge))return!1;if(this.size!==t.size)return!1;const e=this.data.getIterator(),n=t.data.getIterator();for(;e.hasNext();){const t=e.getNext().key,r=n.getNext().key;if(0!==this.comparator(t,r))return!1}return!0}toArray(){const t=[];return this.forEach((e=>{t.push(e)})),t}toString(){const t=[];return this.forEach((e=>t.push(e))),"SortedSet("+t.toString()+")"}copy(t){const e=new Ge(this.comparator);return e.data=t,e}}class Qe{constructor(t){this.iter=t}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}const He=new je(it.comparator);function We(){return He}const Ye=new je(it.comparator);function Je(){return Ye}const Xe=new je(it.comparator);function Ze(){return Xe}const tn=new Ge(it.comparator);function en(...t){let e=tn;for(const n of t)e=e.add(n);return e}const nn=new Ge(O);function rn(){return nn}class sn{constructor(t,e,n,r,s){this.snapshotVersion=t,this.targetChanges=e,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=s}static createSynthesizedRemoteEventForCurrentChange(t,e){const n=new Map;return n.set(t,on.createSynthesizedTargetChangeForCurrentChange(t,e)),new sn(P.min(),n,rn(),We(),en())}}class on{constructor(t,e,n,r,s){this.resumeToken=t,this.current=e,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=s}static createSynthesizedTargetChangeForCurrentChange(t,e){return new on(H.EMPTY_BYTE_STRING,e,en(),en(),en())}}class an{constructor(t,e,n,r){this.k=t,this.removedTargetIds=e,this.key=n,this.$=r}}class cn{constructor(t,e){this.targetId=t,this.O=e}}class un{constructor(t,e,n=H.EMPTY_BYTE_STRING,r=null){this.state=t,this.targetIds=e,this.resumeToken=n,this.cause=r}}class hn{constructor(){this.F=0,this.M=fn(),this.L=H.EMPTY_BYTE_STRING,this.B=!1,this.U=!0}get current(){return this.B}get resumeToken(){return this.L}get q(){return 0!==this.F}get K(){return this.U}j(t){t.approximateByteSize()>0&&(this.U=!0,this.L=t)}W(){let t=en(),e=en(),n=en();return this.M.forEach(((r,s)=>{switch(s){case 0:t=t.add(r);break;case 2:e=e.add(r);break;case 1:n=n.add(r);break;default:w()}})),new on(this.L,this.B,t,e,n)}G(){this.U=!1,this.M=fn()}H(t,e){this.U=!0,this.M=this.M.insert(t,e)}J(t){this.U=!0,this.M=this.M.remove(t)}Y(){this.F+=1}X(){this.F-=1}Z(){this.U=!0,this.B=!0}}class ln{constructor(t){this.tt=t,this.et=new Map,this.nt=We(),this.st=dn(),this.it=new Ge(O)}rt(t){for(const e of t.k)t.$&&t.$.isFoundDocument()?this.ot(e,t.$):this.ct(e,t.key,t.$);for(const e of t.removedTargetIds)this.ct(e,t.key,t.$)}at(t){this.forEachTarget(t,(e=>{const n=this.ut(e);switch(t.state){case 0:this.ht(e)&&n.j(t.resumeToken);break;case 1:n.X(),n.q||n.G(),n.j(t.resumeToken);break;case 2:n.X(),n.q||this.removeTarget(e);break;case 3:this.ht(e)&&(n.Z(),n.j(t.resumeToken));break;case 4:this.ht(e)&&(this.lt(e),n.j(t.resumeToken));break;default:w()}}))}forEachTarget(t,e){t.targetIds.length>0?t.targetIds.forEach(e):this.et.forEach(((t,n)=>{this.ht(n)&&e(n)}))}ft(t){const e=t.targetId,n=t.O.count,r=this.dt(e);if(r){const t=r.target;if(Dt(t))if(0===n){const n=new it(t.path);this.ct(e,n,Et.newNoDocument(n,P.min()))}else v(1===n);else this.wt(e)!==n&&(this.lt(e),this.it=this.it.add(e))}}_t(t){const e=new Map;this.et.forEach(((n,r)=>{const s=this.dt(r);if(s){if(n.current&&Dt(s.target)){const e=new it(s.target.path);null!==this.nt.get(e)||this.gt(r,e)||this.ct(r,e,Et.newNoDocument(e,t))}n.K&&(e.set(r,n.W()),n.G())}}));let n=en();this.st.forEach(((t,e)=>{let r=!0;e.forEachWhile((t=>{const e=this.dt(t);return!e||2===e.purpose||(r=!1,!1)})),r&&(n=n.add(t))}));const r=new sn(t,e,this.it,this.nt,n);return this.nt=We(),this.st=dn(),this.it=new Ge(O),r}ot(t,e){if(!this.ht(t))return;const n=this.gt(t,e.key)?2:0;this.ut(t).H(e.key,n),this.nt=this.nt.insert(e.key,e),this.st=this.st.insert(e.key,this.yt(e.key).add(t))}ct(t,e,n){if(!this.ht(t))return;const r=this.ut(t);this.gt(t,e)?r.H(e,1):r.J(e),this.st=this.st.insert(e,this.yt(e).delete(t)),n&&(this.nt=this.nt.insert(e,n))}removeTarget(t){this.et.delete(t)}wt(t){const e=this.ut(t).W();return this.tt.getRemoteKeysForTarget(t).size+e.addedDocuments.size-e.removedDocuments.size}Y(t){this.ut(t).Y()}ut(t){let e=this.et.get(t);return e||(e=new hn,this.et.set(t,e)),e}yt(t){let e=this.st.get(t);return e||(e=new Ge(O),this.st=this.st.insert(t,e)),e}ht(t){const e=null!==this.dt(t);return e||m("WatchChangeAggregator","Detected inactive target",t),e}dt(t){const e=this.et.get(t);return e&&e.q?null:this.tt.Tt(t)}lt(t){this.et.set(t,new hn),this.tt.getRemoteKeysForTarget(t).forEach((e=>{this.ct(t,e,null)}))}gt(t,e){return this.tt.getRemoteKeysForTarget(t).has(e)}}function dn(){return new je(it.comparator)}function fn(){return new je(it.comparator)}const mn={asc:"ASCENDING",desc:"DESCENDING"},gn={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"};class pn{constructor(t,e){this.databaseId=t,this.D=e}}function yn(t,e){return t.D?`${new Date(1e3*e.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+e.nanoseconds).slice(-9)}Z`:{seconds:""+e.seconds,nanos:e.nanoseconds}}function wn(t,e){return t.D?e.toBase64():e.toUint8Array()}function vn(t,e){return yn(t,e.toTimestamp())}function In(t){return v(!!t),P.fromTimestamp(function(t){const e=Y(t);return new V(e.seconds,e.nanos)}(t))}function bn(t,e){return function(t){return new j(["projects",t.projectId,"databases",t.database])}(t).child("documents").child(e).canonicalString()}function En(t){const e=j.fromString(t);return v(Gn(e)),e}function Tn(t,e){return bn(t.databaseId,e.path)}function Sn(t,e){const n=En(e);if(n.get(1)!==t.databaseId.projectId)throw new T(E.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+t.databaseId.projectId);if(n.get(3)!==t.databaseId.database)throw new T(E.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+t.databaseId.database);return new it(An(n))}function Nn(t,e){return bn(t.databaseId,e)}function _n(t){const e=En(t);return 4===e.length?j.emptyPath():An(e)}function Dn(t){return new j(["projects",t.databaseId.projectId,"databases",t.databaseId.database]).canonicalString()}function An(t){return v(t.length>4&&"documents"===t.get(4)),t.popFirst(5)}function kn(t,e,n){return{name:Tn(t,e),fields:n.value.mapValue.fields}}function xn(t,e,n){const r=Sn(t,e.name),s=In(e.updateTime),i=new It({mapValue:{fields:e.fields}}),o=Et.newFoundDocument(r,s,i);return n&&o.setHasCommittedMutations(),n?o.setHasCommittedMutations():o}function Cn(t,e){let n;if(e instanceof Ce)n={update:kn(t,e.key,e.value)};else if(e instanceof Me)n={delete:Tn(t,e.key)};else if(e instanceof Le)n={update:kn(t,e.key,e.data),updateMask:zn(e.fieldMask)};else{if(!(e instanceof Ve))return w();n={verify:Tn(t,e.key)}}return e.fieldTransforms.length>0&&(n.updateTransforms=e.fieldTransforms.map((t=>function(t,e){const n=e.transform;if(n instanceof fe)return{fieldPath:e.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof me)return{fieldPath:e.field.canonicalString(),appendMissingElements:{values:n.elements}};if(n instanceof pe)return{fieldPath:e.field.canonicalString(),removeAllFromArray:{values:n.elements}};if(n instanceof we)return{fieldPath:e.field.canonicalString(),increment:n.C};throw w()}(0,t)))),e.precondition.isNone||(n.currentDocument=function(t,e){return void 0!==e.updateTime?{updateTime:vn(t,e.updateTime)}:void 0!==e.exists?{exists:e.exists}:w()}(t,e.precondition)),n}function Ln(t,e){const n=e.currentDocument?function(t){return void 0!==t.updateTime?Te.updateTime(In(t.updateTime)):void 0!==t.exists?Te.exists(t.exists):Te.none()}(e.currentDocument):Te.none(),r=e.updateTransforms?e.updateTransforms.map((e=>function(t,e){let n=null;if("setToServerValue"in e)v("REQUEST_TIME"===e.setToServerValue),n=new fe;else if("appendMissingElements"in e){const t=e.appendMissingElements.values||[];n=new me(t)}else if("removeAllFromArray"in e){const t=e.removeAllFromArray.values||[];n=new pe(t)}else"increment"in e?n=new we(t,e.increment):w();const r=z.fromServerFormat(e.fieldPath);return new be(r,n)}(t,e))):[];if(e.update){e.update.name;const s=Sn(t,e.update.name),i=new It({mapValue:{fields:e.update.fields}});if(e.updateMask){const t=function(t){const e=t.fieldPaths||[];return new G(e.map((t=>z.fromServerFormat(t))))}(e.updateMask);return new Le(s,i,t,n,r)}return new Ce(s,i,n,r)}if(e.delete){const r=Sn(t,e.delete);return new Me(r,n)}if(e.verify){const r=Sn(t,e.verify);return new Ve(r,n)}return w()}function Rn(t,e){return{documents:[Nn(t,e.path)]}}function On(t,e){const n={structuredQuery:{}},r=e.path;null!==e.collectionGroup?(n.parent=Nn(t,r),n.structuredQuery.from=[{collectionId:e.collectionGroup,allDescendants:!0}]):(n.parent=Nn(t,r.popLast()),n.structuredQuery.from=[{collectionId:r.lastSegment()}]);const s=function(t){if(0===t.length)return;const e=t.map((t=>function(t){if("=="===t.op){if(yt(t.value))return{unaryFilter:{field:Bn(t.field),op:"IS_NAN"}};if(pt(t.value))return{unaryFilter:{field:Bn(t.field),op:"IS_NULL"}}}else if("!="===t.op){if(yt(t.value))return{unaryFilter:{field:Bn(t.field),op:"IS_NOT_NAN"}};if(pt(t.value))return{unaryFilter:{field:Bn(t.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:Bn(t.field),op:qn(t.op),value:t.value}}}(t)));return 1===e.length?e[0]:{compositeFilter:{op:"AND",filters:e}}}(e.filters);s&&(n.structuredQuery.where=s);const i=function(t){if(0!==t.length)return t.map((t=>function(t){return{field:Bn(t.field),direction:Un(t.dir)}}(t)))}(e.orderBy);i&&(n.structuredQuery.orderBy=i);const o=function(t,e){return t.D||nt(e)?e:{value:e}}(t,e.limit);return null!==o&&(n.structuredQuery.limit=o),e.startAt&&(n.structuredQuery.startAt=Vn(e.startAt)),e.endAt&&(n.structuredQuery.endAt=Vn(e.endAt)),n}function Fn(t){let e=_n(t.parent);const n=t.structuredQuery,r=n.from?n.from.length:0;let s=null;if(r>0){v(1===r);const t=n.from[0];t.allDescendants?s=t.collectionId:e=e.child(t.collectionId)}let i=[];n.where&&(i=Mn(n.where));let o=[];n.orderBy&&(o=n.orderBy.map((t=>function(t){return new Ut(Kn(t.field),function(t){switch(t){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(t.direction))}(t))));let a=null;n.limit&&(a=function(t){let e;return e="object"==typeof t?t.value:t,nt(e)?null:e}(n.limit));let c=null;n.startAt&&(c=Pn(n.startAt));let u=null;return n.endAt&&(u=Pn(n.endAt)),$t(e,s,o,i,a,"F",c,u)}function Mn(t){return t?void 0!==t.unaryFilter?[$n(t)]:void 0!==t.fieldFilter?[jn(t)]:void 0!==t.compositeFilter?t.compositeFilter.filters.map((t=>Mn(t))).reduce(((t,e)=>t.concat(e))):w():[]}function Vn(t){return{before:t.before,values:t.position}}function Pn(t){const e=!!t.before,n=t.values||[];return new Vt(n,e)}function Un(t){return mn[t]}function qn(t){return gn[t]}function Bn(t){return{fieldPath:t.canonicalString()}}function Kn(t){return z.fromServerFormat(t.fieldPath)}function jn(t){return At.create(Kn(t.fieldFilter.field),function(t){switch(t){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return w()}}(t.fieldFilter.op),t.fieldFilter.value)}function $n(t){switch(t.unaryFilter.op){case"IS_NAN":const e=Kn(t.unaryFilter.field);return At.create(e,"==",{doubleValue:NaN});case"IS_NULL":const n=Kn(t.unaryFilter.field);return At.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const r=Kn(t.unaryFilter.field);return At.create(r,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const s=Kn(t.unaryFilter.field);return At.create(s,"!=",{nullValue:"NULL_VALUE"});default:return w()}}function zn(t){const e=[];return t.fields.forEach((t=>e.push(t.canonicalString()))),{fieldPaths:e}}function Gn(t){return t.length>=4&&"projects"===t.get(0)&&"databases"===t.get(2)}function Qn(t){let e="";for(let n=0;n<t.length;n++)e.length>0&&(e=Wn(e)),e=Hn(t.get(n),e);return Wn(e)}function Hn(t,e){let n=e;const r=t.length;for(let s=0;s<r;s++){const e=t.charAt(s);switch(e){case"\0":n+="\x01\x10";break;case"\x01":n+="\x01\x11";break;default:n+=e}}return n}function Wn(t){return t+"\x01\x01"}function Yn(t){const e=t.length;if(v(e>=2),2===e)return v("\x01"===t.charAt(0)&&"\x01"===t.charAt(1)),j.emptyPath();const n=e-2,r=[];let s="";for(let i=0;i<e;){const e=t.indexOf("\x01",i);switch((e<0||e>n)&&w(),t.charAt(e+1)){case"\x01":const n=t.substring(i,e);let o;0===s.length?o=n:(s+=n,o=s,s=""),r.push(o);break;case"\x10":s+=t.substring(i,e),s+="\0";break;case"\x11":s+=t.substring(i,e+1);break;default:w()}i=e+2}return new j(r)}class Jn{constructor(t,e){this.seconds=t,this.nanoseconds=e}}class Xn{constructor(t,e,n){this.ownerId=t,this.allowTabSynchronization=e,this.leaseTimestampMs=n}}Xn.store="owner",Xn.key="owner";class Zn{constructor(t,e,n){this.userId=t,this.lastAcknowledgedBatchId=e,this.lastStreamToken=n}}Zn.store="mutationQueues",Zn.keyPath="userId";class tr{constructor(t,e,n,r,s){this.userId=t,this.batchId=e,this.localWriteTimeMs=n,this.baseMutations=r,this.mutations=s}}tr.store="mutations",tr.keyPath="batchId",tr.userMutationsIndex="userMutationsIndex",tr.userMutationsKeyPath=["userId","batchId"];class er{constructor(){}static prefixForUser(t){return[t]}static prefixForPath(t,e){return[t,Qn(e)]}static key(t,e,n){return[t,Qn(e),n]}}er.store="documentMutations",er.PLACEHOLDER=new er;class nr{constructor(t,e){this.path=t,this.readTime=e}}class rr{constructor(t,e){this.path=t,this.version=e}}class sr{constructor(t,e,n,r,s,i){this.unknownDocument=t,this.noDocument=e,this.document=n,this.hasCommittedMutations=r,this.readTime=s,this.parentPath=i}}sr.store="remoteDocuments",sr.readTimeIndex="readTimeIndex",sr.readTimeIndexPath="readTime",sr.collectionReadTimeIndex="collectionReadTimeIndex",sr.collectionReadTimeIndexPath=["parentPath","readTime"];class ir{constructor(t){this.byteSize=t}}ir.store="remoteDocumentGlobal",ir.key="remoteDocumentGlobalKey";class or{constructor(t,e,n,r,s,i,o){this.targetId=t,this.canonicalId=e,this.readTime=n,this.resumeToken=r,this.lastListenSequenceNumber=s,this.lastLimboFreeSnapshotVersion=i,this.query=o}}or.store="targets",or.keyPath="targetId",or.queryTargetsIndexName="queryTargetsIndex",or.queryTargetsKeyPath=["canonicalId","targetId"];class ar{constructor(t,e,n){this.targetId=t,this.path=e,this.sequenceNumber=n}}ar.store="targetDocuments",ar.keyPath=["targetId","path"],ar.documentTargetsIndex="documentTargetsIndex",ar.documentTargetsKeyPath=["path","targetId"];class cr{constructor(t,e,n,r){this.highestTargetId=t,this.highestListenSequenceNumber=e,this.lastRemoteSnapshotVersion=n,this.targetCount=r}}cr.key="targetGlobalKey",cr.store="targetGlobal";class ur{constructor(t,e){this.collectionId=t,this.parent=e}}ur.store="collectionParents",ur.keyPath=["collectionId","parent"];class hr{constructor(t,e,n,r){this.clientId=t,this.updateTimeMs=e,this.networkEnabled=n,this.inForeground=r}}hr.store="clientMetadata",hr.keyPath="clientId";class lr{constructor(t,e,n){this.bundleId=t,this.createTime=e,this.version=n}}lr.store="bundles",lr.keyPath="bundleId";class dr{constructor(t,e,n){this.name=t,this.readTime=e,this.bundledQuery=n}}dr.store="namedQueries",dr.keyPath="name";const fr=[Zn.store,tr.store,er.store,sr.store,or.store,Xn.store,cr.store,ar.store,hr.store,ir.store,ur.store,lr.store,dr.store],mr="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class gr{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(t){this.onCommittedListeners.push(t)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach((t=>t()))}}class pr{constructor(t){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,t((t=>{this.isDone=!0,this.result=t,this.nextCallback&&this.nextCallback(t)}),(t=>{this.isDone=!0,this.error=t,this.catchCallback&&this.catchCallback(t)}))}catch(t){return this.next(void 0,t)}next(t,e){return this.callbackAttached&&w(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(e,this.error):this.wrapSuccess(t,this.result):new pr(((n,r)=>{this.nextCallback=e=>{this.wrapSuccess(t,e).next(n,r)},this.catchCallback=t=>{this.wrapFailure(e,t).next(n,r)}}))}toPromise(){return new Promise(((t,e)=>{this.next(t,e)}))}wrapUserFunction(t){try{const e=t();return e instanceof pr?e:pr.resolve(e)}catch(t){return pr.reject(t)}}wrapSuccess(t,e){return t?this.wrapUserFunction((()=>t(e))):pr.resolve(e)}wrapFailure(t,e){return t?this.wrapUserFunction((()=>t(e))):pr.reject(e)}static resolve(t){return new pr(((e,n)=>{e(t)}))}static reject(t){return new pr(((e,n)=>{n(t)}))}static waitFor(t){return new pr(((e,n)=>{let r=0,s=0,i=!1;t.forEach((t=>{++r,t.next((()=>{++s,i&&s===r&&e()}),(t=>n(t)))})),i=!0,s===r&&e()}))}static or(t){let e=pr.resolve(!1);for(const n of t)e=e.next((t=>t?pr.resolve(t):n()));return e}static forEach(t,e){const n=[];return t.forEach(((t,r)=>{n.push(e.call(this,t,r))})),this.waitFor(n)}}class yr{constructor(t,e){this.action=t,this.transaction=e,this.aborted=!1,this.Et=new S,this.transaction.oncomplete=()=>{this.Et.resolve()},this.transaction.onabort=()=>{e.error?this.Et.reject(new Ir(t,e.error)):this.Et.resolve()},this.transaction.onerror=e=>{const n=Nr(e.target.error);this.Et.reject(new Ir(t,n))}}static open(t,e,n,r){try{return new yr(e,t.transaction(r,n))}catch(t){throw new Ir(e,t)}}get It(){return this.Et.promise}abort(t){t&&this.Et.reject(t),this.aborted||(m("SimpleDb","Aborting transaction:",t?t.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}store(t){const e=this.transaction.objectStore(t);return new Er(e)}}class wr{constructor(t,e,n){this.name=t,this.version=e,this.At=n,12.2===wr.Rt(Object(o.l)())&&g("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(t){return m("SimpleDb","Removing database:",t),Tr(window.indexedDB.deleteDatabase(t)).toPromise()}static bt(){if(!Object(o.r)())return!1;if(wr.Pt())return!0;const t=Object(o.l)(),e=wr.Rt(t),n=0<e&&e<10,r=wr.vt(t),s=0<r&&r<4.5;return!(t.indexOf("MSIE ")>0||t.indexOf("Trident/")>0||t.indexOf("Edge/")>0||n||s)}static Pt(){var e;return"undefined"!=typeof t&&"YES"===(null===(e=t.env)||void 0===e?void 0:e.Vt)}static St(t,e){return t.store(e)}static Rt(t){const e=t.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=e?e[1].split("_").slice(0,2).join("."):"-1";return Number(n)}static vt(t){const e=t.match(/Android ([\d.]+)/i),n=e?e[1].split(".").slice(0,2).join("."):"-1";return Number(n)}async Dt(t){return this.db||(m("SimpleDb","Opening database:",this.name),this.db=await new Promise(((e,n)=>{const r=indexedDB.open(this.name,this.version);r.onsuccess=t=>{const n=t.target.result;e(n)},r.onblocked=()=>{n(new Ir(t,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},r.onerror=e=>{const r=e.target.error;"VersionError"===r.name?n(new T(E.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===r.name?n(new T(E.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+r)):n(new Ir(t,r))},r.onupgradeneeded=t=>{m("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',t.oldVersion);const e=t.target.result;this.At.Ct(e,r.transaction,t.oldVersion,this.version).next((()=>{m("SimpleDb","Database upgrade to version "+this.version+" complete")}))}}))),this.Nt&&(this.db.onversionchange=t=>this.Nt(t)),this.db}xt(t){this.Nt=t,this.db&&(this.db.onversionchange=e=>t(e))}async runTransaction(t,e,n,r){const s="readonly"===e;let i=0;for(;;){++i;try{this.db=await this.Dt(t);const e=yr.open(this.db,t,s?"readonly":"readwrite",n),i=r(e).catch((t=>(e.abort(t),pr.reject(t)))).toPromise();return i.catch((()=>{})),await e.It,i}catch(t){const e="FirebaseError"!==t.name&&i<3;if(m("SimpleDb","Transaction failed with error:",t.message,"Retrying:",e),this.close(),!e)return Promise.reject(t)}}}close(){this.db&&this.db.close(),this.db=void 0}}class vr{constructor(t){this.kt=t,this.$t=!1,this.Ot=null}get isDone(){return this.$t}get Ft(){return this.Ot}set cursor(t){this.kt=t}done(){this.$t=!0}Mt(t){this.Ot=t}delete(){return Tr(this.kt.delete())}}class Ir extends T{constructor(t,e){super(E.UNAVAILABLE,`IndexedDB transaction '${t}' failed: ${e}`),this.name="IndexedDbTransactionError"}}function br(t){return"IndexedDbTransactionError"===t.name}class Er{constructor(t){this.store=t}put(t,e){let n;return void 0!==e?(m("SimpleDb","PUT",this.store.name,t,e),n=this.store.put(e,t)):(m("SimpleDb","PUT",this.store.name,"<auto-key>",t),n=this.store.put(t)),Tr(n)}add(t){return m("SimpleDb","ADD",this.store.name,t,t),Tr(this.store.add(t))}get(t){return Tr(this.store.get(t)).next((e=>(void 0===e&&(e=null),m("SimpleDb","GET",this.store.name,t,e),e)))}delete(t){return m("SimpleDb","DELETE",this.store.name,t),Tr(this.store.delete(t))}count(){return m("SimpleDb","COUNT",this.store.name),Tr(this.store.count())}Lt(t,e){const n=this.cursor(this.options(t,e)),r=[];return this.Bt(n,((t,e)=>{r.push(e)})).next((()=>r))}Ut(t,e){m("SimpleDb","DELETE ALL",this.store.name);const n=this.options(t,e);n.qt=!1;const r=this.cursor(n);return this.Bt(r,((t,e,n)=>n.delete()))}Kt(t,e){let n;e?n=t:(n={},e=t);const r=this.cursor(n);return this.Bt(r,e)}jt(t){const e=this.cursor({});return new pr(((n,r)=>{e.onerror=t=>{const e=Nr(t.target.error);r(e)},e.onsuccess=e=>{const r=e.target.result;r?t(r.primaryKey,r.value).next((t=>{t?r.continue():n()})):n()}}))}Bt(t,e){const n=[];return new pr(((r,s)=>{t.onerror=t=>{s(t.target.error)},t.onsuccess=t=>{const s=t.target.result;if(!s)return void r();const i=new vr(s),o=e(s.primaryKey,s.value,i);if(o instanceof pr){const t=o.catch((t=>(i.done(),pr.reject(t))));n.push(t)}i.isDone?r():null===i.Ft?s.continue():s.continue(i.Ft)}})).next((()=>pr.waitFor(n)))}options(t,e){let n;return void 0!==t&&("string"==typeof t?n=t:e=t),{index:n,range:e}}cursor(t){let e="next";if(t.reverse&&(e="prev"),t.index){const n=this.store.index(t.index);return t.qt?n.openKeyCursor(t.range,e):n.openCursor(t.range,e)}return this.store.openCursor(t.range,e)}}function Tr(t){return new pr(((e,n)=>{t.onsuccess=t=>{const n=t.target.result;e(n)},t.onerror=t=>{const e=Nr(t.target.error);n(e)}}))}let Sr=!1;function Nr(t){const e=wr.Rt(Object(o.l)());if(e>=12.2&&e<13){const e="An internal error was encountered in the Indexed Database server";if(t.message.indexOf(e)>=0){const t=new T("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${e}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return Sr||(Sr=!0,setTimeout((()=>{throw t}),0)),t}}return t}class _r extends gr{constructor(t,e){super(),this.Qt=t,this.currentSequenceNumber=e}}function Dr(t,e){const n=b(t);return wr.St(n.Qt,e)}class Ar{constructor(t,e,n,r){this.batchId=t,this.localWriteTime=e,this.baseMutations=n,this.mutations=r}applyToRemoteDocument(t,e){const n=e.mutationResults;for(let r=0;r<this.mutations.length;r++){const e=this.mutations[r];e.key.isEqual(t.key)&&_e(e,t,n[r])}}applyToLocalView(t){for(const e of this.baseMutations)e.key.isEqual(t.key)&&De(e,t,this.localWriteTime);for(const e of this.mutations)e.key.isEqual(t.key)&&De(e,t,this.localWriteTime)}applyToLocalDocumentSet(t){this.mutations.forEach((e=>{const n=t.get(e.key),r=n;this.applyToLocalView(r),n.isValidDocument()||r.convertToNoDocument(P.min())}))}keys(){return this.mutations.reduce(((t,e)=>t.add(e.key)),en())}isEqual(t){return this.batchId===t.batchId&&F(this.mutations,t.mutations,((t,e)=>ke(t,e)))&&F(this.baseMutations,t.baseMutations,((t,e)=>ke(t,e)))}}class kr{constructor(t,e,n,r){this.batch=t,this.commitVersion=e,this.mutationResults=n,this.docVersions=r}static from(t,e,n){v(t.mutations.length===n.length);let r=Ze();const s=t.mutations;for(let i=0;i<s.length;i++)r=r.insert(s[i].key,n[i].version);return new kr(t,e,n,r)}}class xr{constructor(t,e,n,r,s=P.min(),i=P.min(),o=H.EMPTY_BYTE_STRING){this.target=t,this.targetId=e,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=s,this.lastLimboFreeSnapshotVersion=i,this.resumeToken=o}withSequenceNumber(t){return new xr(this.target,this.targetId,this.purpose,t,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken)}withResumeToken(t,e){return new xr(this.target,this.targetId,this.purpose,this.sequenceNumber,e,this.lastLimboFreeSnapshotVersion,t)}withLastLimboFreeSnapshotVersion(t){return new xr(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,t,this.resumeToken)}}class Cr{constructor(t){this.Wt=t}}function Lr(t,e){if(e.document)return xn(t.Wt,e.document,!!e.hasCommittedMutations);if(e.noDocument){const t=it.fromSegments(e.noDocument.path),n=Vr(e.noDocument.readTime),r=Et.newNoDocument(t,n);return e.hasCommittedMutations?r.setHasCommittedMutations():r}if(e.unknownDocument){const t=it.fromSegments(e.unknownDocument.path),n=Vr(e.unknownDocument.version);return Et.newUnknownDocument(t,n)}return w()}function Rr(t,e,n){const r=Or(n),s=e.key.path.popLast().toArray();if(e.isFoundDocument()){const n=function(t,e){return{name:Tn(t,e.key),fields:e.data.value.mapValue.fields,updateTime:yn(t,e.version.toTimestamp())}}(t.Wt,e),i=e.hasCommittedMutations;return new sr(null,null,n,i,r,s)}if(e.isNoDocument()){const t=e.key.path.toArray(),n=Mr(e.version),i=e.hasCommittedMutations;return new sr(null,new nr(t,n),null,i,r,s)}if(e.isUnknownDocument()){const t=e.key.path.toArray(),n=Mr(e.version);return new sr(new rr(t,n),null,null,!0,r,s)}return w()}function Or(t){const e=t.toTimestamp();return[e.seconds,e.nanoseconds]}function Fr(t){const e=new V(t[0],t[1]);return P.fromTimestamp(e)}function Mr(t){const e=t.toTimestamp();return new Jn(e.seconds,e.nanoseconds)}function Vr(t){const e=new V(t.seconds,t.nanoseconds);return P.fromTimestamp(e)}function Pr(t,e){const n=(e.baseMutations||[]).map((e=>Ln(t.Wt,e)));for(let i=0;i<e.mutations.length-1;++i){const t=e.mutations[i];if(i+1<e.mutations.length&&void 0!==e.mutations[i+1].transform){const n=e.mutations[i+1];t.updateTransforms=n.transform.fieldTransforms,e.mutations.splice(i+1,1),++i}}const r=e.mutations.map((e=>Ln(t.Wt,e))),s=V.fromMillis(e.localWriteTimeMs);return new Ar(e.batchId,s,n,r)}function Ur(t){const e=Vr(t.readTime),n=void 0!==t.lastLimboFreeSnapshotVersion?Vr(t.lastLimboFreeSnapshotVersion):P.min();let r;var s;return void 0!==t.query.documents?(v(1===(s=t.query).documents.length),r=Xt(zt(_n(s.documents[0])))):r=function(t){return Xt(Fn(t))}(t.query),new xr(r,t.targetId,0,t.lastListenSequenceNumber,e,n,H.fromBase64String(t.resumeToken))}function qr(t,e){const n=Mr(e.snapshotVersion),r=Mr(e.lastLimboFreeSnapshotVersion);let s;s=Dt(e.target)?Rn(t.Wt,e.target):On(t.Wt,e.target);const i=e.resumeToken.toBase64();return new or(e.targetId,Nt(e.target),n,i,e.sequenceNumber,r,s)}function Br(t){const e=Fn({parent:t.parent,structuredQuery:t.structuredQuery});return"LAST"===t.limitType?Zt(e,e.limit,"L"):e}class Kr{getBundleMetadata(t,e){return jr(t).get(e).next((t=>{if(t)return{id:(e=t).bundleId,createTime:Vr(e.createTime),version:e.version};var e}))}saveBundleMetadata(t,e){return jr(t).put({bundleId:(n=e).id,createTime:Mr(In(n.createTime)),version:n.version});var n}getNamedQuery(t,e){return $r(t).get(e).next((t=>{if(t)return{name:(e=t).name,query:Br(e.bundledQuery),readTime:Vr(e.readTime)};var e}))}saveNamedQuery(t,e){return $r(t).put(function(t){return{name:t.name,readTime:Mr(In(t.readTime)),bundledQuery:t.bundledQuery}}(e))}}function jr(t){return Dr(t,lr.store)}function $r(t){return Dr(t,dr.store)}class zr{constructor(){this.Gt=new Gr}addToCollectionParentIndex(t,e){return this.Gt.add(e),pr.resolve()}getCollectionParents(t,e){return pr.resolve(this.Gt.getEntries(e))}}class Gr{constructor(){this.index={}}add(t){const e=t.lastSegment(),n=t.popLast(),r=this.index[e]||new Ge(j.comparator),s=!r.has(n);return this.index[e]=r.add(n),s}has(t){const e=t.lastSegment(),n=t.popLast(),r=this.index[e];return r&&r.has(n)}getEntries(t){return(this.index[t]||new Ge(j.comparator)).toArray()}}class Qr{constructor(){this.zt=new Gr}addToCollectionParentIndex(t,e){if(!this.zt.has(e)){const n=e.lastSegment(),r=e.popLast();t.addOnCommittedListener((()=>{this.zt.add(e)}));const s={collectionId:n,parent:Qn(r)};return Hr(t).put(s)}return pr.resolve()}getCollectionParents(t,e){const n=[],r=IDBKeyRange.bound([e,""],[M(e),""],!1,!0);return Hr(t).Lt(r).next((t=>{for(const r of t){if(r.collectionId!==e)break;n.push(Yn(r.parent))}return n}))}}function Hr(t){return Dr(t,ur.store)}const Wr={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class Yr{constructor(t,e,n){this.cacheSizeCollectionThreshold=t,this.percentileToCollect=e,this.maximumSequenceNumbersToCollect=n}static withCacheSize(t){return new Yr(t,Yr.DEFAULT_COLLECTION_PERCENTILE,Yr.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}function Jr(t,e,n){const r=t.store(tr.store),s=t.store(er.store),i=[],o=IDBKeyRange.only(n.batchId);let a=0;const c=r.Kt({range:o},((t,e,n)=>(a++,n.delete())));i.push(c.next((()=>{v(1===a)})));const u=[];for(const h of n.mutations){const t=er.key(e,h.key.path,n.batchId);i.push(s.delete(t)),u.push(h.key)}return pr.waitFor(i).next((()=>u))}function Xr(t){if(!t)return 0;let e;if(t.document)e=t.document;else if(t.unknownDocument)e=t.unknownDocument;else{if(!t.noDocument)throw w();e=t.noDocument}return JSON.stringify(e).length}Yr.DEFAULT_COLLECTION_PERCENTILE=10,Yr.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,Yr.DEFAULT=new Yr(41943040,Yr.DEFAULT_COLLECTION_PERCENTILE,Yr.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),Yr.DISABLED=new Yr(-1,0,0);class Zr{constructor(t,e,n,r){this.userId=t,this.N=e,this.Ht=n,this.referenceDelegate=r,this.Jt={}}static Yt(t,e,n,r){v(""!==t.uid);const s=t.isAuthenticated()?t.uid:"";return new Zr(s,e,n,r)}checkEmpty(t){let e=!0;const n=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return es(t).Kt({index:tr.userMutationsIndex,range:n},((t,n,r)=>{e=!1,r.done()})).next((()=>e))}addMutationBatch(t,e,n,r){const s=ns(t),i=es(t);return i.add({}).next((o=>{v("number"==typeof o);const a=new Ar(o,e,n,r),c=function(t,e,n){const r=n.baseMutations.map((e=>Cn(t.Wt,e))),s=n.mutations.map((e=>Cn(t.Wt,e)));return new tr(e,n.batchId,n.localWriteTime.toMillis(),r,s)}(this.N,this.userId,a),u=[];let h=new Ge(((t,e)=>O(t.canonicalString(),e.canonicalString())));for(const t of r){const e=er.key(this.userId,t.key.path,o);h=h.add(t.key.path.popLast()),u.push(i.put(c)),u.push(s.put(e,er.PLACEHOLDER))}return h.forEach((e=>{u.push(this.Ht.addToCollectionParentIndex(t,e))})),t.addOnCommittedListener((()=>{this.Jt[o]=a.keys()})),pr.waitFor(u).next((()=>a))}))}lookupMutationBatch(t,e){return es(t).get(e).next((t=>t?(v(t.userId===this.userId),Pr(this.N,t)):null))}Xt(t,e){return this.Jt[e]?pr.resolve(this.Jt[e]):this.lookupMutationBatch(t,e).next((t=>{if(t){const n=t.keys();return this.Jt[e]=n,n}return null}))}getNextMutationBatchAfterBatchId(t,e){const n=e+1,r=IDBKeyRange.lowerBound([this.userId,n]);let s=null;return es(t).Kt({index:tr.userMutationsIndex,range:r},((t,e,r)=>{e.userId===this.userId&&(v(e.batchId>=n),s=Pr(this.N,e)),r.done()})).next((()=>s))}getHighestUnacknowledgedBatchId(t){const e=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let n=-1;return es(t).Kt({index:tr.userMutationsIndex,range:e,reverse:!0},((t,e,r)=>{n=e.batchId,r.done()})).next((()=>n))}getAllMutationBatches(t){const e=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return es(t).Lt(tr.userMutationsIndex,e).next((t=>t.map((t=>Pr(this.N,t)))))}getAllMutationBatchesAffectingDocumentKey(t,e){const n=er.prefixForPath(this.userId,e.path),r=IDBKeyRange.lowerBound(n),s=[];return ns(t).Kt({range:r},((n,r,i)=>{const[o,a,c]=n,u=Yn(a);if(o===this.userId&&e.path.isEqual(u))return es(t).get(c).next((t=>{if(!t)throw w();v(t.userId===this.userId),s.push(Pr(this.N,t))}));i.done()})).next((()=>s))}getAllMutationBatchesAffectingDocumentKeys(t,e){let n=new Ge(O);const r=[];return e.forEach((e=>{const s=er.prefixForPath(this.userId,e.path),i=IDBKeyRange.lowerBound(s),o=ns(t).Kt({range:i},((t,r,s)=>{const[i,o,a]=t,c=Yn(o);i===this.userId&&e.path.isEqual(c)?n=n.add(a):s.done()}));r.push(o)})),pr.waitFor(r).next((()=>this.Zt(t,n)))}getAllMutationBatchesAffectingQuery(t,e){const n=e.path,r=n.length+1,s=er.prefixForPath(this.userId,n),i=IDBKeyRange.lowerBound(s);let o=new Ge(O);return ns(t).Kt({range:i},((t,e,s)=>{const[i,a,c]=t,u=Yn(a);i===this.userId&&n.isPrefixOf(u)?u.length===r&&(o=o.add(c)):s.done()})).next((()=>this.Zt(t,o)))}Zt(t,e){const n=[],r=[];return e.forEach((e=>{r.push(es(t).get(e).next((t=>{if(null===t)throw w();v(t.userId===this.userId),n.push(Pr(this.N,t))})))})),pr.waitFor(r).next((()=>n))}removeMutationBatch(t,e){return Jr(t.Qt,this.userId,e).next((n=>(t.addOnCommittedListener((()=>{this.te(e.batchId)})),pr.forEach(n,(e=>this.referenceDelegate.markPotentiallyOrphaned(t,e))))))}te(t){delete this.Jt[t]}performConsistencyCheck(t){return this.checkEmpty(t).next((e=>{if(!e)return pr.resolve();const n=IDBKeyRange.lowerBound(er.prefixForUser(this.userId)),r=[];return ns(t).Kt({range:n},((t,e,n)=>{if(t[0]===this.userId){const e=Yn(t[1]);r.push(e)}else n.done()})).next((()=>{v(0===r.length)}))}))}containsKey(t,e){return ts(t,this.userId,e)}ee(t){return rs(t).get(this.userId).next((t=>t||new Zn(this.userId,-1,"")))}}function ts(t,e,n){const r=er.prefixForPath(e,n.path),s=r[1],i=IDBKeyRange.lowerBound(r);let o=!1;return ns(t).Kt({range:i,qt:!0},((t,n,r)=>{const[i,a,c]=t;i===e&&a===s&&(o=!0),r.done()})).next((()=>o))}function es(t){return Dr(t,tr.store)}function ns(t){return Dr(t,er.store)}function rs(t){return Dr(t,Zn.store)}class ss{constructor(t){this.ne=t}next(){return this.ne+=2,this.ne}static se(){return new ss(0)}static ie(){return new ss(-1)}}class is{constructor(t,e){this.referenceDelegate=t,this.N=e}allocateTargetId(t){return this.re(t).next((e=>{const n=new ss(e.highestTargetId);return e.highestTargetId=n.next(),this.oe(t,e).next((()=>e.highestTargetId))}))}getLastRemoteSnapshotVersion(t){return this.re(t).next((t=>P.fromTimestamp(new V(t.lastRemoteSnapshotVersion.seconds,t.lastRemoteSnapshotVersion.nanoseconds))))}getHighestSequenceNumber(t){return this.re(t).next((t=>t.highestListenSequenceNumber))}setTargetsMetadata(t,e,n){return this.re(t).next((r=>(r.highestListenSequenceNumber=e,n&&(r.lastRemoteSnapshotVersion=n.toTimestamp()),e>r.highestListenSequenceNumber&&(r.highestListenSequenceNumber=e),this.oe(t,r))))}addTargetData(t,e){return this.ce(t,e).next((()=>this.re(t).next((n=>(n.targetCount+=1,this.ae(e,n),this.oe(t,n))))))}updateTargetData(t,e){return this.ce(t,e)}removeTargetData(t,e){return this.removeMatchingKeysForTargetId(t,e.targetId).next((()=>os(t).delete(e.targetId))).next((()=>this.re(t))).next((e=>(v(e.targetCount>0),e.targetCount-=1,this.oe(t,e))))}removeTargets(t,e,n){let r=0;const s=[];return os(t).Kt(((i,o)=>{const a=Ur(o);a.sequenceNumber<=e&&null===n.get(a.targetId)&&(r++,s.push(this.removeTargetData(t,a)))})).next((()=>pr.waitFor(s))).next((()=>r))}forEachTarget(t,e){return os(t).Kt(((t,n)=>{const r=Ur(n);e(r)}))}re(t){return as(t).get(cr.key).next((t=>(v(null!==t),t)))}oe(t,e){return as(t).put(cr.key,e)}ce(t,e){return os(t).put(qr(this.N,e))}ae(t,e){let n=!1;return t.targetId>e.highestTargetId&&(e.highestTargetId=t.targetId,n=!0),t.sequenceNumber>e.highestListenSequenceNumber&&(e.highestListenSequenceNumber=t.sequenceNumber,n=!0),n}getTargetCount(t){return this.re(t).next((t=>t.targetCount))}getTargetData(t,e){const n=Nt(e),r=IDBKeyRange.bound([n,Number.NEGATIVE_INFINITY],[n,Number.POSITIVE_INFINITY]);let s=null;return os(t).Kt({range:r,index:or.queryTargetsIndexName},((t,n,r)=>{const i=Ur(n);_t(e,i.target)&&(s=i,r.done())})).next((()=>s))}addMatchingKeys(t,e,n){const r=[],s=cs(t);return e.forEach((e=>{const i=Qn(e.path);r.push(s.put(new ar(n,i))),r.push(this.referenceDelegate.addReference(t,n,e))})),pr.waitFor(r)}removeMatchingKeys(t,e,n){const r=cs(t);return pr.forEach(e,(e=>{const s=Qn(e.path);return pr.waitFor([r.delete([n,s]),this.referenceDelegate.removeReference(t,n,e)])}))}removeMatchingKeysForTargetId(t,e){const n=cs(t),r=IDBKeyRange.bound([e],[e+1],!1,!0);return n.delete(r)}getMatchingKeysForTargetId(t,e){const n=IDBKeyRange.bound([e],[e+1],!1,!0),r=cs(t);let s=en();return r.Kt({range:n,qt:!0},((t,e,n)=>{const r=Yn(t[1]),i=new it(r);s=s.add(i)})).next((()=>s))}containsKey(t,e){const n=Qn(e.path),r=IDBKeyRange.bound([n],[M(n)],!1,!0);let s=0;return cs(t).Kt({index:ar.documentTargetsIndex,qt:!0,range:r},(([t,e],n,r)=>{0!==t&&(s++,r.done())})).next((()=>s>0))}Tt(t,e){return os(t).get(e).next((t=>t?Ur(t):null))}}function os(t){return Dr(t,or.store)}function as(t){return Dr(t,cr.store)}function cs(t){return Dr(t,ar.store)}async function us(t){if(t.code!==E.FAILED_PRECONDITION||t.message!==mr)throw t;m("LocalStore","Unexpectedly lost primary lease")}function hs([t,e],[n,r]){const s=O(t,n);return 0===s?O(e,r):s}class ls{constructor(t){this.ue=t,this.buffer=new Ge(hs),this.he=0}le(){return++this.he}fe(t){const e=[t,this.le()];if(this.buffer.size<this.ue)this.buffer=this.buffer.add(e);else{const t=this.buffer.last();hs(e,t)<0&&(this.buffer=this.buffer.delete(t).add(e))}}get maxValue(){return this.buffer.last()[0]}}class ds{constructor(t,e){this.garbageCollector=t,this.asyncQueue=e,this.de=!1,this.we=null}start(t){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this._e(t)}stop(){this.we&&(this.we.cancel(),this.we=null)}get started(){return null!==this.we}_e(t){const e=this.de?3e5:6e4;m("LruGarbageCollector",`Garbage collection scheduled in ${e}ms`),this.we=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,(async()=>{this.we=null,this.de=!0;try{await t.collectGarbage(this.garbageCollector)}catch(t){br(t)?m("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",t):await us(t)}await this._e(t)}))}}class fs{constructor(t,e){this.me=t,this.params=e}calculateTargetCount(t,e){return this.me.ge(t).next((t=>Math.floor(e/100*t)))}nthSequenceNumber(t,e){if(0===e)return pr.resolve(C.T);const n=new ls(e);return this.me.forEachTarget(t,(t=>n.fe(t.sequenceNumber))).next((()=>this.me.ye(t,(t=>n.fe(t))))).next((()=>n.maxValue))}removeTargets(t,e,n){return this.me.removeTargets(t,e,n)}removeOrphanedDocuments(t,e){return this.me.removeOrphanedDocuments(t,e)}collect(t,e){return-1===this.params.cacheSizeCollectionThreshold?(m("LruGarbageCollector","Garbage collection skipped; disabled"),pr.resolve(Wr)):this.getCacheSize(t).next((n=>n<this.params.cacheSizeCollectionThreshold?(m("LruGarbageCollector",`Garbage collection skipped; Cache size ${n} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),Wr):this.pe(t,e)))}getCacheSize(t){return this.me.getCacheSize(t)}pe(t,e){let n,r,s,o,a,c,u;const h=Date.now();return this.calculateTargetCount(t,this.params.percentileToCollect).next((e=>(e>this.params.maximumSequenceNumbersToCollect?(m("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${e}`),r=this.params.maximumSequenceNumbersToCollect):r=e,o=Date.now(),this.nthSequenceNumber(t,r)))).next((r=>(n=r,a=Date.now(),this.removeTargets(t,n,e)))).next((e=>(s=e,c=Date.now(),this.removeOrphanedDocuments(t,n)))).next((t=>(u=Date.now(),d()<=i.a.DEBUG&&m("LruGarbageCollector",`LRU Garbage Collection\n\tCounted targets in ${o-h}ms\n\tDetermined least recently used ${r} in `+(a-o)+"ms\n"+`\tRemoved ${s} targets in `+(c-a)+"ms\n"+`\tRemoved ${t} documents in `+(u-c)+"ms\n"+`Total Duration: ${u-h}ms`),pr.resolve({didRun:!0,sequenceNumbersCollected:r,targetsRemoved:s,documentsRemoved:t}))))}}class ms{constructor(t,e){this.db=t,this.garbageCollector=function(t,e){return new fs(t,e)}(this,e)}ge(t){const e=this.Te(t);return this.db.getTargetCache().getTargetCount(t).next((t=>e.next((e=>t+e))))}Te(t){let e=0;return this.ye(t,(t=>{e++})).next((()=>e))}forEachTarget(t,e){return this.db.getTargetCache().forEachTarget(t,e)}ye(t,e){return this.Ee(t,((t,n)=>e(n)))}addReference(t,e,n){return gs(t,n)}removeReference(t,e,n){return gs(t,n)}removeTargets(t,e,n){return this.db.getTargetCache().removeTargets(t,e,n)}markPotentiallyOrphaned(t,e){return gs(t,e)}Ie(t,e){return function(t,e){let n=!1;return rs(t).jt((r=>ts(t,r,e).next((t=>(t&&(n=!0),pr.resolve(!t)))))).next((()=>n))}(t,e)}removeOrphanedDocuments(t,e){const n=this.db.getRemoteDocumentCache().newChangeBuffer(),r=[];let s=0;return this.Ee(t,((i,o)=>{if(o<=e){const e=this.Ie(t,i).next((e=>{if(!e)return s++,n.getEntry(t,i).next((()=>(n.removeEntry(i),cs(t).delete([0,Qn(i.path)]))))}));r.push(e)}})).next((()=>pr.waitFor(r))).next((()=>n.apply(t))).next((()=>s))}removeTarget(t,e){const n=e.withSequenceNumber(t.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(t,n)}updateLimboDocument(t,e){return gs(t,e)}Ee(t,e){const n=cs(t);let r,s=C.T;return n.Kt({index:ar.documentTargetsIndex},(([t,n],{path:i,sequenceNumber:o})=>{0===t?(s!==C.T&&e(new it(Yn(r)),s),s=o,r=i):s=C.T})).next((()=>{s!==C.T&&e(new it(Yn(r)),s)}))}getCacheSize(t){return this.db.getRemoteDocumentCache().getSize(t)}}function gs(t,e){return cs(t).put(function(t,e){return new ar(0,Qn(t.path),e)}(e,t.currentSequenceNumber))}class ps{constructor(t,e){this.mapKeyFn=t,this.equalsFn=e,this.inner={}}get(t){const e=this.mapKeyFn(t),n=this.inner[e];if(void 0!==n)for(const[r,s]of n)if(this.equalsFn(r,t))return s}has(t){return void 0!==this.get(t)}set(t,e){const n=this.mapKeyFn(t),r=this.inner[n];if(void 0!==r){for(let n=0;n<r.length;n++)if(this.equalsFn(r[n][0],t))return void(r[n]=[t,e]);r.push([t,e])}else this.inner[n]=[[t,e]]}delete(t){const e=this.mapKeyFn(t),n=this.inner[e];if(void 0===n)return!1;for(let r=0;r<n.length;r++)if(this.equalsFn(n[r][0],t))return 1===n.length?delete this.inner[e]:n.splice(r,1),!0;return!1}forEach(t){q(this.inner,((e,n)=>{for(const[r,s]of n)t(r,s)}))}isEmpty(){return B(this.inner)}}class ys{constructor(){this.changes=new ps((t=>t.toString()),((t,e)=>t.isEqual(e))),this.changesApplied=!1}getReadTime(t){const e=this.changes.get(t);return e?e.readTime:P.min()}addEntry(t,e){this.assertNotApplied(),this.changes.set(t.key,{document:t,readTime:e})}removeEntry(t,e=null){this.assertNotApplied(),this.changes.set(t,{document:Et.newInvalidDocument(t),readTime:e})}getEntry(t,e){this.assertNotApplied();const n=this.changes.get(e);return void 0!==n?pr.resolve(n.document):this.getFromCache(t,e)}getEntries(t,e){return this.getAllFromCache(t,e)}apply(t){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(t)}assertNotApplied(){}}class ws{constructor(t,e){this.N=t,this.Ht=e}addEntry(t,e,n){return bs(t).put(Es(e),n)}removeEntry(t,e){const n=bs(t),r=Es(e);return n.delete(r)}updateMetadata(t,e){return this.getMetadata(t).next((n=>(n.byteSize+=e,this.Ae(t,n))))}getEntry(t,e){return bs(t).get(Es(e)).next((t=>this.Re(e,t)))}be(t,e){return bs(t).get(Es(e)).next((t=>({document:this.Re(e,t),size:Xr(t)})))}getEntries(t,e){let n=We();return this.Pe(t,e,((t,e)=>{const r=this.Re(t,e);n=n.insert(t,r)})).next((()=>n))}ve(t,e){let n=We(),r=new je(it.comparator);return this.Pe(t,e,((t,e)=>{const s=this.Re(t,e);n=n.insert(t,s),r=r.insert(t,Xr(e))})).next((()=>({documents:n,Ve:r})))}Pe(t,e,n){if(e.isEmpty())return pr.resolve();const r=IDBKeyRange.bound(e.first().path.toArray(),e.last().path.toArray()),s=e.getIterator();let i=s.getNext();return bs(t).Kt({range:r},((t,e,r)=>{const o=it.fromSegments(t);for(;i&&it.comparator(i,o)<0;)n(i,null),i=s.getNext();i&&i.isEqual(o)&&(n(i,e),i=s.hasNext()?s.getNext():null),i?r.Mt(i.path.toArray()):r.done()})).next((()=>{for(;i;)n(i,null),i=s.hasNext()?s.getNext():null}))}getDocumentsMatchingQuery(t,e,n){let r=We();const s=e.path.length+1,i={};if(n.isEqual(P.min())){const t=e.path.toArray();i.range=IDBKeyRange.lowerBound(t)}else{const t=e.path.toArray(),r=Or(n);i.range=IDBKeyRange.lowerBound([t,r],!0),i.index=sr.collectionReadTimeIndex}return bs(t).Kt(i,((t,n,i)=>{if(t.length!==s)return;const o=Lr(this.N,n);e.path.isPrefixOf(o.key.path)?re(e,o)&&(r=r.insert(o.key,o)):i.done()})).next((()=>r))}newChangeBuffer(t){return new vs(this,!!t&&t.trackRemovals)}getSize(t){return this.getMetadata(t).next((t=>t.byteSize))}getMetadata(t){return Is(t).get(ir.key).next((t=>(v(!!t),t)))}Ae(t,e){return Is(t).put(ir.key,e)}Re(t,e){if(e){const t=Lr(this.N,e);if(!t.isNoDocument()||!t.version.isEqual(P.min()))return t}return Et.newInvalidDocument(t)}}class vs extends ys{constructor(t,e){super(),this.Se=t,this.trackRemovals=e,this.De=new ps((t=>t.toString()),((t,e)=>t.isEqual(e)))}applyChanges(t){const e=[];let n=0,r=new Ge(((t,e)=>O(t.canonicalString(),e.canonicalString())));return this.changes.forEach(((s,i)=>{const o=this.De.get(s);if(i.document.isValidDocument()){const a=Rr(this.Se.N,i.document,this.getReadTime(s));r=r.add(s.path.popLast());const c=Xr(a);n+=c-o,e.push(this.Se.addEntry(t,s,a))}else if(n-=o,this.trackRemovals){const n=Rr(this.Se.N,Et.newNoDocument(s,P.min()),this.getReadTime(s));e.push(this.Se.addEntry(t,s,n))}else e.push(this.Se.removeEntry(t,s))})),r.forEach((n=>{e.push(this.Se.Ht.addToCollectionParentIndex(t,n))})),e.push(this.Se.updateMetadata(t,n)),pr.waitFor(e)}getFromCache(t,e){return this.Se.be(t,e).next((t=>(this.De.set(e,t.size),t.document)))}getAllFromCache(t,e){return this.Se.ve(t,e).next((({documents:t,Ve:e})=>(e.forEach(((t,e)=>{this.De.set(t,e)})),t)))}}function Is(t){return Dr(t,ir.store)}function bs(t){return Dr(t,sr.store)}function Es(t){return t.path.toArray()}class Ts{constructor(t){this.N=t}Ct(t,e,n,r){v(n<r&&n>=0&&r<=11);const s=new yr("createOrUpgrade",e);n<1&&r>=1&&(function(t){t.createObjectStore(Xn.store)}(t),function(t){t.createObjectStore(Zn.store,{keyPath:Zn.keyPath}),t.createObjectStore(tr.store,{keyPath:tr.keyPath,autoIncrement:!0}).createIndex(tr.userMutationsIndex,tr.userMutationsKeyPath,{unique:!0}),t.createObjectStore(er.store)}(t),Ss(t),function(t){t.createObjectStore(sr.store)}(t));let i=pr.resolve();return n<3&&r>=3&&(0!==n&&(function(t){t.deleteObjectStore(ar.store),t.deleteObjectStore(or.store),t.deleteObjectStore(cr.store)}(t),Ss(t)),i=i.next((()=>function(t){const e=t.store(cr.store),n=new cr(0,0,P.min().toTimestamp(),0);return e.put(cr.key,n)}(s)))),n<4&&r>=4&&(0!==n&&(i=i.next((()=>function(t,e){return e.store(tr.store).Lt().next((n=>{t.deleteObjectStore(tr.store),t.createObjectStore(tr.store,{keyPath:tr.keyPath,autoIncrement:!0}).createIndex(tr.userMutationsIndex,tr.userMutationsKeyPath,{unique:!0});const r=e.store(tr.store),s=n.map((t=>r.put(t)));return pr.waitFor(s)}))}(t,s)))),i=i.next((()=>{!function(t){t.createObjectStore(hr.store,{keyPath:hr.keyPath})}(t)}))),n<5&&r>=5&&(i=i.next((()=>this.Ce(s)))),n<6&&r>=6&&(i=i.next((()=>(function(t){t.createObjectStore(ir.store)}(t),this.Ne(s))))),n<7&&r>=7&&(i=i.next((()=>this.xe(s)))),n<8&&r>=8&&(i=i.next((()=>this.ke(t,s)))),n<9&&r>=9&&(i=i.next((()=>{!function(t){t.objectStoreNames.contains("remoteDocumentChanges")&&t.deleteObjectStore("remoteDocumentChanges")}(t),function(t){const e=t.objectStore(sr.store);e.createIndex(sr.readTimeIndex,sr.readTimeIndexPath,{unique:!1}),e.createIndex(sr.collectionReadTimeIndex,sr.collectionReadTimeIndexPath,{unique:!1})}(e)}))),n<10&&r>=10&&(i=i.next((()=>this.$e(s)))),n<11&&r>=11&&(i=i.next((()=>{!function(t){t.createObjectStore(lr.store,{keyPath:lr.keyPath})}(t),function(t){t.createObjectStore(dr.store,{keyPath:dr.keyPath})}(t)}))),i}Ne(t){let e=0;return t.store(sr.store).Kt(((t,n)=>{e+=Xr(n)})).next((()=>{const n=new ir(e);return t.store(ir.store).put(ir.key,n)}))}Ce(t){const e=t.store(Zn.store),n=t.store(tr.store);return e.Lt().next((e=>pr.forEach(e,(e=>{const r=IDBKeyRange.bound([e.userId,-1],[e.userId,e.lastAcknowledgedBatchId]);return n.Lt(tr.userMutationsIndex,r).next((n=>pr.forEach(n,(n=>{v(n.userId===e.userId);const r=Pr(this.N,n);return Jr(t,e.userId,r).next((()=>{}))}))))}))))}xe(t){const e=t.store(ar.store),n=t.store(sr.store);return t.store(cr.store).get(cr.key).next((t=>{const r=[];return n.Kt(((n,s)=>{const i=new j(n),o=function(t){return[0,Qn(t)]}(i);r.push(e.get(o).next((n=>n?pr.resolve():(n=>e.put(new ar(0,Qn(n),t.highestListenSequenceNumber)))(i))))})).next((()=>pr.waitFor(r)))}))}ke(t,e){t.createObjectStore(ur.store,{keyPath:ur.keyPath});const n=e.store(ur.store),r=new Gr,s=t=>{if(r.add(t)){const e=t.lastSegment(),r=t.popLast();return n.put({collectionId:e,parent:Qn(r)})}};return e.store(sr.store).Kt({qt:!0},((t,e)=>{const n=new j(t);return s(n.popLast())})).next((()=>e.store(er.store).Kt({qt:!0},(([t,e,n],r)=>{const i=Yn(e);return s(i.popLast())}))))}$e(t){const e=t.store(or.store);return e.Kt(((t,n)=>{const r=Ur(n),s=qr(this.N,r);return e.put(s)}))}}function Ss(t){t.createObjectStore(ar.store,{keyPath:ar.keyPath}).createIndex(ar.documentTargetsIndex,ar.documentTargetsKeyPath,{unique:!0}),t.createObjectStore(or.store,{keyPath:or.keyPath}).createIndex(or.queryTargetsIndexName,or.queryTargetsKeyPath,{unique:!0}),t.createObjectStore(cr.store)}const Ns="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class _s{constructor(t,e,n,r,s,i,o,a,c,u){if(this.allowTabSynchronization=t,this.persistenceKey=e,this.clientId=n,this.Oe=s,this.window=i,this.document=o,this.Fe=c,this.Me=u,this.Le=null,this.Be=!1,this.isPrimary=!1,this.networkEnabled=!0,this.Ue=null,this.inForeground=!1,this.qe=null,this.Ke=null,this.je=Number.NEGATIVE_INFINITY,this.Qe=t=>Promise.resolve(),!_s.bt())throw new T(E.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new ms(this,r),this.We=e+"main",this.N=new Cr(a),this.Ge=new wr(this.We,11,new Ts(this.N)),this.ze=new is(this.referenceDelegate,this.N),this.Ht=new Qr,this.He=function(t,e){return new ws(t,e)}(this.N,this.Ht),this.Je=new Kr,this.window&&this.window.localStorage?this.Ye=this.window.localStorage:(this.Ye=null,!1===u&&g("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.Xe().then((()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new T(E.FAILED_PRECONDITION,Ns);return this.Ze(),this.tn(),this.en(),this.runTransaction("getHighestListenSequenceNumber","readonly",(t=>this.ze.getHighestSequenceNumber(t)))})).then((t=>{this.Le=new C(t,this.Fe)})).then((()=>{this.Be=!0})).catch((t=>(this.Ge&&this.Ge.close(),Promise.reject(t))))}nn(t){return this.Qe=async e=>{if(this.started)return t(e)},t(this.isPrimary)}setDatabaseDeletedListener(t){this.Ge.xt((async e=>{null===e.newVersion&&await t()}))}setNetworkEnabled(t){this.networkEnabled!==t&&(this.networkEnabled=t,this.Oe.enqueueAndForget((async()=>{this.started&&await this.Xe()})))}Xe(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",(t=>As(t).put(new hr(this.clientId,Date.now(),this.networkEnabled,this.inForeground)).next((()=>{if(this.isPrimary)return this.sn(t).next((t=>{t||(this.isPrimary=!1,this.Oe.enqueueRetryable((()=>this.Qe(!1))))}))})).next((()=>this.rn(t))).next((e=>this.isPrimary&&!e?this.on(t).next((()=>!1)):!!e&&this.cn(t).next((()=>!0)))))).catch((t=>{if(br(t))return m("IndexedDbPersistence","Failed to extend owner lease: ",t),this.isPrimary;if(!this.allowTabSynchronization)throw t;return m("IndexedDbPersistence","Releasing owner lease after error during lease refresh",t),!1})).then((t=>{this.isPrimary!==t&&this.Oe.enqueueRetryable((()=>this.Qe(t))),this.isPrimary=t}))}sn(t){return Ds(t).get(Xn.key).next((t=>pr.resolve(this.an(t))))}un(t){return As(t).delete(this.clientId)}async hn(){if(this.isPrimary&&!this.ln(this.je,18e5)){this.je=Date.now();const t=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",(t=>{const e=Dr(t,hr.store);return e.Lt().next((t=>{const n=this.fn(t,18e5),r=t.filter((t=>-1===n.indexOf(t)));return pr.forEach(r,(t=>e.delete(t.clientId))).next((()=>r))}))})).catch((()=>[]));if(this.Ye)for(const e of t)this.Ye.removeItem(this.dn(e.clientId))}}en(){this.Ke=this.Oe.enqueueAfterDelay("client_metadata_refresh",4e3,(()=>this.Xe().then((()=>this.hn())).then((()=>this.en()))))}an(t){return!!t&&t.ownerId===this.clientId}rn(t){return this.Me?pr.resolve(!0):Ds(t).get(Xn.key).next((e=>{if(null!==e&&this.ln(e.leaseTimestampMs,5e3)&&!this.wn(e.ownerId)){if(this.an(e)&&this.networkEnabled)return!0;if(!this.an(e)){if(!e.allowTabSynchronization)throw new T(E.FAILED_PRECONDITION,Ns);return!1}}return!(!this.networkEnabled||!this.inForeground)||As(t).Lt().next((t=>void 0===this.fn(t,5e3).find((t=>{if(this.clientId!==t.clientId){const e=!this.networkEnabled&&t.networkEnabled,n=!this.inForeground&&t.inForeground,r=this.networkEnabled===t.networkEnabled;if(e||n&&r)return!0}return!1}))))})).next((t=>(this.isPrimary!==t&&m("IndexedDbPersistence",`Client ${t?"is":"is not"} eligible for a primary lease.`),t)))}async shutdown(){this.Be=!1,this._n(),this.Ke&&(this.Ke.cancel(),this.Ke=null),this.mn(),this.gn(),await this.Ge.runTransaction("shutdown","readwrite",[Xn.store,hr.store],(t=>{const e=new _r(t,C.T);return this.on(e).next((()=>this.un(e)))})),this.Ge.close(),this.yn()}fn(t,e){return t.filter((t=>this.ln(t.updateTimeMs,e)&&!this.wn(t.clientId)))}pn(){return this.runTransaction("getActiveClients","readonly",(t=>As(t).Lt().next((t=>this.fn(t,18e5).map((t=>t.clientId))))))}get started(){return this.Be}getMutationQueue(t){return Zr.Yt(t,this.N,this.Ht,this.referenceDelegate)}getTargetCache(){return this.ze}getRemoteDocumentCache(){return this.He}getIndexManager(){return this.Ht}getBundleCache(){return this.Je}runTransaction(t,e,n){m("IndexedDbPersistence","Starting transaction:",t);const r="readonly"===e?"readonly":"readwrite";let s;return this.Ge.runTransaction(t,r,fr,(r=>(s=new _r(r,this.Le?this.Le.next():C.T),"readwrite-primary"===e?this.sn(s).next((t=>!!t||this.rn(s))).next((e=>{if(!e)throw g(`Failed to obtain primary lease for action '${t}'.`),this.isPrimary=!1,this.Oe.enqueueRetryable((()=>this.Qe(!1))),new T(E.FAILED_PRECONDITION,mr);return n(s)})).next((t=>this.cn(s).next((()=>t)))):this.Tn(s).next((()=>n(s)))))).then((t=>(s.raiseOnCommittedEvent(),t)))}Tn(t){return Ds(t).get(Xn.key).next((t=>{if(null!==t&&this.ln(t.leaseTimestampMs,5e3)&&!this.wn(t.ownerId)&&!this.an(t)&&!(this.Me||this.allowTabSynchronization&&t.allowTabSynchronization))throw new T(E.FAILED_PRECONDITION,Ns)}))}cn(t){const e=new Xn(this.clientId,this.allowTabSynchronization,Date.now());return Ds(t).put(Xn.key,e)}static bt(){return wr.bt()}on(t){const e=Ds(t);return e.get(Xn.key).next((t=>this.an(t)?(m("IndexedDbPersistence","Releasing primary lease."),e.delete(Xn.key)):pr.resolve()))}ln(t,e){const n=Date.now();return!(t<n-e)&&(!(t>n)||(g(`Detected an update time that is in the future: ${t} > ${n}`),!1))}Ze(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.qe=()=>{this.Oe.enqueueAndForget((()=>(this.inForeground="visible"===this.document.visibilityState,this.Xe())))},this.document.addEventListener("visibilitychange",this.qe),this.inForeground="visible"===this.document.visibilityState)}mn(){this.qe&&(this.document.removeEventListener("visibilitychange",this.qe),this.qe=null)}tn(){var t;"function"==typeof(null===(t=this.window)||void 0===t?void 0:t.addEventListener)&&(this.Ue=()=>{this._n(),Object(o.v)()&&navigator.appVersion.match("Version/14")&&this.Oe.enterRestrictedMode(!0),this.Oe.enqueueAndForget((()=>this.shutdown()))},this.window.addEventListener("pagehide",this.Ue))}gn(){this.Ue&&(this.window.removeEventListener("pagehide",this.Ue),this.Ue=null)}wn(t){var e;try{const n=null!==(null===(e=this.Ye)||void 0===e?void 0:e.getItem(this.dn(t)));return m("IndexedDbPersistence",`Client '${t}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(t){return g("IndexedDbPersistence","Failed to get zombied client id.",t),!1}}_n(){if(this.Ye)try{this.Ye.setItem(this.dn(this.clientId),String(Date.now()))}catch(t){g("Failed to set zombie client id.",t)}}yn(){if(this.Ye)try{this.Ye.removeItem(this.dn(this.clientId))}catch(t){}}dn(t){return`firestore_zombie_${this.persistenceKey}_${t}`}}function Ds(t){return Dr(t,Xn.store)}function As(t){return Dr(t,hr.store)}function ks(t,e){let n=t.projectId;return t.isDefaultDatabase||(n+="."+t.database),"firestore/"+e+"/"+n+"/"}class xs{constructor(t,e){this.progress=t,this.En=e}}class Cs{constructor(t,e,n){this.He=t,this.In=e,this.Ht=n}An(t,e){return this.In.getAllMutationBatchesAffectingDocumentKey(t,e).next((n=>this.Rn(t,e,n)))}Rn(t,e,n){return this.He.getEntry(t,e).next((t=>{for(const e of n)e.applyToLocalView(t);return t}))}bn(t,e){t.forEach(((t,n)=>{for(const r of e)r.applyToLocalView(n)}))}Pn(t,e){return this.He.getEntries(t,e).next((e=>this.vn(t,e).next((()=>e))))}vn(t,e){return this.In.getAllMutationBatchesAffectingDocumentKeys(t,e).next((t=>this.bn(e,t)))}getDocumentsMatchingQuery(t,e,n){return function(t){return it.isDocumentKey(t.path)&&null===t.collectionGroup&&0===t.filters.length}(e)?this.Vn(t,e.path):Yt(e)?this.Sn(t,e,n):this.Dn(t,e,n)}Vn(t,e){return this.An(t,new it(e)).next((t=>{let e=Je();return t.isFoundDocument()&&(e=e.insert(t.key,t)),e}))}Sn(t,e,n){const r=e.collectionGroup;let s=Je();return this.Ht.getCollectionParents(t,r).next((i=>pr.forEach(i,(i=>{const o=function(t,e){return new jt(e,null,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt)}(e,i.child(r));return this.Dn(t,o,n).next((t=>{t.forEach(((t,e)=>{s=s.insert(t,e)}))}))})).next((()=>s))))}Dn(t,e,n){let r,s;return this.He.getDocumentsMatchingQuery(t,e,n).next((n=>(r=n,this.In.getAllMutationBatchesAffectingQuery(t,e)))).next((e=>(s=e,this.Cn(t,s,r).next((t=>{r=t;for(const e of s)for(const t of e.mutations){const n=t.key;let s=r.get(n);null==s&&(s=Et.newInvalidDocument(n),r=r.insert(n,s)),De(t,s,e.localWriteTime),s.isFoundDocument()||(r=r.remove(n))}}))))).next((()=>(r.forEach(((t,n)=>{re(e,n)||(r=r.remove(t))})),r)))}Cn(t,e,n){let r=en();for(const i of e)for(const t of i.mutations)t instanceof Le&&null===n.get(t.key)&&(r=r.add(t.key));let s=n;return this.He.getEntries(t,r).next((t=>(t.forEach(((t,e)=>{e.isFoundDocument()&&(s=s.insert(t,e))})),s)))}}class Ls{constructor(t,e,n,r){this.targetId=t,this.fromCache=e,this.Nn=n,this.xn=r}static kn(t,e){let n=en(),r=en();for(const s of e.docChanges)switch(s.type){case 0:n=n.add(s.doc.key);break;case 1:r=r.add(s.doc.key)}return new Ls(t,e.fromCache,n,r)}}class Rs{$n(t){this.On=t}getDocumentsMatchingQuery(t,e,n,r){return function(t){return 0===t.filters.length&&null===t.limit&&null==t.startAt&&null==t.endAt&&(0===t.explicitOrderBy.length||1===t.explicitOrderBy.length&&t.explicitOrderBy[0].field.isKeyField())}(e)||n.isEqual(P.min())?this.Fn(t,e):this.On.Pn(t,r).next((s=>{const o=this.Mn(e,s);return(Gt(e)||Qt(e))&&this.Ln(e.limitType,o,r,n)?this.Fn(t,e):(d()<=i.a.DEBUG&&m("QueryEngine","Re-using previous result from %s to execute query: %s",n.toString(),ne(e)),this.On.getDocumentsMatchingQuery(t,e,n).next((t=>(o.forEach((e=>{t=t.insert(e.key,e)})),t))))}))}Mn(t,e){let n=new Ge(se(t));return e.forEach(((e,r)=>{re(t,r)&&(n=n.add(r))})),n}Ln(t,e,n,r){if(n.size!==e.size)return!0;const s="F"===t?e.last():e.first();return!!s&&(s.hasPendingWrites||s.version.compareTo(r)>0)}Fn(t,e){return d()<=i.a.DEBUG&&m("QueryEngine","Using full collection scan to execute query:",ne(e)),this.On.getDocumentsMatchingQuery(t,e,P.min())}}class Os{constructor(t,e,n,r){this.persistence=t,this.Bn=e,this.N=r,this.Un=new je(O),this.qn=new ps((t=>Nt(t)),_t),this.Kn=P.min(),this.In=t.getMutationQueue(n),this.jn=t.getRemoteDocumentCache(),this.ze=t.getTargetCache(),this.Qn=new Cs(this.jn,this.In,this.persistence.getIndexManager()),this.Je=t.getBundleCache(),this.Bn.$n(this.Qn)}collectGarbage(t){return this.persistence.runTransaction("Collect garbage","readwrite-primary",(e=>t.collect(e,this.Un)))}}function Fs(t,e,n,r){return new Os(t,e,n,r)}async function Ms(t,e){const n=b(t);let r=n.In,s=n.Qn;const i=await n.persistence.runTransaction("Handle user change","readonly",(t=>{let i;return n.In.getAllMutationBatches(t).next((o=>(i=o,r=n.persistence.getMutationQueue(e),s=new Cs(n.jn,r,n.persistence.getIndexManager()),r.getAllMutationBatches(t)))).next((e=>{const n=[],r=[];let o=en();for(const t of i){n.push(t.batchId);for(const e of t.mutations)o=o.add(e.key)}for(const t of e){r.push(t.batchId);for(const e of t.mutations)o=o.add(e.key)}return s.Pn(t,o).next((t=>({Wn:t,removedBatchIds:n,addedBatchIds:r})))}))}));return n.In=r,n.Qn=s,n.Bn.$n(n.Qn),i}function Vs(t){const e=b(t);return e.persistence.runTransaction("Get last remote snapshot version","readonly",(t=>e.ze.getLastRemoteSnapshotVersion(t)))}function Ps(t,e,n,r,s){let i=en();return n.forEach((t=>i=i.add(t))),e.getEntries(t,i).next((t=>{let i=We();return n.forEach(((n,o)=>{const a=t.get(n),c=(null==s?void 0:s.get(n))||r;o.isNoDocument()&&o.version.isEqual(P.min())?(e.removeEntry(n,c),i=i.insert(n,o)):!a.isValidDocument()||o.version.compareTo(a.version)>0||0===o.version.compareTo(a.version)&&a.hasPendingWrites?(e.addEntry(o,c),i=i.insert(n,o)):m("LocalStore","Ignoring outdated watch update for ",n,". Current version:",a.version," Watch version:",o.version)})),i}))}function Us(t,e){const n=b(t);return n.persistence.runTransaction("Get next mutation batch","readonly",(t=>(void 0===e&&(e=-1),n.In.getNextMutationBatchAfterBatchId(t,e))))}function qs(t,e){const n=b(t);return n.persistence.runTransaction("Allocate target","readwrite",(t=>{let r;return n.ze.getTargetData(t,e).next((s=>s?(r=s,pr.resolve(r)):n.ze.allocateTargetId(t).next((s=>(r=new xr(e,s,0,t.currentSequenceNumber),n.ze.addTargetData(t,r).next((()=>r)))))))})).then((t=>{const r=n.Un.get(t.targetId);return(null===r||t.snapshotVersion.compareTo(r.snapshotVersion)>0)&&(n.Un=n.Un.insert(t.targetId,t),n.qn.set(e,t.targetId)),t}))}async function Bs(t,e,n){const r=b(t),s=r.Un.get(e),i=n?"readwrite":"readwrite-primary";try{n||await r.persistence.runTransaction("Release target",i,(t=>r.persistence.referenceDelegate.removeTarget(t,s)))}catch(t){if(!br(t))throw t;m("LocalStore",`Failed to update sequence numbers for target ${e}: ${t}`)}r.Un=r.Un.remove(e),r.qn.delete(s.target)}function Ks(t,e,n){const r=b(t);let s=P.min(),i=en();return r.persistence.runTransaction("Execute query","readonly",(t=>function(t,e,n){const r=b(t),s=r.qn.get(n);return void 0!==s?pr.resolve(r.Un.get(s)):r.ze.getTargetData(e,n)}(r,t,Xt(e)).next((e=>{if(e)return s=e.lastLimboFreeSnapshotVersion,r.ze.getMatchingKeysForTargetId(t,e.targetId).next((t=>{i=t}))})).next((()=>r.Bn.getDocumentsMatchingQuery(t,e,n?s:P.min(),n?i:en()))).next((t=>({documents:t,Gn:i})))))}function js(t,e){const n=b(t),r=b(n.ze),s=n.Un.get(e);return s?Promise.resolve(s.target):n.persistence.runTransaction("Get target data","readonly",(t=>r.Tt(t,e).next((t=>t?t.target:null))))}function $s(t){const e=b(t);return e.persistence.runTransaction("Get new document changes","readonly",(t=>function(t,e,n){const r=b(t);let s=We(),i=Or(n);const o=bs(e),a=IDBKeyRange.lowerBound(i,!0);return o.Kt({index:sr.readTimeIndex,range:a},((t,e)=>{const n=Lr(r.N,e);s=s.insert(n.key,n),i=e.readTime})).next((()=>({En:s,readTime:Fr(i)})))}(e.jn,t,e.Kn))).then((({En:t,readTime:n})=>(e.Kn=n,t)))}async function zs(t,e,n=en()){const r=await qs(t,Xt(Br(e.bundledQuery))),s=b(t);return s.persistence.runTransaction("Save named query","readwrite",(t=>{const i=In(e.readTime);if(r.snapshotVersion.compareTo(i)>=0)return s.Je.saveNamedQuery(t,e);const o=r.withResumeToken(H.EMPTY_BYTE_STRING,i);return s.Un=s.Un.insert(o.targetId,o),s.ze.updateTargetData(t,o).next((()=>s.ze.removeMatchingKeysForTargetId(t,r.targetId))).next((()=>s.ze.addMatchingKeys(t,n,r.targetId))).next((()=>s.Je.saveNamedQuery(t,e)))}))}class Gs{constructor(t){this.N=t,this.Yn=new Map,this.Xn=new Map}getBundleMetadata(t,e){return pr.resolve(this.Yn.get(e))}saveBundleMetadata(t,e){var n;return this.Yn.set(e.id,{id:(n=e).id,version:n.version,createTime:In(n.createTime)}),pr.resolve()}getNamedQuery(t,e){return pr.resolve(this.Xn.get(e))}saveNamedQuery(t,e){return this.Xn.set(e.name,function(t){return{name:t.name,query:Br(t.bundledQuery),readTime:In(t.readTime)}}(e)),pr.resolve()}}class Qs{constructor(){this.Zn=new Ge(Hs.ts),this.es=new Ge(Hs.ns)}isEmpty(){return this.Zn.isEmpty()}addReference(t,e){const n=new Hs(t,e);this.Zn=this.Zn.add(n),this.es=this.es.add(n)}ss(t,e){t.forEach((t=>this.addReference(t,e)))}removeReference(t,e){this.rs(new Hs(t,e))}os(t,e){t.forEach((t=>this.removeReference(t,e)))}cs(t){const e=new it(new j([])),n=new Hs(e,t),r=new Hs(e,t+1),s=[];return this.es.forEachInRange([n,r],(t=>{this.rs(t),s.push(t.key)})),s}us(){this.Zn.forEach((t=>this.rs(t)))}rs(t){this.Zn=this.Zn.delete(t),this.es=this.es.delete(t)}hs(t){const e=new it(new j([])),n=new Hs(e,t),r=new Hs(e,t+1);let s=en();return this.es.forEachInRange([n,r],(t=>{s=s.add(t.key)})),s}containsKey(t){const e=new Hs(t,0),n=this.Zn.firstAfterOrEqual(e);return null!==n&&t.isEqual(n.key)}}class Hs{constructor(t,e){this.key=t,this.ls=e}static ts(t,e){return it.comparator(t.key,e.key)||O(t.ls,e.ls)}static ns(t,e){return O(t.ls,e.ls)||it.comparator(t.key,e.key)}}class Ws{constructor(t,e){this.Ht=t,this.referenceDelegate=e,this.In=[],this.fs=1,this.ds=new Ge(Hs.ts)}checkEmpty(t){return pr.resolve(0===this.In.length)}addMutationBatch(t,e,n,r){const s=this.fs;this.fs++,this.In.length>0&&this.In[this.In.length-1];const i=new Ar(s,e,n,r);this.In.push(i);for(const o of r)this.ds=this.ds.add(new Hs(o.key,s)),this.Ht.addToCollectionParentIndex(t,o.key.path.popLast());return pr.resolve(i)}lookupMutationBatch(t,e){return pr.resolve(this.ws(e))}getNextMutationBatchAfterBatchId(t,e){const n=e+1,r=this._s(n),s=r<0?0:r;return pr.resolve(this.In.length>s?this.In[s]:null)}getHighestUnacknowledgedBatchId(){return pr.resolve(0===this.In.length?-1:this.fs-1)}getAllMutationBatches(t){return pr.resolve(this.In.slice())}getAllMutationBatchesAffectingDocumentKey(t,e){const n=new Hs(e,0),r=new Hs(e,Number.POSITIVE_INFINITY),s=[];return this.ds.forEachInRange([n,r],(t=>{const e=this.ws(t.ls);s.push(e)})),pr.resolve(s)}getAllMutationBatchesAffectingDocumentKeys(t,e){let n=new Ge(O);return e.forEach((t=>{const e=new Hs(t,0),r=new Hs(t,Number.POSITIVE_INFINITY);this.ds.forEachInRange([e,r],(t=>{n=n.add(t.ls)}))})),pr.resolve(this.gs(n))}getAllMutationBatchesAffectingQuery(t,e){const n=e.path,r=n.length+1;let s=n;it.isDocumentKey(s)||(s=s.child(""));const i=new Hs(new it(s),0);let o=new Ge(O);return this.ds.forEachWhile((t=>{const e=t.key.path;return!!n.isPrefixOf(e)&&(e.length===r&&(o=o.add(t.ls)),!0)}),i),pr.resolve(this.gs(o))}gs(t){const e=[];return t.forEach((t=>{const n=this.ws(t);null!==n&&e.push(n)})),e}removeMutationBatch(t,e){v(0===this.ys(e.batchId,"removed")),this.In.shift();let n=this.ds;return pr.forEach(e.mutations,(r=>{const s=new Hs(r.key,e.batchId);return n=n.delete(s),this.referenceDelegate.markPotentiallyOrphaned(t,r.key)})).next((()=>{this.ds=n}))}te(t){}containsKey(t,e){const n=new Hs(e,0),r=this.ds.firstAfterOrEqual(n);return pr.resolve(e.isEqual(r&&r.key))}performConsistencyCheck(t){return this.In.length,pr.resolve()}ys(t,e){return this._s(t)}_s(t){return 0===this.In.length?0:t-this.In[0].batchId}ws(t){const e=this._s(t);return e<0||e>=this.In.length?null:this.In[e]}}class Ys{constructor(t,e){this.Ht=t,this.ps=e,this.docs=new je(it.comparator),this.size=0}addEntry(t,e,n){const r=e.key,s=this.docs.get(r),i=s?s.size:0,o=this.ps(e);return this.docs=this.docs.insert(r,{document:e.clone(),size:o,readTime:n}),this.size+=o-i,this.Ht.addToCollectionParentIndex(t,r.path.popLast())}removeEntry(t){const e=this.docs.get(t);e&&(this.docs=this.docs.remove(t),this.size-=e.size)}getEntry(t,e){const n=this.docs.get(e);return pr.resolve(n?n.document.clone():Et.newInvalidDocument(e))}getEntries(t,e){let n=We();return e.forEach((t=>{const e=this.docs.get(t);n=n.insert(t,e?e.document.clone():Et.newInvalidDocument(t))})),pr.resolve(n)}getDocumentsMatchingQuery(t,e,n){let r=We();const s=new it(e.path.child("")),i=this.docs.getIteratorFrom(s);for(;i.hasNext();){const{key:t,value:{document:s,readTime:o}}=i.getNext();if(!e.path.isPrefixOf(t.path))break;o.compareTo(n)<=0||re(e,s)&&(r=r.insert(s.key,s.clone()))}return pr.resolve(r)}Ts(t,e){return pr.forEach(this.docs,(t=>e(t)))}newChangeBuffer(t){return new Js(this)}getSize(t){return pr.resolve(this.size)}}class Js extends ys{constructor(t){super(),this.Se=t}applyChanges(t){const e=[];return this.changes.forEach(((n,r)=>{r.document.isValidDocument()?e.push(this.Se.addEntry(t,r.document,this.getReadTime(n))):this.Se.removeEntry(n)})),pr.waitFor(e)}getFromCache(t,e){return this.Se.getEntry(t,e)}getAllFromCache(t,e){return this.Se.getEntries(t,e)}}class Xs{constructor(t){this.persistence=t,this.Es=new ps((t=>Nt(t)),_t),this.lastRemoteSnapshotVersion=P.min(),this.highestTargetId=0,this.Is=0,this.As=new Qs,this.targetCount=0,this.Rs=ss.se()}forEachTarget(t,e){return this.Es.forEach(((t,n)=>e(n))),pr.resolve()}getLastRemoteSnapshotVersion(t){return pr.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(t){return pr.resolve(this.Is)}allocateTargetId(t){return this.highestTargetId=this.Rs.next(),pr.resolve(this.highestTargetId)}setTargetsMetadata(t,e,n){return n&&(this.lastRemoteSnapshotVersion=n),e>this.Is&&(this.Is=e),pr.resolve()}ce(t){this.Es.set(t.target,t);const e=t.targetId;e>this.highestTargetId&&(this.Rs=new ss(e),this.highestTargetId=e),t.sequenceNumber>this.Is&&(this.Is=t.sequenceNumber)}addTargetData(t,e){return this.ce(e),this.targetCount+=1,pr.resolve()}updateTargetData(t,e){return this.ce(e),pr.resolve()}removeTargetData(t,e){return this.Es.delete(e.target),this.As.cs(e.targetId),this.targetCount-=1,pr.resolve()}removeTargets(t,e,n){let r=0;const s=[];return this.Es.forEach(((i,o)=>{o.sequenceNumber<=e&&null===n.get(o.targetId)&&(this.Es.delete(i),s.push(this.removeMatchingKeysForTargetId(t,o.targetId)),r++)})),pr.waitFor(s).next((()=>r))}getTargetCount(t){return pr.resolve(this.targetCount)}getTargetData(t,e){const n=this.Es.get(e)||null;return pr.resolve(n)}addMatchingKeys(t,e,n){return this.As.ss(e,n),pr.resolve()}removeMatchingKeys(t,e,n){this.As.os(e,n);const r=this.persistence.referenceDelegate,s=[];return r&&e.forEach((e=>{s.push(r.markPotentiallyOrphaned(t,e))})),pr.waitFor(s)}removeMatchingKeysForTargetId(t,e){return this.As.cs(e),pr.resolve()}getMatchingKeysForTargetId(t,e){const n=this.As.hs(e);return pr.resolve(n)}containsKey(t,e){return pr.resolve(this.As.containsKey(e))}}class Zs{constructor(t,e){this.bs={},this.Le=new C(0),this.Be=!1,this.Be=!0,this.referenceDelegate=t(this),this.ze=new Xs(this),this.Ht=new zr,this.He=function(t,e){return new Ys(t,e)}(this.Ht,(t=>this.referenceDelegate.Ps(t))),this.N=new Cr(e),this.Je=new Gs(this.N)}start(){return Promise.resolve()}shutdown(){return this.Be=!1,Promise.resolve()}get started(){return this.Be}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(){return this.Ht}getMutationQueue(t){let e=this.bs[t.toKey()];return e||(e=new Ws(this.Ht,this.referenceDelegate),this.bs[t.toKey()]=e),e}getTargetCache(){return this.ze}getRemoteDocumentCache(){return this.He}getBundleCache(){return this.Je}runTransaction(t,e,n){m("MemoryPersistence","Starting transaction:",t);const r=new ti(this.Le.next());return this.referenceDelegate.vs(),n(r).next((t=>this.referenceDelegate.Vs(r).next((()=>t)))).toPromise().then((t=>(r.raiseOnCommittedEvent(),t)))}Ss(t,e){return pr.or(Object.values(this.bs).map((n=>()=>n.containsKey(t,e))))}}class ti extends gr{constructor(t){super(),this.currentSequenceNumber=t}}class ei{constructor(t){this.persistence=t,this.Ds=new Qs,this.Cs=null}static Ns(t){return new ei(t)}get xs(){if(this.Cs)return this.Cs;throw w()}addReference(t,e,n){return this.Ds.addReference(n,e),this.xs.delete(n.toString()),pr.resolve()}removeReference(t,e,n){return this.Ds.removeReference(n,e),this.xs.add(n.toString()),pr.resolve()}markPotentiallyOrphaned(t,e){return this.xs.add(e.toString()),pr.resolve()}removeTarget(t,e){this.Ds.cs(e.targetId).forEach((t=>this.xs.add(t.toString())));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(t,e.targetId).next((t=>{t.forEach((t=>this.xs.add(t.toString())))})).next((()=>n.removeTargetData(t,e)))}vs(){this.Cs=new Set}Vs(t){const e=this.persistence.getRemoteDocumentCache().newChangeBuffer();return pr.forEach(this.xs,(n=>{const r=it.fromPath(n);return this.ks(t,r).next((t=>{t||e.removeEntry(r)}))})).next((()=>(this.Cs=null,e.apply(t))))}updateLimboDocument(t,e){return this.ks(t,e).next((t=>{t?this.xs.delete(e.toString()):this.xs.add(e.toString())}))}Ps(t){return 0}ks(t,e){return pr.or([()=>pr.resolve(this.Ds.containsKey(e)),()=>this.persistence.getTargetCache().containsKey(t,e),()=>this.persistence.Ss(t,e)])}}function ni(t,e){return`firestore_clients_${t}_${e}`}function ri(t,e,n){let r=`firestore_mutations_${t}_${n}`;return e.isAuthenticated()&&(r+=`_${e.uid}`),r}function si(t,e){return`firestore_targets_${t}_${e}`}class ii{constructor(t,e,n,r){this.user=t,this.batchId=e,this.state=n,this.error=r}static $s(t,e,n){const r=JSON.parse(n);let s,i="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error);return i&&r.error&&(i="string"==typeof r.error.message&&"string"==typeof r.error.code,i&&(s=new T(r.error.code,r.error.message))),i?new ii(t,e,r.state,s):(g("SharedClientState",`Failed to parse mutation state for ID '${e}': ${n}`),null)}Os(){const t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)}}class oi{constructor(t,e,n){this.targetId=t,this.state=e,this.error=n}static $s(t,e){const n=JSON.parse(e);let r,s="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return s&&n.error&&(s="string"==typeof n.error.message&&"string"==typeof n.error.code,s&&(r=new T(n.error.code,n.error.message))),s?new oi(t,n.state,r):(g("SharedClientState",`Failed to parse target state for ID '${t}': ${e}`),null)}Os(){const t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)}}class ai{constructor(t,e){this.clientId=t,this.activeTargetIds=e}static $s(t,e){const n=JSON.parse(e);let r="object"==typeof n&&n.activeTargetIds instanceof Array,s=rn();for(let i=0;r&&i<n.activeTargetIds.length;++i)r=st(n.activeTargetIds[i]),s=s.add(n.activeTargetIds[i]);return r?new ai(t,s):(g("SharedClientState",`Failed to parse client data for instance '${t}': ${e}`),null)}}class ci{constructor(t,e){this.clientId=t,this.onlineState=e}static $s(t){const e=JSON.parse(t);return"object"==typeof e&&-1!==["Unknown","Online","Offline"].indexOf(e.onlineState)&&"string"==typeof e.clientId?new ci(e.clientId,e.onlineState):(g("SharedClientState",`Failed to parse online state: ${t}`),null)}}class ui{constructor(){this.activeTargetIds=rn()}Fs(t){this.activeTargetIds=this.activeTargetIds.add(t)}Ms(t){this.activeTargetIds=this.activeTargetIds.delete(t)}Os(){const t={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(t)}}class hi{constructor(t,e,n,r,s){this.window=t,this.Oe=e,this.persistenceKey=n,this.Ls=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.Bs=this.Us.bind(this),this.qs=new je(O),this.started=!1,this.Ks=[];const i=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=s,this.js=ni(this.persistenceKey,this.Ls),this.Qs=function(t){return`firestore_sequence_number_${t}`}(this.persistenceKey),this.qs=this.qs.insert(this.Ls,new ui),this.Ws=new RegExp(`^firestore_clients_${i}_([^_]*)$`),this.Gs=new RegExp(`^firestore_mutations_${i}_(\\d+)(?:_(.*))?$`),this.zs=new RegExp(`^firestore_targets_${i}_(\\d+)$`),this.Hs=function(t){return`firestore_online_state_${t}`}(this.persistenceKey),this.Js=function(t){return`firestore_bundle_loaded_${t}`}(this.persistenceKey),this.window.addEventListener("storage",this.Bs)}static bt(t){return!(!t||!t.localStorage)}async start(){const t=await this.syncEngine.pn();for(const n of t){if(n===this.Ls)continue;const t=this.getItem(ni(this.persistenceKey,n));if(t){const e=ai.$s(n,t);e&&(this.qs=this.qs.insert(e.clientId,e))}}this.Ys();const e=this.storage.getItem(this.Hs);if(e){const t=this.Xs(e);t&&this.Zs(t)}for(const n of this.Ks)this.Us(n);this.Ks=[],this.window.addEventListener("pagehide",(()=>this.shutdown())),this.started=!0}writeSequenceNumber(t){this.setItem(this.Qs,JSON.stringify(t))}getAllActiveQueryTargets(){return this.ti(this.qs)}isActiveQueryTarget(t){let e=!1;return this.qs.forEach(((n,r)=>{r.activeTargetIds.has(t)&&(e=!0)})),e}addPendingMutation(t){this.ei(t,"pending")}updateMutationState(t,e,n){this.ei(t,e,n),this.ni(t)}addLocalQueryTarget(t){let e="not-current";if(this.isActiveQueryTarget(t)){const n=this.storage.getItem(si(this.persistenceKey,t));if(n){const r=oi.$s(t,n);r&&(e=r.state)}}return this.si.Fs(t),this.Ys(),e}removeLocalQueryTarget(t){this.si.Ms(t),this.Ys()}isLocalQueryTarget(t){return this.si.activeTargetIds.has(t)}clearQueryState(t){this.removeItem(si(this.persistenceKey,t))}updateQueryState(t,e,n){this.ii(t,e,n)}handleUserChange(t,e,n){e.forEach((t=>{this.ni(t)})),this.currentUser=t,n.forEach((t=>{this.addPendingMutation(t)}))}setOnlineState(t){this.ri(t)}notifyBundleLoaded(){this.oi()}shutdown(){this.started&&(this.window.removeEventListener("storage",this.Bs),this.removeItem(this.js),this.started=!1)}getItem(t){const e=this.storage.getItem(t);return m("SharedClientState","READ",t,e),e}setItem(t,e){m("SharedClientState","SET",t,e),this.storage.setItem(t,e)}removeItem(t){m("SharedClientState","REMOVE",t),this.storage.removeItem(t)}Us(t){const e=t;if(e.storageArea===this.storage){if(m("SharedClientState","EVENT",e.key,e.newValue),e.key===this.js)return void g("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.Oe.enqueueRetryable((async()=>{if(this.started){if(null!==e.key)if(this.Ws.test(e.key)){if(null==e.newValue){const t=this.ci(e.key);return this.ai(t,null)}{const t=this.ui(e.key,e.newValue);if(t)return this.ai(t.clientId,t)}}else if(this.Gs.test(e.key)){if(null!==e.newValue){const t=this.hi(e.key,e.newValue);if(t)return this.li(t)}}else if(this.zs.test(e.key)){if(null!==e.newValue){const t=this.fi(e.key,e.newValue);if(t)return this.di(t)}}else if(e.key===this.Hs){if(null!==e.newValue){const t=this.Xs(e.newValue);if(t)return this.Zs(t)}}else if(e.key===this.Qs){const t=function(t){let e=C.T;if(null!=t)try{const n=JSON.parse(t);v("number"==typeof n),e=n}catch(t){g("SharedClientState","Failed to read sequence number from WebStorage",t)}return e}(e.newValue);t!==C.T&&this.sequenceNumberHandler(t)}else if(e.key===this.Js)return this.syncEngine.wi()}else this.Ks.push(e)}))}}get si(){return this.qs.get(this.Ls)}Ys(){this.setItem(this.js,this.si.Os())}ei(t,e,n){const r=new ii(this.currentUser,t,e,n),s=ri(this.persistenceKey,this.currentUser,t);this.setItem(s,r.Os())}ni(t){const e=ri(this.persistenceKey,this.currentUser,t);this.removeItem(e)}ri(t){const e={clientId:this.Ls,onlineState:t};this.storage.setItem(this.Hs,JSON.stringify(e))}ii(t,e,n){const r=si(this.persistenceKey,t),s=new oi(t,e,n);this.setItem(r,s.Os())}oi(){this.setItem(this.Js,"value-not-used")}ci(t){const e=this.Ws.exec(t);return e?e[1]:null}ui(t,e){const n=this.ci(t);return ai.$s(n,e)}hi(t,e){const n=this.Gs.exec(t),r=Number(n[1]),s=void 0!==n[2]?n[2]:null;return ii.$s(new u(s),r,e)}fi(t,e){const n=this.zs.exec(t),r=Number(n[1]);return oi.$s(r,e)}Xs(t){return ci.$s(t)}async li(t){if(t.user.uid===this.currentUser.uid)return this.syncEngine._i(t.batchId,t.state,t.error);m("SharedClientState",`Ignoring mutation for non-active user ${t.user.uid}`)}di(t){return this.syncEngine.mi(t.targetId,t.state,t.error)}ai(t,e){const n=e?this.qs.insert(t,e):this.qs.remove(t),r=this.ti(this.qs),s=this.ti(n),i=[],o=[];return s.forEach((t=>{r.has(t)||i.push(t)})),r.forEach((t=>{s.has(t)||o.push(t)})),this.syncEngine.gi(i,o).then((()=>{this.qs=n}))}Zs(t){this.qs.get(t.clientId)&&this.onlineStateHandler(t.onlineState)}ti(t){let e=rn();return t.forEach(((t,n)=>{e=e.unionWith(n.activeTargetIds)})),e}}class li{constructor(){this.yi=new ui,this.pi={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(t){}updateMutationState(t,e,n){}addLocalQueryTarget(t){return this.yi.Fs(t),this.pi[t]||"not-current"}updateQueryState(t,e,n){this.pi[t]=e}removeLocalQueryTarget(t){this.yi.Ms(t)}isLocalQueryTarget(t){return this.yi.activeTargetIds.has(t)}clearQueryState(t){delete this.pi[t]}getAllActiveQueryTargets(){return this.yi.activeTargetIds}isActiveQueryTarget(t){return this.yi.activeTargetIds.has(t)}start(){return this.yi=new ui,Promise.resolve()}handleUserChange(t,e,n){}setOnlineState(t){}shutdown(){}writeSequenceNumber(t){}notifyBundleLoaded(){}}class di{Ti(t){}shutdown(){}}class fi{constructor(){this.Ei=()=>this.Ii(),this.Ai=()=>this.Ri(),this.bi=[],this.Pi()}Ti(t){this.bi.push(t)}shutdown(){window.removeEventListener("online",this.Ei),window.removeEventListener("offline",this.Ai)}Pi(){window.addEventListener("online",this.Ei),window.addEventListener("offline",this.Ai)}Ii(){m("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const t of this.bi)t(0)}Ri(){m("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const t of this.bi)t(1)}static bt(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}const mi={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery"};class gi{constructor(t){this.vi=t.vi,this.Vi=t.Vi}Si(t){this.Di=t}Ci(t){this.Ni=t}onMessage(t){this.xi=t}close(){this.Vi()}send(t){this.vi(t)}ki(){this.Di()}$i(t){this.Ni(t)}Oi(t){this.xi(t)}}class pi extends class{constructor(t){this.databaseInfo=t,this.databaseId=t.databaseId;const e=t.ssl?"https":"http";this.Fi=e+"://"+t.host,this.Mi="projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database+"/documents"}Li(t,e,n,r){const s=this.Bi(t,e);m("RestConnection","Sending: ",s,n);const i={};return this.Ui(i,r),this.qi(t,s,i,n).then((t=>(m("RestConnection","Received: ",t),t)),(e=>{throw p("RestConnection",`${t} failed with error: `,e,"url: ",s,"request:",n),e}))}Ki(t,e,n,r){return this.Li(t,e,n,r)}Ui(t,e){if(t["X-Goog-Api-Client"]="gl-js/ fire/"+h,t["Content-Type"]="text/plain",this.databaseInfo.appId&&(t["X-Firebase-GMPID"]=this.databaseInfo.appId),e)for(const n in e.authHeaders)e.authHeaders.hasOwnProperty(n)&&(t[n]=e.authHeaders[n])}Bi(t,e){const n=mi[t];return`${this.Fi}/v1/${e}:${n}`}}{constructor(t){super(t),this.forceLongPolling=t.forceLongPolling,this.autoDetectLongPolling=t.autoDetectLongPolling,this.useFetchStreams=t.useFetchStreams}qi(t,e,n,r){return new Promise(((s,i)=>{const o=new a.g;o.listenOnce(a.c.COMPLETE,(()=>{try{switch(o.getLastErrorCode()){case a.a.NO_ERROR:const e=o.getResponseJson();m("Connection","XHR received:",JSON.stringify(e)),s(e);break;case a.a.TIMEOUT:m("Connection",'RPC "'+t+'" timed out'),i(new T(E.DEADLINE_EXCEEDED,"Request time out"));break;case a.a.HTTP_ERROR:const n=o.getStatus();if(m("Connection",'RPC "'+t+'" failed with status:',n,"response text:",o.getResponseText()),n>0){const t=o.getResponseJson().error;if(t&&t.status&&t.message){const e=function(t){const e=t.toLowerCase().replace(/_/g,"-");return Object.values(E).indexOf(e)>=0?e:E.UNKNOWN}(t.status);i(new T(e,t.message))}else i(new T(E.UNKNOWN,"Server responded with status "+o.getStatus()))}else i(new T(E.UNAVAILABLE,"Connection failed."));break;default:w()}}finally{m("Connection",'RPC "'+t+'" completed.')}}));const c=JSON.stringify(r);o.send(e,"POST",c,n,15)}))}ji(t,e){const n=[this.Fi,"/","google.firestore.v1.Firestore","/",t,"/channel"],r=Object(a.h)(),s=Object(a.i)(),i={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling};this.useFetchStreams&&(i.xmlHttpFactory=new a.d({})),this.Ui(i.initMessageHeaders,e),Object(o.s)()||Object(o.u)()||Object(o.o)()||Object(o.q)()||Object(o.w)()||Object(o.n)()||(i.httpHeadersOverwriteParam="$httpHeaders");const c=n.join("");m("Connection","Creating WebChannel: "+c,i);const u=r.createWebChannel(c,i);let h=!1,l=!1;const d=new gi({vi:t=>{l?m("Connection","Not sending because WebChannel is closed:",t):(h||(m("Connection","Opening WebChannel transport."),u.open(),h=!0),m("Connection","WebChannel sending:",t),u.send(t))},Vi:()=>u.close()}),f=(t,e,n)=>{t.listen(e,(t=>{try{n(t)}catch(t){setTimeout((()=>{throw t}),0)}}))};return f(u,a.f.EventType.OPEN,(()=>{l||m("Connection","WebChannel transport opened.")})),f(u,a.f.EventType.CLOSE,(()=>{l||(l=!0,m("Connection","WebChannel transport closed"),d.$i())})),f(u,a.f.EventType.ERROR,(t=>{l||(l=!0,p("Connection","WebChannel transport errored:",t),d.$i(new T(E.UNAVAILABLE,"The operation could not be completed")))})),f(u,a.f.EventType.MESSAGE,(t=>{var e;if(!l){const n=t.data[0];v(!!n);const r=n,s=r.error||(null===(e=r[0])||void 0===e?void 0:e.error);if(s){m("Connection","WebChannel received error:",s);const t=s.status;let e=function(t){const e=Ue[t];if(void 0!==e)return Ke(e)}(t),n=s.message;void 0===e&&(e=E.INTERNAL,n="Unknown error status: "+t+" with message "+s.message),l=!0,d.$i(new T(e,n)),u.close()}else m("Connection","WebChannel received:",n),d.Oi(n)}})),f(s,a.b.STAT_EVENT,(t=>{t.stat===a.e.PROXY?m("Connection","Detected buffering proxy"):t.stat===a.e.NOPROXY&&m("Connection","Detected no buffering proxy")})),setTimeout((()=>{d.ki()}),0),d}}function yi(){return"undefined"!=typeof window?window:null}function wi(){return"undefined"!=typeof document?document:null}function vi(t){return new pn(t,!0)}class Ii{constructor(t,e,n=1e3,r=1.5,s=6e4){this.Oe=t,this.timerId=e,this.Qi=n,this.Wi=r,this.Gi=s,this.zi=0,this.Hi=null,this.Ji=Date.now(),this.reset()}reset(){this.zi=0}Yi(){this.zi=this.Gi}Xi(t){this.cancel();const e=Math.floor(this.zi+this.Zi()),n=Math.max(0,Date.now()-this.Ji),r=Math.max(0,e-n);r>0&&m("ExponentialBackoff",`Backing off for ${r} ms (base delay: ${this.zi} ms, delay with jitter: ${e} ms, last attempt: ${n} ms ago)`),this.Hi=this.Oe.enqueueAfterDelay(this.timerId,r,(()=>(this.Ji=Date.now(),t()))),this.zi*=this.Wi,this.zi<this.Qi&&(this.zi=this.Qi),this.zi>this.Gi&&(this.zi=this.Gi)}tr(){null!==this.Hi&&(this.Hi.skipDelay(),this.Hi=null)}cancel(){null!==this.Hi&&(this.Hi.cancel(),this.Hi=null)}Zi(){return(Math.random()-.5)*this.zi}}class bi{constructor(t,e,n,r,s,i,o){this.Oe=t,this.er=n,this.nr=r,this.sr=s,this.credentialsProvider=i,this.listener=o,this.state=0,this.ir=0,this.rr=null,this.cr=null,this.stream=null,this.ar=new Ii(t,e)}ur(){return 1===this.state||5===this.state||this.hr()}hr(){return 2===this.state||3===this.state}start(){4!==this.state?this.auth():this.lr()}async stop(){this.ur()&&await this.close(0)}dr(){this.state=0,this.ar.reset()}wr(){this.hr()&&null===this.rr&&(this.rr=this.Oe.enqueueAfterDelay(this.er,6e4,(()=>this._r())))}mr(t){this.gr(),this.stream.send(t)}async _r(){if(this.hr())return this.close(0)}gr(){this.rr&&(this.rr.cancel(),this.rr=null)}yr(){this.cr&&(this.cr.cancel(),this.cr=null)}async close(t,e){this.gr(),this.yr(),this.ar.cancel(),this.ir++,4!==t?this.ar.reset():e&&e.code===E.RESOURCE_EXHAUSTED?(g(e.toString()),g("Using maximum backoff delay to prevent overloading the backend."),this.ar.Yi()):e&&e.code===E.UNAUTHENTICATED&&3!==this.state&&this.credentialsProvider.invalidateToken(),null!==this.stream&&(this.pr(),this.stream.close(),this.stream=null),this.state=t,await this.listener.Ci(e)}pr(){}auth(){this.state=1;const t=this.Tr(this.ir),e=this.ir;this.credentialsProvider.getToken().then((t=>{this.ir===e&&this.Er(t)}),(e=>{t((()=>{const t=new T(E.UNKNOWN,"Fetching auth token failed: "+e.message);return this.Ir(t)}))}))}Er(t){const e=this.Tr(this.ir);this.stream=this.Ar(t),this.stream.Si((()=>{e((()=>(this.state=2,this.cr=this.Oe.enqueueAfterDelay(this.nr,1e4,(()=>(this.hr()&&(this.state=3),Promise.resolve()))),this.listener.Si())))})),this.stream.Ci((t=>{e((()=>this.Ir(t)))})),this.stream.onMessage((t=>{e((()=>this.onMessage(t)))}))}lr(){this.state=5,this.ar.Xi((async()=>{this.state=0,this.start()}))}Ir(t){return m("PersistentStream",`close with error: ${t}`),this.stream=null,this.close(4,t)}Tr(t){return e=>{this.Oe.enqueueAndForget((()=>this.ir===t?e():(m("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve())))}}}class Ei extends bi{constructor(t,e,n,r,s){super(t,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",e,n,s),this.N=r}Ar(t){return this.sr.ji("Listen",t)}onMessage(t){this.ar.reset();const e=function(t,e){let n;if("targetChange"in e){e.targetChange;const r=function(t){return"NO_CHANGE"===t?0:"ADD"===t?1:"REMOVE"===t?2:"CURRENT"===t?3:"RESET"===t?4:w()}(e.targetChange.targetChangeType||"NO_CHANGE"),s=e.targetChange.targetIds||[],i=function(t,e){return t.D?(v(void 0===e||"string"==typeof e),H.fromBase64String(e||"")):(v(void 0===e||e instanceof Uint8Array),H.fromUint8Array(e||new Uint8Array))}(t,e.targetChange.resumeToken),o=e.targetChange.cause,a=o&&function(t){const e=void 0===t.code?E.UNKNOWN:Ke(t.code);return new T(e,t.message||"")}(o);n=new un(r,s,i,a||null)}else if("documentChange"in e){e.documentChange;const r=e.documentChange;r.document,r.document.name,r.document.updateTime;const s=Sn(t,r.document.name),i=In(r.document.updateTime),o=new It({mapValue:{fields:r.document.fields}}),a=Et.newFoundDocument(s,i,o),c=r.targetIds||[],u=r.removedTargetIds||[];n=new an(c,u,a.key,a)}else if("documentDelete"in e){e.documentDelete;const r=e.documentDelete;r.document;const s=Sn(t,r.document),i=r.readTime?In(r.readTime):P.min(),o=Et.newNoDocument(s,i),a=r.removedTargetIds||[];n=new an([],a,o.key,o)}else if("documentRemove"in e){e.documentRemove;const r=e.documentRemove;r.document;const s=Sn(t,r.document),i=r.removedTargetIds||[];n=new an([],i,s,null)}else{if(!("filter"in e))return w();{e.filter;const t=e.filter;t.targetId;const r=t.count||0,s=new Pe(r),i=t.targetId;n=new cn(i,s)}}return n}(this.N,t),n=function(t){if(!("targetChange"in t))return P.min();const e=t.targetChange;return e.targetIds&&e.targetIds.length?P.min():e.readTime?In(e.readTime):P.min()}(t);return this.listener.Rr(e,n)}br(t){const e={};e.database=Dn(this.N),e.addTarget=function(t,e){let n;const r=e.target;return n=Dt(r)?{documents:Rn(t,r)}:{query:On(t,r)},n.targetId=e.targetId,e.resumeToken.approximateByteSize()>0?n.resumeToken=wn(t,e.resumeToken):e.snapshotVersion.compareTo(P.min())>0&&(n.readTime=yn(t,e.snapshotVersion.toTimestamp())),n}(this.N,t);const n=function(t,e){const n=function(t,e){switch(e){case 0:return null;case 1:return"existence-filter-mismatch";case 2:return"limbo-document";default:return w()}}(0,e.purpose);return null==n?null:{"goog-listen-tags":n}}(this.N,t);n&&(e.labels=n),this.mr(e)}Pr(t){const e={};e.database=Dn(this.N),e.removeTarget=t,this.mr(e)}}class Ti extends bi{constructor(t,e,n,r,s){super(t,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",e,n,s),this.N=r,this.vr=!1}get Vr(){return this.vr}start(){this.vr=!1,this.lastStreamToken=void 0,super.start()}pr(){this.vr&&this.Sr([])}Ar(t){return this.sr.ji("Write",t)}onMessage(t){if(v(!!t.streamToken),this.lastStreamToken=t.streamToken,this.vr){this.ar.reset();const e=function(t,e){return t&&t.length>0?(v(void 0!==e),t.map((t=>function(t,e){let n=t.updateTime?In(t.updateTime):In(e);return n.isEqual(P.min())&&(n=In(e)),new Ee(n,t.transformResults||[])}(t,e)))):[]}(t.writeResults,t.commitTime),n=In(t.commitTime);return this.listener.Dr(n,e)}return v(!t.writeResults||0===t.writeResults.length),this.vr=!0,this.listener.Cr()}Nr(){const t={};t.database=Dn(this.N),this.mr(t)}Sr(t){const e={streamToken:this.lastStreamToken,writes:t.map((t=>Cn(this.N,t)))};this.mr(e)}}class Si extends class{}{constructor(t,e,n){super(),this.credentials=t,this.sr=e,this.N=n,this.kr=!1}$r(){if(this.kr)throw new T(E.FAILED_PRECONDITION,"The client has already been terminated.")}Li(t,e,n){return this.$r(),this.credentials.getToken().then((r=>this.sr.Li(t,e,n,r))).catch((t=>{throw"FirebaseError"===t.name?(t.code===E.UNAUTHENTICATED&&this.credentials.invalidateToken(),t):new T(E.UNKNOWN,t.toString())}))}Ki(t,e,n){return this.$r(),this.credentials.getToken().then((r=>this.sr.Ki(t,e,n,r))).catch((t=>{throw"FirebaseError"===t.name?(t.code===E.UNAUTHENTICATED&&this.credentials.invalidateToken(),t):new T(E.UNKNOWN,t.toString())}))}terminate(){this.kr=!0}}class Ni{constructor(t,e){this.asyncQueue=t,this.onlineStateHandler=e,this.state="Unknown",this.Or=0,this.Fr=null,this.Mr=!0}Lr(){0===this.Or&&(this.Br("Unknown"),this.Fr=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,(()=>(this.Fr=null,this.Ur("Backend didn't respond within 10 seconds."),this.Br("Offline"),Promise.resolve()))))}qr(t){"Online"===this.state?this.Br("Unknown"):(this.Or++,this.Or>=1&&(this.Kr(),this.Ur(`Connection failed 1 times. Most recent error: ${t.toString()}`),this.Br("Offline")))}set(t){this.Kr(),this.Or=0,"Online"===t&&(this.Mr=!1),this.Br(t)}Br(t){t!==this.state&&(this.state=t,this.onlineStateHandler(t))}Ur(t){const e=`Could not reach Cloud Firestore backend. ${t}\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.Mr?(g(e),this.Mr=!1):m("OnlineStateTracker",e)}Kr(){null!==this.Fr&&(this.Fr.cancel(),this.Fr=null)}}class _i{constructor(t,e,n,r,s){this.localStore=t,this.datastore=e,this.asyncQueue=n,this.remoteSyncer={},this.jr=[],this.Qr=new Map,this.Wr=new Set,this.Gr=[],this.zr=s,this.zr.Ti((t=>{n.enqueueAndForget((async()=>{Fi(this)&&(m("RemoteStore","Restarting streams for network reachability change."),await async function(t){const e=b(t);e.Wr.add(4),await Ai(e),e.Hr.set("Unknown"),e.Wr.delete(4),await Di(e)}(this))}))})),this.Hr=new Ni(n,r)}}async function Di(t){if(Fi(t))for(const e of t.Gr)await e(!0)}async function Ai(t){for(const e of t.Gr)await e(!1)}function ki(t,e){const n=b(t);n.Qr.has(e.targetId)||(n.Qr.set(e.targetId,e),Oi(n)?Ri(n):Xi(n).hr()&&Ci(n,e))}function xi(t,e){const n=b(t),r=Xi(n);n.Qr.delete(e),r.hr()&&Li(n,e),0===n.Qr.size&&(r.hr()?r.wr():Fi(n)&&n.Hr.set("Unknown"))}function Ci(t,e){t.Jr.Y(e.targetId),Xi(t).br(e)}function Li(t,e){t.Jr.Y(e),Xi(t).Pr(e)}function Ri(t){t.Jr=new ln({getRemoteKeysForTarget:e=>t.remoteSyncer.getRemoteKeysForTarget(e),Tt:e=>t.Qr.get(e)||null}),Xi(t).start(),t.Hr.Lr()}function Oi(t){return Fi(t)&&!Xi(t).ur()&&t.Qr.size>0}function Fi(t){return 0===b(t).Wr.size}function Mi(t){t.Jr=void 0}async function Vi(t){t.Qr.forEach(((e,n)=>{Ci(t,e)}))}async function Pi(t,e){Mi(t),Oi(t)?(t.Hr.qr(e),Ri(t)):t.Hr.set("Unknown")}async function Ui(t,e,n){if(t.Hr.set("Online"),e instanceof un&&2===e.state&&e.cause)try{await async function(t,e){const n=e.cause;for(const r of e.targetIds)t.Qr.has(r)&&(await t.remoteSyncer.rejectListen(r,n),t.Qr.delete(r),t.Jr.removeTarget(r))}(t,e)}catch(n){m("RemoteStore","Failed to remove targets %s: %s ",e.targetIds.join(","),n),await qi(t,n)}else if(e instanceof an?t.Jr.rt(e):e instanceof cn?t.Jr.ft(e):t.Jr.at(e),!n.isEqual(P.min()))try{const e=await Vs(t.localStore);n.compareTo(e)>=0&&await function(t,e){const n=t.Jr._t(e);return n.targetChanges.forEach(((n,r)=>{if(n.resumeToken.approximateByteSize()>0){const s=t.Qr.get(r);s&&t.Qr.set(r,s.withResumeToken(n.resumeToken,e))}})),n.targetMismatches.forEach((e=>{const n=t.Qr.get(e);if(!n)return;t.Qr.set(e,n.withResumeToken(H.EMPTY_BYTE_STRING,n.snapshotVersion)),Li(t,e);const r=new xr(n.target,e,1,n.sequenceNumber);Ci(t,r)})),t.remoteSyncer.applyRemoteEvent(n)}(t,n)}catch(e){m("RemoteStore","Failed to raise snapshot:",e),await qi(t,e)}}async function qi(t,e,n){if(!br(e))throw e;t.Wr.add(1),await Ai(t),t.Hr.set("Offline"),n||(n=()=>Vs(t.localStore)),t.asyncQueue.enqueueRetryable((async()=>{m("RemoteStore","Retrying IndexedDB access"),await n(),t.Wr.delete(1),await Di(t)}))}function Bi(t,e){return e().catch((n=>qi(t,n,e)))}async function Ki(t){const e=b(t),n=Zi(e);let r=e.jr.length>0?e.jr[e.jr.length-1].batchId:-1;for(;ji(e);)try{const t=await Us(e.localStore,r);if(null===t){0===e.jr.length&&n.wr();break}r=t.batchId,$i(e,t)}catch(t){await qi(e,t)}zi(e)&&Gi(e)}function ji(t){return Fi(t)&&t.jr.length<10}function $i(t,e){t.jr.push(e);const n=Zi(t);n.hr()&&n.Vr&&n.Sr(e.mutations)}function zi(t){return Fi(t)&&!Zi(t).ur()&&t.jr.length>0}function Gi(t){Zi(t).start()}async function Qi(t){Zi(t).Nr()}async function Hi(t){const e=Zi(t);for(const n of t.jr)e.Sr(n.mutations)}async function Wi(t,e,n){const r=t.jr.shift(),s=kr.from(r,e,n);await Bi(t,(()=>t.remoteSyncer.applySuccessfulWrite(s))),await Ki(t)}async function Yi(t,e){e&&Zi(t).Vr&&await async function(t,e){if(Be(n=e.code)&&n!==E.ABORTED){const n=t.jr.shift();Zi(t).dr(),await Bi(t,(()=>t.remoteSyncer.rejectFailedWrite(n.batchId,e))),await Ki(t)}var n}(t,e),zi(t)&&Gi(t)}async function Ji(t,e){const n=b(t);e?(n.Wr.delete(2),await Di(n)):e||(n.Wr.add(2),await Ai(n),n.Hr.set("Unknown"))}function Xi(t){return t.Yr||(t.Yr=function(t,e,n){const r=b(t);return r.$r(),new Ei(e,r.sr,r.credentials,r.N,n)}(t.datastore,t.asyncQueue,{Si:Vi.bind(null,t),Ci:Pi.bind(null,t),Rr:Ui.bind(null,t)}),t.Gr.push((async e=>{e?(t.Yr.dr(),Oi(t)?Ri(t):t.Hr.set("Unknown")):(await t.Yr.stop(),Mi(t))}))),t.Yr}function Zi(t){return t.Xr||(t.Xr=function(t,e,n){const r=b(t);return r.$r(),new Ti(e,r.sr,r.credentials,r.N,n)}(t.datastore,t.asyncQueue,{Si:Qi.bind(null,t),Ci:Yi.bind(null,t),Cr:Hi.bind(null,t),Dr:Wi.bind(null,t)}),t.Gr.push((async e=>{e?(t.Xr.dr(),await Ki(t)):(await t.Xr.stop(),t.jr.length>0&&(m("RemoteStore",`Stopping write stream with ${t.jr.length} pending writes`),t.jr=[]))}))),t.Xr}class to{constructor(t,e,n,r,s){this.asyncQueue=t,this.timerId=e,this.targetTimeMs=n,this.op=r,this.removalCallback=s,this.deferred=new S,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch((t=>{}))}static createAndSchedule(t,e,n,r,s){const i=Date.now()+n,o=new to(t,e,i,r,s);return o.start(n),o}start(t){this.timerHandle=setTimeout((()=>this.handleDelayElapsed()),t)}skipDelay(){return this.handleDelayElapsed()}cancel(t){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new T(E.CANCELLED,"Operation cancelled"+(t?": "+t:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget((()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then((t=>this.deferred.resolve(t)))):Promise.resolve()))}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function eo(t,e){if(g("AsyncQueue",`${e}: ${t}`),br(t))return new T(E.UNAVAILABLE,`${e}: ${t}`);throw t}class no{constructor(t){this.comparator=t?(e,n)=>t(e,n)||it.comparator(e.key,n.key):(t,e)=>it.comparator(t.key,e.key),this.keyedMap=Je(),this.sortedSet=new je(this.comparator)}static emptySet(t){return new no(t.comparator)}has(t){return null!=this.keyedMap.get(t)}get(t){return this.keyedMap.get(t)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(t){const e=this.keyedMap.get(t);return e?this.sortedSet.indexOf(e):-1}get size(){return this.sortedSet.size}forEach(t){this.sortedSet.inorderTraversal(((e,n)=>(t(e),!1)))}add(t){const e=this.delete(t.key);return e.copy(e.keyedMap.insert(t.key,t),e.sortedSet.insert(t,null))}delete(t){const e=this.get(t);return e?this.copy(this.keyedMap.remove(t),this.sortedSet.remove(e)):this}isEqual(t){if(!(t instanceof no))return!1;if(this.size!==t.size)return!1;const e=this.sortedSet.getIterator(),n=t.sortedSet.getIterator();for(;e.hasNext();){const t=e.getNext().key,r=n.getNext().key;if(!t.isEqual(r))return!1}return!0}toString(){const t=[];return this.forEach((e=>{t.push(e.toString())})),0===t.length?"DocumentSet ()":"DocumentSet (\n  "+t.join("  \n")+"\n)"}copy(t,e){const n=new no;return n.comparator=this.comparator,n.keyedMap=t,n.sortedSet=e,n}}class ro{constructor(){this.Zr=new je(it.comparator)}track(t){const e=t.doc.key,n=this.Zr.get(e);n?0!==t.type&&3===n.type?this.Zr=this.Zr.insert(e,t):3===t.type&&1!==n.type?this.Zr=this.Zr.insert(e,{type:n.type,doc:t.doc}):2===t.type&&2===n.type?this.Zr=this.Zr.insert(e,{type:2,doc:t.doc}):2===t.type&&0===n.type?this.Zr=this.Zr.insert(e,{type:0,doc:t.doc}):1===t.type&&0===n.type?this.Zr=this.Zr.remove(e):1===t.type&&2===n.type?this.Zr=this.Zr.insert(e,{type:1,doc:n.doc}):0===t.type&&1===n.type?this.Zr=this.Zr.insert(e,{type:2,doc:t.doc}):w():this.Zr=this.Zr.insert(e,t)}eo(){const t=[];return this.Zr.inorderTraversal(((e,n)=>{t.push(n)})),t}}class so{constructor(t,e,n,r,s,i,o,a){this.query=t,this.docs=e,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=s,this.fromCache=i,this.syncStateChanged=o,this.excludesMetadataChanges=a}static fromInitialDocuments(t,e,n,r){const s=[];return e.forEach((t=>{s.push({type:0,doc:t})})),new so(t,e,no.emptySet(e),s,n,r,!0,!1)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(t){if(!(this.fromCache===t.fromCache&&this.syncStateChanged===t.syncStateChanged&&this.mutatedKeys.isEqual(t.mutatedKeys)&&te(this.query,t.query)&&this.docs.isEqual(t.docs)&&this.oldDocs.isEqual(t.oldDocs)))return!1;const e=this.docChanges,n=t.docChanges;if(e.length!==n.length)return!1;for(let r=0;r<e.length;r++)if(e[r].type!==n[r].type||!e[r].doc.isEqual(n[r].doc))return!1;return!0}}class io{constructor(){this.no=void 0,this.listeners=[]}}class oo{constructor(){this.queries=new ps((t=>ee(t)),te),this.onlineState="Unknown",this.so=new Set}}async function ao(t,e){const n=b(t),r=e.query;let s=!1,i=n.queries.get(r);if(i||(s=!0,i=new io),s)try{i.no=await n.onListen(r)}catch(t){const n=eo(t,`Initialization of query '${ne(e.query)}' failed`);return void e.onError(n)}n.queries.set(r,i),i.listeners.push(e),e.io(n.onlineState),i.no&&e.ro(i.no)&&lo(n)}async function co(t,e){const n=b(t),r=e.query;let s=!1;const i=n.queries.get(r);if(i){const t=i.listeners.indexOf(e);t>=0&&(i.listeners.splice(t,1),s=0===i.listeners.length)}if(s)return n.queries.delete(r),n.onUnlisten(r)}function uo(t,e){const n=b(t);let r=!1;for(const s of e){const t=s.query,e=n.queries.get(t);if(e){for(const t of e.listeners)t.ro(s)&&(r=!0);e.no=s}}r&&lo(n)}function ho(t,e,n){const r=b(t),s=r.queries.get(e);if(s)for(const i of s.listeners)i.onError(n);r.queries.delete(e)}function lo(t){t.so.forEach((t=>{t.next()}))}class fo{constructor(t,e,n){this.query=t,this.oo=e,this.co=!1,this.ao=null,this.onlineState="Unknown",this.options=n||{}}ro(t){if(!this.options.includeMetadataChanges){const e=[];for(const n of t.docChanges)3!==n.type&&e.push(n);t=new so(t.query,t.docs,t.oldDocs,e,t.mutatedKeys,t.fromCache,t.syncStateChanged,!0)}let e=!1;return this.co?this.uo(t)&&(this.oo.next(t),e=!0):this.ho(t,this.onlineState)&&(this.lo(t),e=!0),this.ao=t,e}onError(t){this.oo.error(t)}io(t){this.onlineState=t;let e=!1;return this.ao&&!this.co&&this.ho(this.ao,t)&&(this.lo(this.ao),e=!0),e}ho(t,e){if(!t.fromCache)return!0;const n="Offline"!==e;return(!this.options.fo||!n)&&(!t.docs.isEmpty()||"Offline"===e)}uo(t){if(t.docChanges.length>0)return!0;const e=this.ao&&this.ao.hasPendingWrites!==t.hasPendingWrites;return!(!t.syncStateChanged&&!e)&&!0===this.options.includeMetadataChanges}lo(t){t=so.fromInitialDocuments(t.query,t.docs,t.mutatedKeys,t.fromCache),this.co=!0,this.oo.next(t)}}class mo{constructor(t,e){this.payload=t,this.byteLength=e}wo(){return"metadata"in this.payload}}class go{constructor(t){this.N=t}zn(t){return Sn(this.N,t)}Hn(t){return t.metadata.exists?xn(this.N,t.document,!1):Et.newNoDocument(this.zn(t.metadata.name),this.Jn(t.metadata.readTime))}Jn(t){return In(t)}}class po{constructor(t,e,n){this._o=t,this.localStore=e,this.N=n,this.queries=[],this.documents=[],this.progress=yo(t)}mo(t){this.progress.bytesLoaded+=t.byteLength;let e=this.progress.documentsLoaded;return t.payload.namedQuery?this.queries.push(t.payload.namedQuery):t.payload.documentMetadata?(this.documents.push({metadata:t.payload.documentMetadata}),t.payload.documentMetadata.exists||++e):t.payload.document&&(this.documents[this.documents.length-1].document=t.payload.document,++e),e!==this.progress.documentsLoaded?(this.progress.documentsLoaded=e,Object.assign({},this.progress)):null}yo(t){const e=new Map,n=new go(this.N);for(const r of t)if(r.metadata.queries){const t=n.zn(r.metadata.name);for(const n of r.metadata.queries){const r=(e.get(n)||en()).add(t);e.set(n,r)}}return e}async complete(){const t=await async function(t,e,n,r){const s=b(t);let i=en(),o=We(),a=Ze();for(const h of n){const t=e.zn(h.metadata.name);h.document&&(i=i.add(t)),o=o.insert(t,e.Hn(h)),a=a.insert(t,e.Jn(h.metadata.readTime))}const c=s.jn.newChangeBuffer({trackRemovals:!0}),u=await qs(s,function(t){return Xt(zt(j.fromString(`__bundle__/docs/${t}`)))}(r));return s.persistence.runTransaction("Apply bundle documents","readwrite",(t=>Ps(t,c,o,P.min(),a).next((e=>(c.apply(t),e))).next((e=>s.ze.removeMatchingKeysForTargetId(t,u.targetId).next((()=>s.ze.addMatchingKeys(t,i,u.targetId))).next((()=>s.Qn.vn(t,e))).next((()=>e))))))}(this.localStore,new go(this.N),this.documents,this._o.id),e=this.yo(this.documents);for(const n of this.queries)await zs(this.localStore,n,e.get(n.name));return this.progress.taskState="Success",new xs(Object.assign({},this.progress),t)}}function yo(t){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:t.totalDocuments,totalBytes:t.totalBytes}}class wo{constructor(t){this.key=t}}class vo{constructor(t){this.key=t}}class Io{constructor(t,e){this.query=t,this.po=e,this.To=null,this.current=!1,this.Eo=en(),this.mutatedKeys=en(),this.Io=se(t),this.Ao=new no(this.Io)}get Ro(){return this.po}bo(t,e){const n=e?e.Po:new ro,r=e?e.Ao:this.Ao;let s=e?e.mutatedKeys:this.mutatedKeys,i=r,o=!1;const a=Gt(this.query)&&r.size===this.query.limit?r.last():null,c=Qt(this.query)&&r.size===this.query.limit?r.first():null;if(t.inorderTraversal(((t,e)=>{const u=r.get(t),h=re(this.query,e)?e:null,l=!!u&&this.mutatedKeys.has(u.key),d=!!h&&(h.hasLocalMutations||this.mutatedKeys.has(h.key)&&h.hasCommittedMutations);let f=!1;u&&h?u.data.isEqual(h.data)?l!==d&&(n.track({type:3,doc:h}),f=!0):this.vo(u,h)||(n.track({type:2,doc:h}),f=!0,(a&&this.Io(h,a)>0||c&&this.Io(h,c)<0)&&(o=!0)):!u&&h?(n.track({type:0,doc:h}),f=!0):u&&!h&&(n.track({type:1,doc:u}),f=!0,(a||c)&&(o=!0)),f&&(h?(i=i.add(h),s=d?s.add(t):s.delete(t)):(i=i.delete(t),s=s.delete(t)))})),Gt(this.query)||Qt(this.query))for(;i.size>this.query.limit;){const t=Gt(this.query)?i.last():i.first();i=i.delete(t.key),s=s.delete(t.key),n.track({type:1,doc:t})}return{Ao:i,Po:n,Ln:o,mutatedKeys:s}}vo(t,e){return t.hasLocalMutations&&e.hasCommittedMutations&&!e.hasLocalMutations}applyChanges(t,e,n){const r=this.Ao;this.Ao=t.Ao,this.mutatedKeys=t.mutatedKeys;const s=t.Po.eo();s.sort(((t,e)=>function(t,e){const n=t=>{switch(t){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return w()}};return n(t)-n(e)}(t.type,e.type)||this.Io(t.doc,e.doc))),this.Vo(n);const i=e?this.So():[],o=0===this.Eo.size&&this.current?1:0,a=o!==this.To;return this.To=o,0!==s.length||a?{snapshot:new so(this.query,t.Ao,r,s,t.mutatedKeys,0===o,a,!1),Do:i}:{Do:i}}io(t){return this.current&&"Offline"===t?(this.current=!1,this.applyChanges({Ao:this.Ao,Po:new ro,mutatedKeys:this.mutatedKeys,Ln:!1},!1)):{Do:[]}}Co(t){return!this.po.has(t)&&!!this.Ao.has(t)&&!this.Ao.get(t).hasLocalMutations}Vo(t){t&&(t.addedDocuments.forEach((t=>this.po=this.po.add(t))),t.modifiedDocuments.forEach((t=>{})),t.removedDocuments.forEach((t=>this.po=this.po.delete(t))),this.current=t.current)}So(){if(!this.current)return[];const t=this.Eo;this.Eo=en(),this.Ao.forEach((t=>{this.Co(t.key)&&(this.Eo=this.Eo.add(t.key))}));const e=[];return t.forEach((t=>{this.Eo.has(t)||e.push(new vo(t))})),this.Eo.forEach((n=>{t.has(n)||e.push(new wo(n))})),e}No(t){this.po=t.Gn,this.Eo=en();const e=this.bo(t.documents);return this.applyChanges(e,!0)}xo(){return so.fromInitialDocuments(this.query,this.Ao,this.mutatedKeys,0===this.To)}}class bo{constructor(t,e,n){this.query=t,this.targetId=e,this.view=n}}class Eo{constructor(t){this.key=t,this.ko=!1}}class To{constructor(t,e,n,r,s,i){this.localStore=t,this.remoteStore=e,this.eventManager=n,this.sharedClientState=r,this.currentUser=s,this.maxConcurrentLimboResolutions=i,this.$o={},this.Oo=new ps((t=>ee(t)),te),this.Fo=new Map,this.Mo=new Set,this.Lo=new je(it.comparator),this.Bo=new Map,this.Uo=new Qs,this.qo={},this.Ko=new Map,this.jo=ss.ie(),this.onlineState="Unknown",this.Qo=void 0}get isPrimaryClient(){return!0===this.Qo}}async function So(t,e){const n=Yo(t);let r,s;const i=n.Oo.get(e);if(i)r=i.targetId,n.sharedClientState.addLocalQueryTarget(r),s=i.view.xo();else{const t=await qs(n.localStore,Xt(e)),i=n.sharedClientState.addLocalQueryTarget(t.targetId);r=t.targetId,s=await No(n,e,r,"current"===i),n.isPrimaryClient&&ki(n.remoteStore,t)}return s}async function No(t,e,n,r){t.Wo=(e,n,r)=>async function(t,e,n,r){let s=e.view.bo(n);s.Ln&&(s=await Ks(t.localStore,e.query,!1).then((({documents:t})=>e.view.bo(t,s))));const i=r&&r.targetChanges.get(e.targetId),o=e.view.applyChanges(s,t.isPrimaryClient,i);return Mo(t,e.targetId,o.Do),o.snapshot}(t,e,n,r);const s=await Ks(t.localStore,e,!0),i=new Io(e,s.Gn),o=i.bo(s.documents),a=on.createSynthesizedTargetChangeForCurrentChange(n,r&&"Offline"!==t.onlineState),c=i.applyChanges(o,t.isPrimaryClient,a);Mo(t,n,c.Do);const u=new bo(e,n,i);return t.Oo.set(e,u),t.Fo.has(n)?t.Fo.get(n).push(e):t.Fo.set(n,[e]),c.snapshot}async function _o(t,e){const n=b(t),r=n.Oo.get(e),s=n.Fo.get(r.targetId);if(s.length>1)return n.Fo.set(r.targetId,s.filter((t=>!te(t,e)))),void n.Oo.delete(e);n.isPrimaryClient?(n.sharedClientState.removeLocalQueryTarget(r.targetId),n.sharedClientState.isActiveQueryTarget(r.targetId)||await Bs(n.localStore,r.targetId,!1).then((()=>{n.sharedClientState.clearQueryState(r.targetId),xi(n.remoteStore,r.targetId),Oo(n,r.targetId)})).catch(us)):(Oo(n,r.targetId),await Bs(n.localStore,r.targetId,!0))}async function Do(t,e){const n=b(t);try{const t=await function(t,e){const n=b(t),r=e.snapshotVersion;let s=n.Un;return n.persistence.runTransaction("Apply remote event","readwrite-primary",(t=>{const i=n.jn.newChangeBuffer({trackRemovals:!0});s=n.Un;const o=[];e.targetChanges.forEach(((e,i)=>{const a=s.get(i);if(!a)return;o.push(n.ze.removeMatchingKeys(t,e.removedDocuments,i).next((()=>n.ze.addMatchingKeys(t,e.addedDocuments,i))));const c=e.resumeToken;if(c.approximateByteSize()>0){const u=a.withResumeToken(c,r).withSequenceNumber(t.currentSequenceNumber);s=s.insert(i,u),function(t,e,n){return v(e.resumeToken.approximateByteSize()>0),0===t.resumeToken.approximateByteSize()||e.snapshotVersion.toMicroseconds()-t.snapshotVersion.toMicroseconds()>=3e8||n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size>0}(a,u,e)&&o.push(n.ze.updateTargetData(t,u))}}));let a=We();if(e.documentUpdates.forEach(((r,s)=>{e.resolvedLimboDocuments.has(r)&&o.push(n.persistence.referenceDelegate.updateLimboDocument(t,r))})),o.push(Ps(t,i,e.documentUpdates,r,void 0).next((t=>{a=t}))),!r.isEqual(P.min())){const e=n.ze.getLastRemoteSnapshotVersion(t).next((e=>n.ze.setTargetsMetadata(t,t.currentSequenceNumber,r)));o.push(e)}return pr.waitFor(o).next((()=>i.apply(t))).next((()=>n.Qn.vn(t,a))).next((()=>a))})).then((t=>(n.Un=s,t)))}(n.localStore,e);e.targetChanges.forEach(((t,e)=>{const r=n.Bo.get(e);r&&(v(t.addedDocuments.size+t.modifiedDocuments.size+t.removedDocuments.size<=1),t.addedDocuments.size>0?r.ko=!0:t.modifiedDocuments.size>0?v(r.ko):t.removedDocuments.size>0&&(v(r.ko),r.ko=!1))})),await Uo(n,t,e)}catch(t){await us(t)}}function Ao(t,e,n){const r=b(t);if(r.isPrimaryClient&&0===n||!r.isPrimaryClient&&1===n){const t=[];r.Oo.forEach(((n,r)=>{const s=r.view.io(e);s.snapshot&&t.push(s.snapshot)})),function(t,e){const n=b(t);n.onlineState=e;let r=!1;n.queries.forEach(((t,n)=>{for(const s of n.listeners)s.io(e)&&(r=!0)})),r&&lo(n)}(r.eventManager,e),t.length&&r.$o.Rr(t),r.onlineState=e,r.isPrimaryClient&&r.sharedClientState.setOnlineState(e)}}async function ko(t,e,n){const r=b(t);r.sharedClientState.updateQueryState(e,"rejected",n);const s=r.Bo.get(e),i=s&&s.key;if(i){let t=new je(it.comparator);t=t.insert(i,Et.newNoDocument(i,P.min()));const n=en().add(i),s=new sn(P.min(),new Map,new Ge(O),t,n);await Do(r,s),r.Lo=r.Lo.remove(i),r.Bo.delete(e),Po(r)}else await Bs(r.localStore,e,!1).then((()=>Oo(r,e,n))).catch(us)}async function xo(t,e){const n=b(t),r=e.batch.batchId;try{const t=await function(t,e){const n=b(t);return n.persistence.runTransaction("Acknowledge batch","readwrite-primary",(t=>{const r=e.batch.keys(),s=n.jn.newChangeBuffer({trackRemovals:!0});return function(t,e,n,r){const s=n.batch,i=s.keys();let o=pr.resolve();return i.forEach((t=>{o=o.next((()=>r.getEntry(e,t))).next((e=>{const i=n.docVersions.get(t);v(null!==i),e.version.compareTo(i)<0&&(s.applyToRemoteDocument(e,n),e.isValidDocument()&&r.addEntry(e,n.commitVersion))}))})),o.next((()=>t.In.removeMutationBatch(e,s)))}(n,t,e,s).next((()=>s.apply(t))).next((()=>n.In.performConsistencyCheck(t))).next((()=>n.Qn.Pn(t,r)))}))}(n.localStore,e);Ro(n,r,null),Lo(n,r),n.sharedClientState.updateMutationState(r,"acknowledged"),await Uo(n,t)}catch(t){await us(t)}}async function Co(t,e,n){const r=b(t);try{const t=await function(t,e){const n=b(t);return n.persistence.runTransaction("Reject batch","readwrite-primary",(t=>{let r;return n.In.lookupMutationBatch(t,e).next((e=>(v(null!==e),r=e.keys(),n.In.removeMutationBatch(t,e)))).next((()=>n.In.performConsistencyCheck(t))).next((()=>n.Qn.Pn(t,r)))}))}(r.localStore,e);Ro(r,e,n),Lo(r,e),r.sharedClientState.updateMutationState(e,"rejected",n),await Uo(r,t)}catch(n){await us(n)}}function Lo(t,e){(t.Ko.get(e)||[]).forEach((t=>{t.resolve()})),t.Ko.delete(e)}function Ro(t,e,n){const r=b(t);let s=r.qo[r.currentUser.toKey()];if(s){const t=s.get(e);t&&(n?t.reject(n):t.resolve(),s=s.remove(e)),r.qo[r.currentUser.toKey()]=s}}function Oo(t,e,n=null){t.sharedClientState.removeLocalQueryTarget(e);for(const r of t.Fo.get(e))t.Oo.delete(r),n&&t.$o.Go(r,n);t.Fo.delete(e),t.isPrimaryClient&&t.Uo.cs(e).forEach((e=>{t.Uo.containsKey(e)||Fo(t,e)}))}function Fo(t,e){t.Mo.delete(e.path.canonicalString());const n=t.Lo.get(e);null!==n&&(xi(t.remoteStore,n),t.Lo=t.Lo.remove(e),t.Bo.delete(n),Po(t))}function Mo(t,e,n){for(const r of n)r instanceof wo?(t.Uo.addReference(r.key,e),Vo(t,r)):r instanceof vo?(m("SyncEngine","Document no longer in limbo: "+r.key),t.Uo.removeReference(r.key,e),t.Uo.containsKey(r.key)||Fo(t,r.key)):w()}function Vo(t,e){const n=e.key,r=n.path.canonicalString();t.Lo.get(n)||t.Mo.has(r)||(m("SyncEngine","New document in limbo: "+n),t.Mo.add(r),Po(t))}function Po(t){for(;t.Mo.size>0&&t.Lo.size<t.maxConcurrentLimboResolutions;){const e=t.Mo.values().next().value;t.Mo.delete(e);const n=new it(j.fromString(e)),r=t.jo.next();t.Bo.set(r,new Eo(n)),t.Lo=t.Lo.insert(n,r),ki(t.remoteStore,new xr(Xt(zt(n.path)),r,2,C.T))}}async function Uo(t,e,n){const r=b(t),s=[],i=[],o=[];r.Oo.isEmpty()||(r.Oo.forEach(((t,a)=>{o.push(r.Wo(a,e,n).then((t=>{if(t){r.isPrimaryClient&&r.sharedClientState.updateQueryState(a.targetId,t.fromCache?"not-current":"current"),s.push(t);const e=Ls.kn(a.targetId,t);i.push(e)}})))})),await Promise.all(o),r.$o.Rr(s),await async function(t,e){const n=b(t);try{await n.persistence.runTransaction("notifyLocalViewChanges","readwrite",(t=>pr.forEach(e,(e=>pr.forEach(e.Nn,(r=>n.persistence.referenceDelegate.addReference(t,e.targetId,r))).next((()=>pr.forEach(e.xn,(r=>n.persistence.referenceDelegate.removeReference(t,e.targetId,r)))))))))}catch(t){if(!br(t))throw t;m("LocalStore","Failed to update sequence numbers: "+t)}for(const r of e){const t=r.targetId;if(!r.fromCache){const e=n.Un.get(t),r=e.snapshotVersion,s=e.withLastLimboFreeSnapshotVersion(r);n.Un=n.Un.insert(t,s)}}}(r.localStore,i))}async function qo(t,e){const n=b(t);if(!n.currentUser.isEqual(e)){m("SyncEngine","User change. New user:",e.toKey());const t=await Ms(n.localStore,e);n.currentUser=e,function(t,e){t.Ko.forEach((t=>{t.forEach((t=>{t.reject(new T(E.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))}))})),t.Ko.clear()}(n),n.sharedClientState.handleUserChange(e,t.removedBatchIds,t.addedBatchIds),await Uo(n,t.Wn)}}function Bo(t,e){const n=b(t),r=n.Bo.get(e);if(r&&r.ko)return en().add(r.key);{let t=en();const r=n.Fo.get(e);if(!r)return t;for(const e of r){const r=n.Oo.get(e);t=t.unionWith(r.view.Ro)}return t}}async function Ko(t,e){const n=b(t),r=await Ks(n.localStore,e.query,!0),s=e.view.No(r);return n.isPrimaryClient&&Mo(n,e.targetId,s.Do),s}async function jo(t){const e=b(t);return $s(e.localStore).then((t=>Uo(e,t)))}async function $o(t,e,n,r){const s=b(t),i=await function(t,e){const n=b(t),r=b(n.In);return n.persistence.runTransaction("Lookup mutation documents","readonly",(t=>r.Xt(t,e).next((e=>e?n.Qn.Pn(t,e):pr.resolve(null)))))}(s.localStore,e);null!==i?("pending"===n?await Ki(s.remoteStore):"acknowledged"===n||"rejected"===n?(Ro(s,e,r||null),Lo(s,e),function(t,e){b(b(t).In).te(e)}(s.localStore,e)):w(),await Uo(s,i)):m("SyncEngine","Cannot apply mutation batch with id: "+e)}async function zo(t,e,n){const r=b(t),s=[],i=[];for(const o of e){let t;const e=r.Fo.get(o);if(e&&0!==e.length){t=await qs(r.localStore,Xt(e[0]));for(const t of e){const e=r.Oo.get(t),n=await Ko(r,e);n.snapshot&&i.push(n.snapshot)}}else{const e=await js(r.localStore,o);t=await qs(r.localStore,e),await No(r,Go(e),o,!1)}s.push(t)}return r.$o.Rr(i),s}function Go(t){return $t(t.path,t.collectionGroup,t.orderBy,t.filters,t.limit,"F",t.startAt,t.endAt)}function Qo(t){const e=b(t);return b(b(e.localStore).persistence).pn()}async function Ho(t,e,n,r){const s=b(t);if(s.Qo)m("SyncEngine","Ignoring unexpected query state notification.");else if(s.Fo.has(e))switch(n){case"current":case"not-current":{const t=await $s(s.localStore),r=sn.createSynthesizedRemoteEventForCurrentChange(e,"current"===n);await Uo(s,t,r);break}case"rejected":await Bs(s.localStore,e,!0),Oo(s,e,r);break;default:w()}}async function Wo(t,e,n){const r=Yo(t);if(r.Qo){for(const t of e){if(r.Fo.has(t)){m("SyncEngine","Adding an already active target "+t);continue}const e=await js(r.localStore,t),n=await qs(r.localStore,e);await No(r,Go(e),n.targetId,!1),ki(r.remoteStore,n)}for(const t of n)r.Fo.has(t)&&await Bs(r.localStore,t,!1).then((()=>{xi(r.remoteStore,t),Oo(r,t)})).catch(us)}}function Yo(t){const e=b(t);return e.remoteStore.remoteSyncer.applyRemoteEvent=Do.bind(null,e),e.remoteStore.remoteSyncer.getRemoteKeysForTarget=Bo.bind(null,e),e.remoteStore.remoteSyncer.rejectListen=ko.bind(null,e),e.$o.Rr=uo.bind(null,e.eventManager),e.$o.Go=ho.bind(null,e.eventManager),e}function Jo(t){const e=b(t);return e.remoteStore.remoteSyncer.applySuccessfulWrite=xo.bind(null,e),e.remoteStore.remoteSyncer.rejectFailedWrite=Co.bind(null,e),e}class Xo{constructor(){this.synchronizeTabs=!1}async initialize(t){this.N=vi(t.databaseInfo.databaseId),this.sharedClientState=this.Ho(t),this.persistence=this.Jo(t),await this.persistence.start(),this.gcScheduler=this.Yo(t),this.localStore=this.Xo(t)}Yo(t){return null}Xo(t){return Fs(this.persistence,new Rs,t.initialUser,this.N)}Jo(t){return new Zs(ei.Ns,this.N)}Ho(t){return new li}async terminate(){this.gcScheduler&&this.gcScheduler.stop(),await this.sharedClientState.shutdown(),await this.persistence.shutdown()}}class Zo extends Xo{constructor(t,e,n){super(),this.Zo=t,this.cacheSizeBytes=e,this.forceOwnership=n,this.synchronizeTabs=!1}async initialize(t){await super.initialize(t),await async function(t){const e=b(t);return e.persistence.runTransaction("Synchronize last document change read time","readonly",(t=>function(t){const e=bs(t);let n=P.min();return e.Kt({index:sr.readTimeIndex,reverse:!0},((t,e,r)=>{e.readTime&&(n=Fr(e.readTime)),r.done()})).next((()=>n))}(t))).then((t=>{e.Kn=t}))}(this.localStore),await this.Zo.initialize(this,t),await Jo(this.Zo.syncEngine),await Ki(this.Zo.remoteStore),await this.persistence.nn((()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(this.localStore),Promise.resolve())))}Xo(t){return Fs(this.persistence,new Rs,t.initialUser,this.N)}Yo(t){const e=this.persistence.referenceDelegate.garbageCollector;return new ds(e,t.asyncQueue)}Jo(t){const e=ks(t.databaseInfo.databaseId,t.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?Yr.withCacheSize(this.cacheSizeBytes):Yr.DEFAULT;return new _s(this.synchronizeTabs,e,t.clientId,n,t.asyncQueue,yi(),wi(),this.N,this.sharedClientState,!!this.forceOwnership)}Ho(t){return new li}}class ta extends Zo{constructor(t,e){super(t,e,!1),this.Zo=t,this.cacheSizeBytes=e,this.synchronizeTabs=!0}async initialize(t){await super.initialize(t);const e=this.Zo.syncEngine;this.sharedClientState instanceof hi&&(this.sharedClientState.syncEngine={_i:$o.bind(null,e),mi:Ho.bind(null,e),gi:Wo.bind(null,e),pn:Qo.bind(null,e),wi:jo.bind(null,e)},await this.sharedClientState.start()),await this.persistence.nn((async t=>{await async function(t,e){const n=b(t);if(Yo(n),Jo(n),!0===e&&!0!==n.Qo){const t=n.sharedClientState.getAllActiveQueryTargets(),e=await zo(n,t.toArray());n.Qo=!0,await Ji(n.remoteStore,!0);for(const r of e)ki(n.remoteStore,r)}else if(!1===e&&!1!==n.Qo){const t=[];let e=Promise.resolve();n.Fo.forEach(((r,s)=>{n.sharedClientState.isLocalQueryTarget(s)?t.push(s):e=e.then((()=>(Oo(n,s),Bs(n.localStore,s,!0)))),xi(n.remoteStore,s)})),await e,await zo(n,t),function(t){const e=b(t);e.Bo.forEach(((t,n)=>{xi(e.remoteStore,n)})),e.Uo.us(),e.Bo=new Map,e.Lo=new je(it.comparator)}(n),n.Qo=!1,await Ji(n.remoteStore,!1)}}(this.Zo.syncEngine,t),this.gcScheduler&&(t&&!this.gcScheduler.started?this.gcScheduler.start(this.localStore):t||this.gcScheduler.stop())}))}Ho(t){const e=yi();if(!hi.bt(e))throw new T(E.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");const n=ks(t.databaseInfo.databaseId,t.databaseInfo.persistenceKey);return new hi(e,t.asyncQueue,n,t.clientId,t.initialUser)}}class ea{async initialize(t,e){this.localStore||(this.localStore=t.localStore,this.sharedClientState=t.sharedClientState,this.datastore=this.createDatastore(e),this.remoteStore=this.createRemoteStore(e),this.eventManager=this.createEventManager(e),this.syncEngine=this.createSyncEngine(e,!t.synchronizeTabs),this.sharedClientState.onlineStateHandler=t=>Ao(this.syncEngine,t,1),this.remoteStore.remoteSyncer.handleCredentialChange=qo.bind(null,this.syncEngine),await Ji(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(t){return new oo}createDatastore(t){const e=vi(t.databaseInfo.databaseId),n=(r=t.databaseInfo,new pi(r));var r;return function(t,e,n){return new Si(t,e,n)}(t.credentials,n,e)}createRemoteStore(t){return e=this.localStore,n=this.datastore,r=t.asyncQueue,s=t=>Ao(this.syncEngine,t,0),i=fi.bt()?new fi:new di,new _i(e,n,r,s,i);var e,n,r,s,i}createSyncEngine(t,e){return function(t,e,n,r,s,i,o){const a=new To(t,e,n,r,s,i);return o&&(a.Qo=!0),a}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,t.initialUser,t.maxConcurrentLimboResolutions,e)}terminate(){return async function(t){const e=b(t);m("RemoteStore","RemoteStore shutting down."),e.Wr.add(5),await Ai(e),e.zr.shutdown(),e.Hr.set("Unknown")}(this.remoteStore)}}function na(t,e=10240){let n=0;return{async read(){if(n<t.byteLength){const r={value:t.slice(n,n+e),done:!1};return n+=e,r}return{done:!0}},async cancel(){},releaseLock(){},closed:Promise.reject("unimplemented")}}class ra{constructor(t){this.observer=t,this.muted=!1}next(t){this.observer.next&&this.tc(this.observer.next,t)}error(t){this.observer.error?this.tc(this.observer.error,t):console.error("Uncaught Error in snapshot listener:",t)}ec(){this.muted=!0}tc(t,e){this.muted||setTimeout((()=>{this.muted||t(e)}),0)}}class sa{constructor(t,e){this.nc=t,this.N=e,this.metadata=new S,this.buffer=new Uint8Array,this.sc=new TextDecoder("utf-8"),this.ic().then((t=>{t&&t.wo()?this.metadata.resolve(t.payload.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is\n             ${JSON.stringify(null==t?void 0:t.payload)}`))}),(t=>this.metadata.reject(t)))}close(){return this.nc.cancel()}async getMetadata(){return this.metadata.promise}async zo(){return await this.getMetadata(),this.ic()}async ic(){const t=await this.rc();if(null===t)return null;const e=this.sc.decode(t),n=Number(e);isNaN(n)&&this.oc(`length string (${e}) is not valid number`);const r=await this.cc(n);return new mo(JSON.parse(r),t.length+n)}ac(){return this.buffer.findIndex((t=>t==="{".charCodeAt(0)))}async rc(){for(;this.ac()<0&&!(await this.uc()););if(0===this.buffer.length)return null;const t=this.ac();t<0&&this.oc("Reached the end of bundle when a length string is expected.");const e=this.buffer.slice(0,t);return this.buffer=this.buffer.slice(t),e}async cc(t){for(;this.buffer.length<t;)await this.uc()&&this.oc("Reached the end of bundle when more is expected.");const e=this.sc.decode(this.buffer.slice(0,t));return this.buffer=this.buffer.slice(t),e}oc(t){throw this.nc.cancel(),new Error(`Invalid bundle format: ${t}`)}async uc(){const t=await this.nc.read();if(!t.done){const e=new Uint8Array(this.buffer.length+t.value.length);e.set(this.buffer),e.set(t.value,this.buffer.length),this.buffer=e}return t.done}}class ia{constructor(t){this.datastore=t,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastWriteError=null,this.writtenDocs=new Set}async lookup(t){if(this.ensureCommitNotCalled(),this.mutations.length>0)throw new T(E.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes.");const e=await async function(t,e){const n=b(t),r=Dn(n.N)+"/documents",s={documents:e.map((t=>Tn(n.N,t)))},i=await n.Ki("BatchGetDocuments",r,s),o=new Map;i.forEach((t=>{const e=function(t,e){return"found"in e?function(t,e){v(!!e.found),e.found.name,e.found.updateTime;const n=Sn(t,e.found.name),r=In(e.found.updateTime),s=new It({mapValue:{fields:e.found.fields}});return Et.newFoundDocument(n,r,s)}(t,e):"missing"in e?function(t,e){v(!!e.missing),v(!!e.readTime);const n=Sn(t,e.missing),r=In(e.readTime);return Et.newNoDocument(n,r)}(t,e):w()}(n.N,t);o.set(e.key.toString(),e)}));const a=[];return e.forEach((t=>{const e=o.get(t.toString());v(!!e),a.push(e)})),a}(this.datastore,t);return e.forEach((t=>this.recordVersion(t))),e}set(t,e){this.write(e.toMutation(t,this.precondition(t))),this.writtenDocs.add(t.toString())}update(t,e){try{this.write(e.toMutation(t,this.preconditionForUpdate(t)))}catch(t){this.lastWriteError=t}this.writtenDocs.add(t.toString())}delete(t){this.write(new Me(t,this.precondition(t))),this.writtenDocs.add(t.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastWriteError)throw this.lastWriteError;const t=this.readVersions;this.mutations.forEach((e=>{t.delete(e.key.toString())})),t.forEach(((t,e)=>{const n=it.fromPath(e);this.mutations.push(new Ve(n,this.precondition(n)))})),await async function(t,e){const n=b(t),r=Dn(n.N)+"/documents",s={writes:e.map((t=>Cn(n.N,t)))};await n.Li("Commit",r,s)}(this.datastore,this.mutations),this.committed=!0}recordVersion(t){let e;if(t.isFoundDocument())e=t.version;else{if(!t.isNoDocument())throw w();e=P.min()}const n=this.readVersions.get(t.key.toString());if(n){if(!e.isEqual(n))throw new T(E.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(t.key.toString(),e)}precondition(t){const e=this.readVersions.get(t.toString());return!this.writtenDocs.has(t.toString())&&e?Te.updateTime(e):Te.none()}preconditionForUpdate(t){const e=this.readVersions.get(t.toString());if(!this.writtenDocs.has(t.toString())&&e){if(e.isEqual(P.min()))throw new T(E.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return Te.updateTime(e)}return Te.exists(!0)}write(t){this.ensureCommitNotCalled(),this.mutations.push(t)}ensureCommitNotCalled(){}}class oa{constructor(t,e,n,r){this.asyncQueue=t,this.datastore=e,this.updateFunction=n,this.deferred=r,this.hc=5,this.ar=new Ii(this.asyncQueue,"transaction_retry")}run(){this.hc-=1,this.lc()}lc(){this.ar.Xi((async()=>{const t=new ia(this.datastore),e=this.fc(t);e&&e.then((e=>{this.asyncQueue.enqueueAndForget((()=>t.commit().then((()=>{this.deferred.resolve(e)})).catch((t=>{this.dc(t)}))))})).catch((t=>{this.dc(t)}))}))}fc(t){try{const e=this.updateFunction(t);return!nt(e)&&e.catch&&e.then?e:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(t){return this.deferred.reject(t),null}}dc(t){this.hc>0&&this.wc(t)?(this.hc-=1,this.asyncQueue.enqueueAndForget((()=>(this.lc(),Promise.resolve())))):this.deferred.reject(t)}wc(t){if("FirebaseError"===t.name){const e=t.code;return"aborted"===e||"failed-precondition"===e||!Be(e)}return!1}}class aa{constructor(t,e,n){this.credentials=t,this.asyncQueue=e,this.databaseInfo=n,this.user=u.UNAUTHENTICATED,this.clientId=R.I(),this.credentialListener=()=>Promise.resolve(),this.credentials.start(e,(async t=>{m("FirestoreClient","Received user=",t.uid),await this.credentialListener(t),this.user=t}))}async getConfiguration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,credentials:this.credentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(t){this.credentialListener=t}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new T(E.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();const t=new S;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted((async()=>{try{this.onlineComponents&&await this.onlineComponents.terminate(),this.offlineComponents&&await this.offlineComponents.terminate(),this.credentials.shutdown(),t.resolve()}catch(e){const n=eo(e,"Failed to shutdown persistence");t.reject(n)}})),t.promise}}async function ca(t,e){t.asyncQueue.verifyOperationInProgress(),m("FirestoreClient","Initializing OfflineComponentProvider");const n=await t.getConfiguration();await e.initialize(n);let r=n.initialUser;t.setCredentialChangeListener((async t=>{r.isEqual(t)||(await Ms(e.localStore,t),r=t)})),e.persistence.setDatabaseDeletedListener((()=>t.terminate())),t.offlineComponents=e}async function ua(t,e){t.asyncQueue.verifyOperationInProgress();const n=await ha(t);m("FirestoreClient","Initializing OnlineComponentProvider");const r=await t.getConfiguration();await e.initialize(n,r),t.setCredentialChangeListener((t=>async function(t,e){const n=b(t);n.asyncQueue.verifyOperationInProgress(),m("RemoteStore","RemoteStore received new credentials");const r=Fi(n);n.Wr.add(3),await Ai(n),r&&n.Hr.set("Unknown"),await n.remoteSyncer.handleCredentialChange(e),n.Wr.delete(3),await Di(n)}(e.remoteStore,t))),t.onlineComponents=e}async function ha(t){return t.offlineComponents||(m("FirestoreClient","Using default OfflineComponentProvider"),await ca(t,new Xo)),t.offlineComponents}async function la(t){return t.onlineComponents||(m("FirestoreClient","Using default OnlineComponentProvider"),await ua(t,new ea)),t.onlineComponents}function da(t){return ha(t).then((t=>t.persistence))}function fa(t){return ha(t).then((t=>t.localStore))}function ma(t){return la(t).then((t=>t.remoteStore))}function ga(t){return la(t).then((t=>t.syncEngine))}async function pa(t){const e=await la(t),n=e.eventManager;return n.onListen=So.bind(null,e.syncEngine),n.onUnlisten=_o.bind(null,e.syncEngine),n}function ya(t,e,n={}){const r=new S;return t.asyncQueue.enqueueAndForget((async()=>function(t,e,n,r,s){const i=new ra({next:i=>{e.enqueueAndForget((()=>co(t,o)));const a=i.docs.has(n);!a&&i.fromCache?s.reject(new T(E.UNAVAILABLE,"Failed to get document because the client is offline.")):a&&i.fromCache&&r&&"server"===r.source?s.reject(new T(E.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):s.resolve(i)},error:t=>s.reject(t)}),o=new fo(zt(n.path),i,{includeMetadataChanges:!0,fo:!0});return ao(t,o)}(await pa(t),t.asyncQueue,e,n,r))),r.promise}function wa(t,e,n={}){const r=new S;return t.asyncQueue.enqueueAndForget((async()=>function(t,e,n,r,s){const i=new ra({next:n=>{e.enqueueAndForget((()=>co(t,o))),n.fromCache&&"server"===r.source?s.reject(new T(E.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):s.resolve(n)},error:t=>s.reject(t)}),o=new fo(n,i,{includeMetadataChanges:!0,fo:!0});return ao(t,o)}(await pa(t),t.asyncQueue,e,n,r))),r.promise}function va(t,e,n,r){const s=function(t,e){let n;return n="string"==typeof t?(new TextEncoder).encode(t):t,function(t,e){return new sa(t,e)}(function(t,e){if(t instanceof Uint8Array)return na(t,e);if(t instanceof ArrayBuffer)return na(new Uint8Array(t),e);if(t instanceof ReadableStream)return t.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}(n),e)}(n,vi(e));t.asyncQueue.enqueueAndForget((async()=>{!function(t,e,n){const r=b(t);(async function(t,e,n){try{const r=await e.getMetadata();if(await function(t,e){const n=b(t),r=In(e.createTime);return n.persistence.runTransaction("hasNewerBundle","readonly",(t=>n.Je.getBundleMetadata(t,e.id))).then((t=>!!t&&t.createTime.compareTo(r)>=0))}(t.localStore,r))return await e.close(),void n._completeWith(function(t){return{taskState:"Success",documentsLoaded:t.totalDocuments,bytesLoaded:t.totalBytes,totalDocuments:t.totalDocuments,totalBytes:t.totalBytes}}(r));n._updateProgress(yo(r));const s=new po(r,t.localStore,e.N);let i=await e.zo();for(;i;){const t=await s.mo(i);t&&n._updateProgress(t),i=await e.zo()}const o=await s.complete();await Uo(t,o.En,void 0),await function(t,e){const n=b(t);return n.persistence.runTransaction("Save bundle","readwrite",(t=>n.Je.saveBundleMetadata(t,e)))}(t.localStore,r),n._completeWith(o.progress)}catch(t){p("SyncEngine",`Loading bundle failed with ${t}`),n._failWith(t)}})(r,e,n).then((()=>{r.sharedClientState.notifyBundleLoaded()}))}(await ga(t),s,r)}))}class Ia{constructor(t,e,n,r,s,i,o,a){this.databaseId=t,this.appId=e,this.persistenceKey=n,this.host=r,this.ssl=s,this.forceLongPolling=i,this.autoDetectLongPolling=o,this.useFetchStreams=a}}class ba{constructor(t,e){this.projectId=t,this.database=e||"(default)"}get isDefaultDatabase(){return"(default)"===this.database}isEqual(t){return t instanceof ba&&t.projectId===this.projectId&&t.database===this.database}}const Ea=new Map;function Ta(t,e,n){if(!n)throw new T(E.INVALID_ARGUMENT,`Function ${t}() cannot be called with an empty ${e}.`)}function Sa(t,e,n,r){if(!0===e&&!0===r)throw new T(E.INVALID_ARGUMENT,`${t} and ${n} cannot be used together.`)}function Na(t){if(!it.isDocumentKey(t))throw new T(E.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${t} has ${t.length}.`)}function _a(t){if(it.isDocumentKey(t))throw new T(E.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${t} has ${t.length}.`)}function Da(t){if(void 0===t)return"undefined";if(null===t)return"null";if("string"==typeof t)return t.length>20&&(t=`${t.substring(0,20)}...`),JSON.stringify(t);if("number"==typeof t||"boolean"==typeof t)return""+t;if("object"==typeof t){if(t instanceof Array)return"an array";{const e=function(t){return t.constructor?t.constructor.name:null}(t);return e?`a custom ${e} object`:"an object"}}return"function"==typeof t?"a function":w()}function Aa(t,e){if("_delegate"in t&&(t=t._delegate),!(t instanceof e)){if(e.name===t.constructor.name)throw new T(E.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{const n=Da(t);throw new T(E.INVALID_ARGUMENT,`Expected type '${e.name}', but it was: ${n}`)}}return t}function ka(t,e){if(e<=0)throw new T(E.INVALID_ARGUMENT,`Function ${t}() requires a positive number, but it was: ${e}.`)}class xa{constructor(t){var e;if(void 0===t.host){if(void 0!==t.ssl)throw new T(E.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=t.host,this.ssl=null===(e=t.ssl)||void 0===e||e;if(this.credentials=t.credentials,this.ignoreUndefinedProperties=!!t.ignoreUndefinedProperties,void 0===t.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==t.cacheSizeBytes&&t.cacheSizeBytes<1048576)throw new T(E.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=t.cacheSizeBytes}this.experimentalForceLongPolling=!!t.experimentalForceLongPolling,this.experimentalAutoDetectLongPolling=!!t.experimentalAutoDetectLongPolling,this.useFetchStreams=!!t.useFetchStreams,Sa("experimentalForceLongPolling",t.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",t.experimentalAutoDetectLongPolling)}isEqual(t){return this.host===t.host&&this.ssl===t.ssl&&this.credentials===t.credentials&&this.cacheSizeBytes===t.cacheSizeBytes&&this.experimentalForceLongPolling===t.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===t.experimentalAutoDetectLongPolling&&this.ignoreUndefinedProperties===t.ignoreUndefinedProperties&&this.useFetchStreams===t.useFetchStreams}}class Ca{constructor(t,e){this._credentials=e,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new xa({}),this._settingsFrozen=!1,t instanceof ba?this._databaseId=t:(this._app=t,this._databaseId=function(t){if(!Object.prototype.hasOwnProperty.apply(t.options,["projectId"]))throw new T(E.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new ba(t.options.projectId)}(t))}get app(){if(!this._app)throw new T(E.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return void 0!==this._terminateTask}_setSettings(t){if(this._settingsFrozen)throw new T(E.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new xa(t),void 0!==t.credentials&&(this._credentials=function(t){if(!t)return new _;switch(t.type){case"gapi":const e=t.client;return v(!("object"!=typeof e||null===e||!e.auth||!e.auth.getAuthHeaderValueForFirstParty)),new x(e,t.sessionIndex||"0",t.iamToken||null);case"provider":return t.client;default:throw new T(E.INVALID_ARGUMENT,"makeCredentialsProvider failed due to invalid credential type")}}(t.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(t){const e=Ea.get(t);e&&(m("ComponentProvider","Removing Datastore"),Ea.delete(t),e.terminate())}(this),Promise.resolve()}}function La(t,e,n,r={}){var s;const i=(t=Aa(t,Ca))._getSettings();if("firestore.googleapis.com"!==i.host&&i.host!==e&&p("Host has been set in both settings() and useEmulator(), emulator host will be used"),t._setSettings(Object.assign(Object.assign({},i),{host:`${e}:${n}`,ssl:!1})),r.mockUserToken){let e,n;if("string"==typeof r.mockUserToken)e=r.mockUserToken,n=u.MOCK_USER;else{e=Object(o.f)(r.mockUserToken,null===(s=t._app)||void 0===s?void 0:s.options.projectId);const i=r.mockUserToken.sub||r.mockUserToken.user_id;if(!i)throw new T(E.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");n=new u(i)}t._credentials=new D(new N(e,n))}}class Ra{constructor(t,e,n){this.converter=e,this._key=n,this.type="document",this.firestore=t}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new Fa(this.firestore,this.converter,this._key.path.popLast())}withConverter(t){return new Ra(this.firestore,t,this._key)}}class Oa{constructor(t,e,n){this.converter=e,this._query=n,this.type="query",this.firestore=t}withConverter(t){return new Oa(this.firestore,t,this._query)}}class Fa extends Oa{constructor(t,e,n){super(t,e,zt(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const t=this._path.popLast();return t.isEmpty()?null:new Ra(this.firestore,null,new it(t))}withConverter(t){return new Fa(this.firestore,t,this._path)}}function Ma(t,e,...n){if(t=Object(o.k)(t),Ta("collection","path",e),t instanceof Ca){const r=j.fromString(e,...n);return _a(r),new Fa(t,null,r)}{if(!(t instanceof Ra||t instanceof Fa))throw new T(E.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const r=t._path.child(j.fromString(e,...n));return _a(r),new Fa(t.firestore,null,r)}}function Va(t,e){if(t=Aa(t,Ca),Ta("collectionGroup","collection id",e),e.indexOf("/")>=0)throw new T(E.INVALID_ARGUMENT,`Invalid collection ID '${e}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new Oa(t,null,function(t){return new jt(j.emptyPath(),t)}(e))}function Pa(t,e,...n){if(t=Object(o.k)(t),1===arguments.length&&(e=R.I()),Ta("doc","path",e),t instanceof Ca){const r=j.fromString(e,...n);return Na(r),new Ra(t,null,new it(r))}{if(!(t instanceof Ra||t instanceof Fa))throw new T(E.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const r=t._path.child(j.fromString(e,...n));return Na(r),new Ra(t.firestore,t instanceof Fa?t.converter:null,new it(r))}}function Ua(t,e){return t=Object(o.k)(t),e=Object(o.k)(e),(t instanceof Ra||t instanceof Fa)&&(e instanceof Ra||e instanceof Fa)&&t.firestore===e.firestore&&t.path===e.path&&t.converter===e.converter}function qa(t,e){return t=Object(o.k)(t),e=Object(o.k)(e),t instanceof Oa&&e instanceof Oa&&t.firestore===e.firestore&&te(t._query,e._query)&&t.converter===e.converter}class Ba{constructor(){this._c=Promise.resolve(),this.mc=[],this.gc=!1,this.yc=[],this.Tc=null,this.Ec=!1,this.Ic=!1,this.Ac=[],this.ar=new Ii(this,"async_queue_retry"),this.Rc=()=>{const t=wi();t&&m("AsyncQueue","Visibility state changed to "+t.visibilityState),this.ar.tr()};const t=wi();t&&"function"==typeof t.addEventListener&&t.addEventListener("visibilitychange",this.Rc)}get isShuttingDown(){return this.gc}enqueueAndForget(t){this.enqueue(t)}enqueueAndForgetEvenWhileRestricted(t){this.bc(),this.Pc(t)}enterRestrictedMode(t){if(!this.gc){this.gc=!0,this.Ic=t||!1;const e=wi();e&&"function"==typeof e.removeEventListener&&e.removeEventListener("visibilitychange",this.Rc)}}enqueue(t){if(this.bc(),this.gc)return new Promise((()=>{}));const e=new S;return this.Pc((()=>this.gc&&this.Ic?Promise.resolve():(t().then(e.resolve,e.reject),e.promise))).then((()=>e.promise))}enqueueRetryable(t){this.enqueueAndForget((()=>(this.mc.push(t),this.vc())))}async vc(){if(0!==this.mc.length){try{await this.mc[0](),this.mc.shift(),this.ar.reset()}catch(t){if(!br(t))throw t;m("AsyncQueue","Operation failed with retryable error: "+t)}this.mc.length>0&&this.ar.Xi((()=>this.vc()))}}Pc(t){const e=this._c.then((()=>(this.Ec=!0,t().catch((t=>{this.Tc=t,this.Ec=!1;throw g("INTERNAL UNHANDLED ERROR: ",function(t){let e=t.message||"";return t.stack&&(e=t.stack.includes(t.message)?t.stack:t.message+"\n"+t.stack),e}(t)),t})).then((t=>(this.Ec=!1,t))))));return this._c=e,e}enqueueAfterDelay(t,e,n){this.bc(),this.Ac.indexOf(t)>-1&&(e=0);const r=to.createAndSchedule(this,t,e,n,(t=>this.Vc(t)));return this.yc.push(r),r}bc(){this.Tc&&w()}verifyOperationInProgress(){}async Sc(){let t;do{t=this._c,await t}while(t!==this._c)}Dc(t){for(const e of this.yc)if(e.timerId===t)return!0;return!1}Cc(t){return this.Sc().then((()=>{this.yc.sort(((t,e)=>t.targetTimeMs-e.targetTimeMs));for(const e of this.yc)if(e.skipDelay(),"all"!==t&&e.timerId===t)break;return this.Sc()}))}Nc(t){this.Ac.push(t)}Vc(t){const e=this.yc.indexOf(t);this.yc.splice(e,1)}}function Ka(t){return function(t,e){if("object"!=typeof t||null===t)return!1;const n=t;for(const r of["next","error","complete"])if(r in n&&"function"==typeof n[r])return!0;return!1}(t)}class ja{constructor(){this._progressObserver={},this._taskCompletionResolver=new S,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(t,e,n){this._progressObserver={next:t,error:e,complete:n}}catch(t){return this._taskCompletionResolver.promise.catch(t)}then(t,e){return this._taskCompletionResolver.promise.then(t,e)}_completeWith(t){this._updateProgress(t),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(t)}_failWith(t){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(t),this._taskCompletionResolver.reject(t)}_updateProgress(t){this._lastProgress=t,this._progressObserver.next&&this._progressObserver.next(t)}}const $a=-1;class za extends Ca{constructor(t,e){super(t,e),this.type="firestore",this._queue=new Ba,this._persistenceKey="name"in t?t.name:"[DEFAULT]"}_terminate(){return this._firestoreClient||Qa(this),this._firestoreClient.terminate()}}function Ga(t){return t._firestoreClient||Qa(t),t._firestoreClient.verifyNotTerminated(),t._firestoreClient}function Qa(t){var e;const n=t._freezeSettings(),r=function(t,e,n,r){return new Ia(t,e,n,r.host,r.ssl,r.experimentalForceLongPolling,r.experimentalAutoDetectLongPolling,r.useFetchStreams)}(t._databaseId,(null===(e=t._app)||void 0===e?void 0:e.options.appId)||"",t._persistenceKey,n);t._firestoreClient=new aa(t._credentials,t._queue,r)}function Ha(t,e){rc(t=Aa(t,za));const n=Ga(t),r=t._freezeSettings(),s=new ea;return Ya(n,s,new Zo(s,r.cacheSizeBytes,null==e?void 0:e.forceOwnership))}function Wa(t){rc(t=Aa(t,za));const e=Ga(t),n=t._freezeSettings(),r=new ea;return Ya(e,r,new ta(r,n.cacheSizeBytes))}function Ya(t,e,n){const r=new S;return t.asyncQueue.enqueue((async()=>{try{await ca(t,n),await ua(t,e),r.resolve()}catch(t){if(!function(t){return"FirebaseError"===t.name?t.code===E.FAILED_PRECONDITION||t.code===E.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&t instanceof DOMException)||(22===t.code||20===t.code||11===t.code)}(t))throw t;console.warn("Error enabling offline persistence. Falling back to persistence disabled: "+t),r.reject(t)}})).then((()=>r.promise))}function Ja(t){if(t._initialized&&!t._terminated)throw new T(E.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");const e=new S;return t._queue.enqueueAndForgetEvenWhileRestricted((async()=>{try{await async function(t){if(!wr.bt())return Promise.resolve();const e=t+"main";await wr.delete(e)}(ks(t._databaseId,t._persistenceKey)),e.resolve()}catch(t){e.reject(t)}})),e.promise}function Xa(t){return function(t){const e=new S;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e){const n=b(t);Fi(n.remoteStore)||m("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{const t=await function(t){const e=b(t);return e.persistence.runTransaction("Get highest unacknowledged batch id","readonly",(t=>e.In.getHighestUnacknowledgedBatchId(t)))}(n.localStore);if(-1===t)return void e.resolve();const r=n.Ko.get(t)||[];r.push(e),n.Ko.set(t,r)}catch(t){const n=eo(t,"Initialization of waitForPendingWrites() operation failed");e.reject(n)}}(await ga(t),e))),e.promise}(Ga(t=Aa(t,za)))}function Za(t){return function(t){return t.asyncQueue.enqueue((async()=>{const e=await da(t),n=await ma(t);return e.setNetworkEnabled(!0),function(t){const e=b(t);return e.Wr.delete(0),Di(e)}(n)}))}(Ga(t=Aa(t,za)))}function tc(t){return function(t){return t.asyncQueue.enqueue((async()=>{const e=await da(t),n=await ma(t);return e.setNetworkEnabled(!1),async function(t){const e=b(t);e.Wr.add(0),await Ai(e),e.Hr.set("Offline")}(n)}))}(Ga(t=Aa(t,za)))}function ec(t,e){const n=Ga(t=Aa(t,za)),r=new ja;return va(n,t._databaseId,e,r),r}function nc(t,e){return function(t,e){return t.asyncQueue.enqueue((async()=>function(t,e){const n=b(t);return n.persistence.runTransaction("Get named query","readonly",(t=>n.Je.getNamedQuery(t,e)))}(await fa(t),e)))}(Ga(t=Aa(t,za)),e).then((e=>e?new Oa(t,null,e.query):null))}function rc(t){if(t._initialized||t._terminated)throw new T(E.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}class sc{constructor(...t){for(let e=0;e<t.length;++e)if(0===t[e].length)throw new T(E.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new z(t)}isEqual(t){return this._internalPath.isEqual(t._internalPath)}}class ic{constructor(t){this._byteString=t}static fromBase64String(t){try{return new ic(H.fromBase64String(t))}catch(t){throw new T(E.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+t)}}static fromUint8Array(t){return new ic(H.fromUint8Array(t))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(t){return this._byteString.isEqual(t._byteString)}}class oc{constructor(t){this._methodName=t}}class ac{constructor(t,e){if(!isFinite(t)||t<-90||t>90)throw new T(E.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+t);if(!isFinite(e)||e<-180||e>180)throw new T(E.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+e);this._lat=t,this._long=e}get latitude(){return this._lat}get longitude(){return this._long}isEqual(t){return this._lat===t._lat&&this._long===t._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(t){return O(this._lat,t._lat)||O(this._long,t._long)}}const cc=/^__.*__$/;class uc{constructor(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}toMutation(t,e){return null!==this.fieldMask?new Le(t,this.data,this.fieldMask,e,this.fieldTransforms):new Ce(t,this.data,e,this.fieldTransforms)}}class hc{constructor(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}toMutation(t,e){return new Le(t,this.data,this.fieldMask,e,this.fieldTransforms)}}function lc(t){switch(t){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw w()}}class dc{constructor(t,e,n,r,s,i){this.settings=t,this.databaseId=e,this.N=n,this.ignoreUndefinedProperties=r,void 0===s&&this.xc(),this.fieldTransforms=s||[],this.fieldMask=i||[]}get path(){return this.settings.path}get kc(){return this.settings.kc}$c(t){return new dc(Object.assign(Object.assign({},this.settings),t),this.databaseId,this.N,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}Oc(t){var e;const n=null===(e=this.path)||void 0===e?void 0:e.child(t),r=this.$c({path:n,Fc:!1});return r.Mc(t),r}Lc(t){var e;const n=null===(e=this.path)||void 0===e?void 0:e.child(t),r=this.$c({path:n,Fc:!1});return r.xc(),r}Bc(t){return this.$c({path:void 0,Fc:!0})}Uc(t){return Lc(t,this.settings.methodName,this.settings.qc||!1,this.path,this.settings.Kc)}contains(t){return void 0!==this.fieldMask.find((e=>t.isPrefixOf(e)))||void 0!==this.fieldTransforms.find((e=>t.isPrefixOf(e.field)))}xc(){if(this.path)for(let t=0;t<this.path.length;t++)this.Mc(this.path.get(t))}Mc(t){if(0===t.length)throw this.Uc("Document fields must not be empty");if(lc(this.kc)&&cc.test(t))throw this.Uc('Document fields cannot begin and end with "__"')}}class fc{constructor(t,e,n){this.databaseId=t,this.ignoreUndefinedProperties=e,this.N=n||vi(t)}jc(t,e,n,r=!1){return new dc({kc:t,methodName:e,Kc:n,path:z.emptyPath(),Fc:!1,qc:r},this.databaseId,this.N,this.ignoreUndefinedProperties)}}function mc(t){const e=t._freezeSettings(),n=vi(t._databaseId);return new fc(t._databaseId,!!e.ignoreUndefinedProperties,n)}function gc(t,e,n,r,s,i={}){const o=t.jc(i.merge||i.mergeFields?2:0,e,n,s);Ac("Data must be an object, but it was:",o,r);const a=_c(r,o);let c,u;if(i.merge)c=new G(o.fieldMask),u=o.fieldTransforms;else if(i.mergeFields){const t=[];for(const r of i.mergeFields){const s=kc(e,r,n);if(!o.contains(s))throw new T(E.INVALID_ARGUMENT,`Field '${s}' is specified in your field mask but missing from your input data.`);Rc(t,s)||t.push(s)}c=new G(t),u=o.fieldTransforms.filter((t=>c.covers(t.field)))}else c=null,u=o.fieldTransforms;return new uc(new It(a),c,u)}class pc extends oc{_toFieldTransform(t){if(2!==t.kc)throw 1===t.kc?t.Uc(`${this._methodName}() can only appear at the top level of your update data`):t.Uc(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return t.fieldMask.push(t.path),null}isEqual(t){return t instanceof pc}}function yc(t,e,n){return new dc({kc:3,Kc:e.settings.Kc,methodName:t._methodName,Fc:n},e.databaseId,e.N,e.ignoreUndefinedProperties)}class wc extends oc{_toFieldTransform(t){return new be(t.path,new fe)}isEqual(t){return t instanceof wc}}class vc extends oc{constructor(t,e){super(t),this.Qc=e}_toFieldTransform(t){const e=yc(this,t,!0),n=this.Qc.map((t=>Nc(t,e))),r=new me(n);return new be(t.path,r)}isEqual(t){return this===t}}class Ic extends oc{constructor(t,e){super(t),this.Qc=e}_toFieldTransform(t){const e=yc(this,t,!0),n=this.Qc.map((t=>Nc(t,e))),r=new pe(n);return new be(t.path,r)}isEqual(t){return this===t}}class bc extends oc{constructor(t,e){super(t),this.Wc=e}_toFieldTransform(t){const e=new we(t.N,ce(t.N,this.Wc));return new be(t.path,e)}isEqual(t){return this===t}}function Ec(t,e,n,r){const s=t.jc(1,e,n);Ac("Data must be an object, but it was:",s,r);const i=[],a=It.empty();q(r,((t,r)=>{const c=Cc(e,t,n);r=Object(o.k)(r);const u=s.Lc(c);if(r instanceof pc)i.push(c);else{const t=Nc(r,u);null!=t&&(i.push(c),a.set(c,t))}}));const c=new G(i);return new hc(a,c,s.fieldTransforms)}function Tc(t,e,n,r,s,i){const a=t.jc(1,e,n),c=[kc(e,r,n)],u=[s];if(i.length%2!=0)throw new T(E.INVALID_ARGUMENT,`Function ${e}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let o=0;o<i.length;o+=2)c.push(kc(e,i[o])),u.push(i[o+1]);const h=[],l=It.empty();for(let f=c.length-1;f>=0;--f)if(!Rc(h,c[f])){const t=c[f];let e=u[f];e=Object(o.k)(e);const n=a.Lc(t);if(e instanceof pc)h.push(t);else{const r=Nc(e,n);null!=r&&(h.push(t),l.set(t,r))}}const d=new G(h);return new hc(l,d,a.fieldTransforms)}function Sc(t,e,n,r=!1){return Nc(n,t.jc(r?4:3,e))}function Nc(t,e){if(Dc(t=Object(o.k)(t)))return Ac("Unsupported field value:",e,t),_c(t,e);if(t instanceof oc)return function(t,e){if(!lc(e.kc))throw e.Uc(`${t._methodName}() can only be used with update() and set()`);if(!e.path)throw e.Uc(`${t._methodName}() is not currently supported inside arrays`);const n=t._toFieldTransform(e);n&&e.fieldTransforms.push(n)}(t,e),null;if(void 0===t&&e.ignoreUndefinedProperties)return null;if(e.path&&e.fieldMask.push(e.path),t instanceof Array){if(e.settings.Fc&&4!==e.kc)throw e.Uc("Nested arrays are not supported");return function(t,e){const n=[];let r=0;for(const s of t){let t=Nc(s,e.Bc(r));null==t&&(t={nullValue:"NULL_VALUE"}),n.push(t),r++}return{arrayValue:{values:n}}}(t,e)}return function(t,e){if(null===(t=Object(o.k)(t)))return{nullValue:"NULL_VALUE"};if("number"==typeof t)return ce(e.N,t);if("boolean"==typeof t)return{booleanValue:t};if("string"==typeof t)return{stringValue:t};if(t instanceof Date){const n=V.fromDate(t);return{timestampValue:yn(e.N,n)}}if(t instanceof V){const n=new V(t.seconds,1e3*Math.floor(t.nanoseconds/1e3));return{timestampValue:yn(e.N,n)}}if(t instanceof ac)return{geoPointValue:{latitude:t.latitude,longitude:t.longitude}};if(t instanceof ic)return{bytesValue:wn(e.N,t._byteString)};if(t instanceof Ra){const n=e.databaseId,r=t.firestore._databaseId;if(!r.isEqual(n))throw e.Uc(`Document reference is for database ${r.projectId}/${r.database} but should be for database ${n.projectId}/${n.database}`);return{referenceValue:bn(t.firestore._databaseId||e.databaseId,t._key.path)}}throw e.Uc(`Unsupported field value: ${Da(t)}`)}(t,e)}function _c(t,e){const n={};return B(t)?e.path&&e.path.length>0&&e.fieldMask.push(e.path):q(t,((t,r)=>{const s=Nc(r,e.Oc(t));null!=s&&(n[t]=s)})),{mapValue:{fields:n}}}function Dc(t){return!("object"!=typeof t||null===t||t instanceof Array||t instanceof Date||t instanceof V||t instanceof ac||t instanceof ic||t instanceof Ra||t instanceof oc)}function Ac(t,e,n){if(!Dc(n)||!function(t){return"object"==typeof t&&null!==t&&(Object.getPrototypeOf(t)===Object.prototype||null===Object.getPrototypeOf(t))}(n)){const r=Da(n);throw"an object"===r?e.Uc(t+" a custom object"):e.Uc(t+" "+r)}}function kc(t,e,n){if((e=Object(o.k)(e))instanceof sc)return e._internalPath;if("string"==typeof e)return Cc(t,e);throw Lc("Field path arguments must be of type string or FieldPath.",t,!1,void 0,n)}const xc=new RegExp("[~\\*/\\[\\]]");function Cc(t,e,n){if(e.search(xc)>=0)throw Lc(`Invalid field path (${e}). Paths must not contain '~', '*', '/', '[', or ']'`,t,!1,void 0,n);try{return new sc(...e.split("."))._internalPath}catch(r){throw Lc(`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,t,!1,void 0,n)}}function Lc(t,e,n,r,s){const i=r&&!r.isEmpty(),o=void 0!==s;let a=`Function ${e}() called with invalid data`;n&&(a+=" (via `toFirestore()`)"),a+=". ";let c="";return(i||o)&&(c+=" (found",i&&(c+=` in field ${r}`),o&&(c+=` in document ${s}`),c+=")"),new T(E.INVALID_ARGUMENT,a+t+c)}function Rc(t,e){return t.some((t=>t.isEqual(e)))}class Oc{constructor(t,e,n,r,s){this._firestore=t,this._userDataWriter=e,this._key=n,this._document=r,this._converter=s}get id(){return this._key.path.lastSegment()}get ref(){return new Ra(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){const t=new Fc(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(t)}return this._userDataWriter.convertValue(this._document.data.value)}}get(t){if(this._document){const e=this._document.data.field(Mc("DocumentSnapshot.get",t));if(null!==e)return this._userDataWriter.convertValue(e)}}}class Fc extends Oc{data(){return super.data()}}function Mc(t,e){return"string"==typeof e?Cc(t,e):e instanceof sc?e._internalPath:e._delegate._internalPath}class Vc{constructor(t,e){this.hasPendingWrites=t,this.fromCache=e}isEqual(t){return this.hasPendingWrites===t.hasPendingWrites&&this.fromCache===t.fromCache}}class Pc extends Oc{constructor(t,e,n,r,s,i){super(t,e,n,r,i),this._firestore=t,this._firestoreImpl=t,this.metadata=s}exists(){return super.exists()}data(t={}){if(this._document){if(this._converter){const e=new Uc(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(e,t)}return this._userDataWriter.convertValue(this._document.data.value,t.serverTimestamps)}}get(t,e={}){if(this._document){const n=this._document.data.field(Mc("DocumentSnapshot.get",t));if(null!==n)return this._userDataWriter.convertValue(n,e.serverTimestamps)}}}class Uc extends Pc{data(t={}){return super.data(t)}}class qc{constructor(t,e,n,r){this._firestore=t,this._userDataWriter=e,this._snapshot=r,this.metadata=new Vc(r.hasPendingWrites,r.fromCache),this.query=n}get docs(){const t=[];return this.forEach((e=>t.push(e))),t}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(t,e){this._snapshot.docs.forEach((n=>{t.call(e,new Uc(this._firestore,this._userDataWriter,n.key,n,new Vc(this._snapshot.mutatedKeys.has(n.key),this._snapshot.fromCache),this.query.converter))}))}docChanges(t={}){const e=!!t.includeMetadataChanges;if(e&&this._snapshot.excludesMetadataChanges)throw new T(E.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===e||(this._cachedChanges=function(t,e){if(t._snapshot.oldDocs.isEmpty()){let e=0;return t._snapshot.docChanges.map((n=>({type:"added",doc:new Uc(t._firestore,t._userDataWriter,n.doc.key,n.doc,new Vc(t._snapshot.mutatedKeys.has(n.doc.key),t._snapshot.fromCache),t.query.converter),oldIndex:-1,newIndex:e++})))}{let n=t._snapshot.oldDocs;return t._snapshot.docChanges.filter((t=>e||3!==t.type)).map((e=>{const r=new Uc(t._firestore,t._userDataWriter,e.doc.key,e.doc,new Vc(t._snapshot.mutatedKeys.has(e.doc.key),t._snapshot.fromCache),t.query.converter);let s=-1,i=-1;return 0!==e.type&&(s=n.indexOf(e.doc.key),n=n.delete(e.doc.key)),1!==e.type&&(n=n.add(e.doc),i=n.indexOf(e.doc.key)),{type:Bc(e.type),doc:r,oldIndex:s,newIndex:i}}))}}(this,e),this._cachedChangesIncludeMetadataChanges=e),this._cachedChanges}}function Bc(t){switch(t){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return w()}}function Kc(t,e){return t instanceof Pc&&e instanceof Pc?t._firestore===e._firestore&&t._key.isEqual(e._key)&&(null===t._document?null===e._document:t._document.isEqual(e._document))&&t._converter===e._converter:t instanceof qc&&e instanceof qc&&t._firestore===e._firestore&&qa(t.query,e.query)&&t.metadata.isEqual(e.metadata)&&t._snapshot.isEqual(e._snapshot)}function jc(t){if(Qt(t)&&0===t.explicitOrderBy.length)throw new T(E.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class $c{}function zc(t,...e){for(const n of e)t=n._apply(t);return t}class Gc extends $c{constructor(t,e,n){super(),this.Gc=t,this.zc=e,this.Hc=n,this.type="where"}_apply(t){const e=mc(t.firestore),n=function(t,e,n,r,s,i,o){let a;if(s.isKeyField()){if("array-contains"===i||"array-contains-any"===i)throw new T(E.INVALID_ARGUMENT,`Invalid Query. You can't perform '${i}' queries on FieldPath.documentId().`);if("in"===i||"not-in"===i){au(o,i);const e=[];for(const n of o)e.push(ou(r,t,n));a={arrayValue:{values:e}}}else a=ou(r,t,o)}else"in"!==i&&"not-in"!==i&&"array-contains-any"!==i||au(o,i),a=Sc(n,"where",o,"in"===i||"not-in"===i);const c=At.create(s,i,a);return function(t,e){if(e.v()){const n=Wt(t);if(null!==n&&!n.isEqual(e.field))throw new T(E.INVALID_ARGUMENT,`Invalid query. All where filters with an inequality (<, <=, !=, not-in, >, or >=) must be on the same field. But you have inequality filters on '${n.toString()}' and '${e.field.toString()}'`);const r=Ht(t);null!==r&&cu(t,e.field,r)}const n=function(t,e){for(const n of t.filters)if(e.indexOf(n.op)>=0)return n.op;return null}(t,function(t){switch(t){case"!=":return["!=","not-in"];case"array-contains":return["array-contains","array-contains-any","not-in"];case"in":return["array-contains-any","in","not-in"];case"array-contains-any":return["array-contains","array-contains-any","in","not-in"];case"not-in":return["array-contains","array-contains-any","in","not-in","!="];default:return[]}}(e.op));if(null!==n)throw n===e.op?new T(E.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${e.op.toString()}' filter.`):new T(E.INVALID_ARGUMENT,`Invalid query. You cannot use '${e.op.toString()}' filters with '${n.toString()}' filters.`)}(t,c),c}(t._query,0,e,t.firestore._databaseId,this.Gc,this.zc,this.Hc);return new Oa(t.firestore,t.converter,function(t,e){const n=t.filters.concat([e]);return new jt(t.path,t.collectionGroup,t.explicitOrderBy.slice(),n,t.limit,t.limitType,t.startAt,t.endAt)}(t._query,n))}}function Qc(t,e,n){const r=e,s=Mc("where",t);return new Gc(s,r,n)}class Hc extends $c{constructor(t,e){super(),this.Gc=t,this.Jc=e,this.type="orderBy"}_apply(t){const e=function(t,e,n){if(null!==t.startAt)throw new T(E.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==t.endAt)throw new T(E.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");const r=new Ut(e,n);return function(t,e){if(null===Ht(t)){const n=Wt(t);null!==n&&cu(t,n,e.field)}}(t,r),r}(t._query,this.Gc,this.Jc);return new Oa(t.firestore,t.converter,function(t,e){const n=t.explicitOrderBy.concat([e]);return new jt(t.path,t.collectionGroup,n,t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt)}(t._query,e))}}function Wc(t,e="asc"){const n=e,r=Mc("orderBy",t);return new Hc(r,n)}class Yc extends $c{constructor(t,e,n){super(),this.type=t,this.Yc=e,this.Xc=n}_apply(t){return new Oa(t.firestore,t.converter,Zt(t._query,this.Yc,this.Xc))}}function Jc(t){return ka("limit",t),new Yc("limit",t,"F")}function Xc(t){return ka("limitToLast",t),new Yc("limitToLast",t,"L")}class Zc extends $c{constructor(t,e,n){super(),this.type=t,this.Zc=e,this.ta=n}_apply(t){const e=iu(t,this.type,this.Zc,this.ta);return new Oa(t.firestore,t.converter,function(t,e){return new jt(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,e,t.endAt)}(t._query,e))}}function tu(...t){return new Zc("startAt",t,!0)}function eu(...t){return new Zc("startAfter",t,!1)}class nu extends $c{constructor(t,e,n){super(),this.type=t,this.Zc=e,this.ta=n}_apply(t){const e=iu(t,this.type,this.Zc,this.ta);return new Oa(t.firestore,t.converter,function(t,e){return new jt(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,e)}(t._query,e))}}function ru(...t){return new nu("endBefore",t,!0)}function su(...t){return new nu("endAt",t,!1)}function iu(t,e,n,r){if(n[0]=Object(o.k)(n[0]),n[0]instanceof Oc)return function(t,e,n,r,s){if(!r)throw new T(E.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${n}().`);const i=[];for(const o of Jt(t))if(o.field.isKeyField())i.push(ft(e,r.key));else{const t=r.data.field(o.field);if(Z(t))throw new T(E.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+o.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===t){const t=o.field.canonicalString();throw new T(E.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${t}' (used as the orderBy) does not exist.`)}i.push(t)}return new Vt(i,s)}(t._query,t.firestore._databaseId,e,n[0]._document,r);{const s=mc(t.firestore);return function(t,e,n,r,s,i){const o=t.explicitOrderBy;if(s.length>o.length)throw new T(E.INVALID_ARGUMENT,`Too many arguments provided to ${r}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);const a=[];for(let c=0;c<s.length;c++){const i=s[c];if(o[c].field.isKeyField()){if("string"!=typeof i)throw new T(E.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${r}(), but got a ${typeof i}`);if(!Yt(t)&&-1!==i.indexOf("/"))throw new T(E.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by FieldPath.documentId(), the value passed to ${r}() must be a plain document ID, but '${i}' contains a slash.`);const n=t.path.child(j.fromString(i));if(!it.isDocumentKey(n))throw new T(E.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by FieldPath.documentId(), the value passed to ${r}() must result in a valid document path, but '${n}' is not because it contains an odd number of segments.`);const s=new it(n);a.push(ft(e,s))}else{const t=Sc(n,r,i);a.push(t)}}return new Vt(a,i)}(t._query,t.firestore._databaseId,s,e,n,r)}}function ou(t,e,n){if("string"==typeof(n=Object(o.k)(n))){if(""===n)throw new T(E.INVALID_ARGUMENT,"Invalid query. When querying with FieldPath.documentId(), you must provide a valid document ID, but it was an empty string.");if(!Yt(e)&&-1!==n.indexOf("/"))throw new T(E.INVALID_ARGUMENT,`Invalid query. When querying a collection by FieldPath.documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);const r=e.path.child(j.fromString(n));if(!it.isDocumentKey(r))throw new T(E.INVALID_ARGUMENT,`Invalid query. When querying a collection group by FieldPath.documentId(), the value provided must result in a valid document path, but '${r}' is not because it has an odd number of segments (${r.length}).`);return ft(t,new it(r))}if(n instanceof Ra)return ft(t,n._key);throw new T(E.INVALID_ARGUMENT,`Invalid query. When querying with FieldPath.documentId(), you must provide a valid string or a DocumentReference, but it was: ${Da(n)}.`)}function au(t,e){if(!Array.isArray(t)||0===t.length)throw new T(E.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${e.toString()}' filters.`);if(t.length>10)throw new T(E.INVALID_ARGUMENT,`Invalid Query. '${e.toString()}' filters support a maximum of 10 elements in the value array.`)}function cu(t,e,n){if(!n.isEqual(e))throw new T(E.INVALID_ARGUMENT,`Invalid query. You have a where filter with an inequality (<, <=, !=, not-in, >, or >=) on field '${e.toString()}' and so you must also use '${e.toString()}' as your first argument to orderBy(), but your first orderBy() is on field '${n.toString()}' instead.`)}class uu{convertValue(t,e="none"){switch(ot(t)){case 0:return null;case 1:return t.booleanValue;case 2:return J(t.integerValue||t.doubleValue);case 3:return this.convertTimestamp(t.timestampValue);case 4:return this.convertServerTimestamp(t,e);case 5:return t.stringValue;case 6:return this.convertBytes(X(t.bytesValue));case 7:return this.convertReference(t.referenceValue);case 8:return this.convertGeoPoint(t.geoPointValue);case 9:return this.convertArray(t.arrayValue,e);case 10:return this.convertObject(t.mapValue,e);default:throw w()}}convertObject(t,e){const n={};return q(t.fields,((t,r)=>{n[t]=this.convertValue(r,e)})),n}convertGeoPoint(t){return new ac(J(t.latitude),J(t.longitude))}convertArray(t,e){return(t.values||[]).map((t=>this.convertValue(t,e)))}convertServerTimestamp(t,e){switch(e){case"previous":const n=tt(t);return null==n?null:this.convertValue(n,e);case"estimate":return this.convertTimestamp(et(t));default:return null}}convertTimestamp(t){const e=Y(t);return new V(e.seconds,e.nanos)}convertDocumentKey(t,e){const n=j.fromString(t);v(Gn(n));const r=new ba(n.get(1),n.get(3)),s=new it(n.popFirst(5));return r.isEqual(e)||g(`Document ${s} contains a document reference within a different database (${r.projectId}/${r.database}) which is not supported. It will be treated as a reference in the current database (${e.projectId}/${e.database}) instead.`),s}}function hu(t,e,n){let r;return r=t?n&&(n.merge||n.mergeFields)?t.toFirestore(e,n):t.toFirestore(e):e,r}class lu extends uu{constructor(t){super(),this.firestore=t}convertBytes(t){return new ic(t)}convertReference(t){const e=this.convertDocumentKey(t,this.firestore._databaseId);return new Ra(this.firestore,null,e)}}class du{constructor(t,e){this._firestore=t,this._commitHandler=e,this._mutations=[],this._committed=!1,this._dataReader=mc(t)}set(t,e,n){this._verifyNotCommitted();const r=fu(t,this._firestore),s=hu(r.converter,e,n),i=gc(this._dataReader,"WriteBatch.set",r._key,s,null!==r.converter,n);return this._mutations.push(i.toMutation(r._key,Te.none())),this}update(t,e,n,...r){this._verifyNotCommitted();const s=fu(t,this._firestore);let i;return i="string"==typeof(e=Object(o.k)(e))||e instanceof sc?Tc(this._dataReader,"WriteBatch.update",s._key,e,n,r):Ec(this._dataReader,"WriteBatch.update",s._key,e),this._mutations.push(i.toMutation(s._key,Te.exists(!0))),this}delete(t){this._verifyNotCommitted();const e=fu(t,this._firestore);return this._mutations=this._mutations.concat(new Me(e._key,Te.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,this._mutations.length>0?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new T(E.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function fu(t,e){if((t=Object(o.k)(t)).firestore!==e)throw new T(E.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return t}function mu(t){t=Aa(t,Ra);const e=Aa(t.firestore,za);return ya(Ga(e),t._key).then((n=>Au(e,t,n)))}class gu extends uu{constructor(t){super(),this.firestore=t}convertBytes(t){return new ic(t)}convertReference(t){const e=this.convertDocumentKey(t,this.firestore._databaseId);return new Ra(this.firestore,null,e)}}function pu(t){t=Aa(t,Ra);const e=Aa(t.firestore,za),n=Ga(e),r=new gu(e);return function(t,e){const n=new S;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e,n){try{const r=await function(t,e){const n=b(t);return n.persistence.runTransaction("read document","readonly",(t=>n.Qn.An(t,e)))}(t,e);r.isFoundDocument()?n.resolve(r):r.isNoDocument()?n.resolve(null):n.reject(new T(E.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(t){const r=eo(t,`Failed to get document '${e} from cache`);n.reject(r)}}(await fa(t),e,n))),n.promise}(n,t._key).then((n=>new Pc(e,r,t._key,n,new Vc(null!==n&&n.hasLocalMutations,!0),t.converter)))}function yu(t){t=Aa(t,Ra);const e=Aa(t.firestore,za);return ya(Ga(e),t._key,{source:"server"}).then((n=>Au(e,t,n)))}function wu(t){t=Aa(t,Oa);const e=Aa(t.firestore,za),n=Ga(e),r=new gu(e);return jc(t._query),wa(n,t._query).then((n=>new qc(e,r,t,n)))}function vu(t){t=Aa(t,Oa);const e=Aa(t.firestore,za),n=Ga(e),r=new gu(e);return function(t,e){const n=new S;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e,n){try{const r=await Ks(t,e,!0),s=new Io(e,r.Gn),i=s.bo(r.documents),o=s.applyChanges(i,!1);n.resolve(o.snapshot)}catch(t){const r=eo(t,`Failed to execute query '${e} against cache`);n.reject(r)}}(await fa(t),e,n))),n.promise}(n,t._query).then((n=>new qc(e,r,t,n)))}function Iu(t){t=Aa(t,Oa);const e=Aa(t.firestore,za),n=Ga(e),r=new gu(e);return wa(n,t._query,{source:"server"}).then((n=>new qc(e,r,t,n)))}function bu(t,e,n){t=Aa(t,Ra);const r=Aa(t.firestore,za),s=hu(t.converter,e,n);return Du(r,[gc(mc(r),"setDoc",t._key,s,null!==t.converter,n).toMutation(t._key,Te.none())])}function Eu(t,e,n,...r){t=Aa(t,Ra);const s=Aa(t.firestore,za),i=mc(s);let a;return a="string"==typeof(e=Object(o.k)(e))||e instanceof sc?Tc(i,"updateDoc",t._key,e,n,r):Ec(i,"updateDoc",t._key,e),Du(s,[a.toMutation(t._key,Te.exists(!0))])}function Tu(t){return Du(Aa(t.firestore,za),[new Me(t._key,Te.none())])}function Su(t,e){const n=Aa(t.firestore,za),r=Pa(t),s=hu(t.converter,e);return Du(n,[gc(mc(t.firestore),"addDoc",r._key,s,null!==t.converter,{}).toMutation(r._key,Te.exists(!1))]).then((()=>r))}function Nu(t,...e){var n,r,s;t=Object(o.k)(t);let i={includeMetadataChanges:!1},a=0;"object"!=typeof e[a]||Ka(e[a])||(i=e[a],a++);const c={includeMetadataChanges:i.includeMetadataChanges};if(Ka(e[a])){const t=e[a];e[a]=null===(n=t.next)||void 0===n?void 0:n.bind(t),e[a+1]=null===(r=t.error)||void 0===r?void 0:r.bind(t),e[a+2]=null===(s=t.complete)||void 0===s?void 0:s.bind(t)}let u,h,l;if(t instanceof Ra)h=Aa(t.firestore,za),l=zt(t._key.path),u={next:n=>{e[a]&&e[a](Au(h,t,n))},error:e[a+1],complete:e[a+2]};else{const n=Aa(t,Oa);h=Aa(n.firestore,za),l=n._query;const r=new gu(h);u={next:t=>{e[a]&&e[a](new qc(h,r,n,t))},error:e[a+1],complete:e[a+2]},jc(t._query)}return function(t,e,n,r){const s=new ra(r),i=new fo(e,s,n);return t.asyncQueue.enqueueAndForget((async()=>ao(await pa(t),i))),()=>{s.ec(),t.asyncQueue.enqueueAndForget((async()=>co(await pa(t),i)))}}(Ga(h),l,c,u)}function _u(t,e){return function(t,e){const n=new ra(e);return t.asyncQueue.enqueueAndForget((async()=>function(t,e){b(t).so.add(e),e.next()}(await pa(t),n))),()=>{n.ec(),t.asyncQueue.enqueueAndForget((async()=>function(t,e){b(t).so.delete(e)}(await pa(t),n)))}}(Ga(t=Aa(t,za)),Ka(e)?e:{next:e})}function Du(t,e){return function(t,e){const n=new S;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e,n){const r=Jo(t);try{const t=await function(t,e){const n=b(t),r=V.now(),s=e.reduce(((t,e)=>t.add(e.key)),en());let i;return n.persistence.runTransaction("Locally write mutations","readwrite",(t=>n.Qn.Pn(t,s).next((s=>{i=s;const o=[];for(const t of e){const e=Ae(t,i.get(t.key));null!=e&&o.push(new Le(t.key,e,bt(e.value.mapValue),Te.exists(!0)))}return n.In.addMutationBatch(t,r,o,e)})))).then((t=>(t.applyToLocalDocumentSet(i),{batchId:t.batchId,changes:i})))}(r.localStore,e);r.sharedClientState.addPendingMutation(t.batchId),function(t,e,n){let r=t.qo[t.currentUser.toKey()];r||(r=new je(O)),r=r.insert(e,n),t.qo[t.currentUser.toKey()]=r}(r,t.batchId,n),await Uo(r,t.changes),await Ki(r.remoteStore)}catch(t){const e=eo(t,"Failed to persist write");n.reject(e)}}(await ga(t),e,n))),n.promise}(Ga(t),e)}function Au(t,e,n){const r=n.docs.get(e._key),s=new gu(t);return new Pc(t,s,e._key,r,new Vc(n.hasPendingWrites,n.fromCache),e.converter)}class ku extends class{constructor(t,e){this._firestore=t,this._transaction=e,this._dataReader=mc(t)}get(t){const e=fu(t,this._firestore),n=new lu(this._firestore);return this._transaction.lookup([e._key]).then((t=>{if(!t||1!==t.length)return w();const r=t[0];if(r.isFoundDocument())return new Oc(this._firestore,n,r.key,r,e.converter);if(r.isNoDocument())return new Oc(this._firestore,n,e._key,null,e.converter);throw w()}))}set(t,e,n){const r=fu(t,this._firestore),s=hu(r.converter,e,n),i=gc(this._dataReader,"Transaction.set",r._key,s,null!==r.converter,n);return this._transaction.set(r._key,i),this}update(t,e,n,...r){const s=fu(t,this._firestore);let i;return i="string"==typeof(e=Object(o.k)(e))||e instanceof sc?Tc(this._dataReader,"Transaction.update",s._key,e,n,r):Ec(this._dataReader,"Transaction.update",s._key,e),this._transaction.update(s._key,i),this}delete(t){const e=fu(t,this._firestore);return this._transaction.delete(e._key),this}}{constructor(t,e){super(t,e),this._firestore=t}get(t){const e=fu(t,this._firestore),n=new gu(this._firestore);return super.get(t).then((t=>new Pc(this._firestore,n,e._key,t._document,new Vc(!1,!1),e.converter)))}}function xu(t,e){return function(t,e){const n=new S;return t.asyncQueue.enqueueAndForget((async()=>{const r=await function(t){return la(t).then((t=>t.datastore))}(t);new oa(t.asyncQueue,r,e,n).run()})),n.promise}(Ga(t=Aa(t,za)),(n=>e(new ku(t,n))))}function Cu(){return new pc("deleteField")}function Lu(){return new wc("serverTimestamp")}function Ru(...t){return new vc("arrayUnion",t)}function Ou(...t){return new Ic("arrayRemove",t)}function Fu(t){return new bc("increment",t)}!function(t,e=!0){!function(t){h=t}(r.SDK_VERSION),Object(r._registerComponent)(new s.a("firestore",((t,{options:n})=>{const r=t.getProvider("app").getImmediate(),s=new za(r,new A(t.getProvider("auth-internal")));return n=Object.assign({useFetchStreams:e},n),s._setSettings(n),s}),"PUBLIC")),Object(r.registerVersion)(c,"3.3.0",t),Object(r.registerVersion)(c,"3.3.0","esm2017")}()}).call(this,n("8oxB"))}}]);